(window.webpackJsonp=window.webpackJsonp||[]).push([[490],{3463:function(a,r,t){a.exports=t.p+"assets/img/sharding-x-trans-saga-2.0b441432.png"},4228:function(a,r,t){"use strict";t.r(r);var s=t(7),e=Object(s.a)({},(function(){var a=this,r=a._self._c;return r("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[r("h1",{attrs:{id:"shardingsphere详解-事务实现原理之柔性事务saga"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#shardingsphere详解-事务实现原理之柔性事务saga"}},[a._v("#")]),a._v(" ShardingSphere详解 - 事务实现原理之柔性事务SAGA")]),a._v(" "),r("p",[a._v("=========================================================================")]),a._v(" "),r("blockquote",[r("p",[a._v("Apache ShardingSphere 在v5.0版本前还支持柔性事务SAGA，目前看5.x+版本中已经移除了向观众章节，本文主要介绍其实现原理; 这篇文章主要转载自"),r("a",{attrs:{href:"https://shardingsphere.apache.org/document/legacy/4.x/document/cn/features/transaction/concept/base-transaction-saga/",target:"_blank",rel:"noopener noreferrer"}},[a._v("ShardingSphere官方 在新窗口打开"),r("OutboundLink")],1),a._v("网站（V4.x版本）。@pdai")])]),a._v(" "),r("ul",[r("li",[r("a",{attrs:{href:"#shardingsphere%E8%AF%A6%E8%A7%A3---%E4%BA%8B%E5%8A%A1%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E4%B9%8B%E6%9F%94%E6%80%A7%E4%BA%8B%E5%8A%A1saga"}},[a._v("ShardingSphere详解 - 事务实现原理之柔性事务SAGA")]),a._v(" "),r("ul",[r("li",[r("a",{attrs:{href:"#saga%E4%BA%8B%E5%8A%A1"}},[a._v("Saga事务")])]),a._v(" "),r("li",[r("a",{attrs:{href:"#%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"}},[a._v("实现原理")]),a._v(" "),r("ul",[r("li",[r("a",{attrs:{href:"#initsaga%E5%BC%95%E6%93%8E%E5%88%9D%E5%A7%8B%E5%8C%96"}},[a._v("Init（Saga引擎初始化）")])]),a._v(" "),r("li",[r("a",{attrs:{href:"#begin%E5%BC%80%E5%90%AFsaga%E5%85%A8%E5%B1%80%E4%BA%8B%E5%8A%A1"}},[a._v("Begin（开启Saga全局事务）")])]),a._v(" "),r("li",[r("a",{attrs:{href:"#%E6%89%A7%E8%A1%8C%E7%89%A9%E7%90%86sql"}},[a._v("执行物理SQL")])]),a._v(" "),r("li",[r("a",{attrs:{href:"#commitrollback%E6%8F%90%E4%BA%A4saga%E4%BA%8B%E5%8A%A1"}},[a._v("Commit/rollback（提交Saga事务）")])])])])])])]),a._v(" "),r("h1",{attrs:{id:"saga事务"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#saga事务"}},[a._v("#")]),a._v(" Saga事务")]),a._v(" "),r("hr"),a._v(" "),r("p",[a._v("Saga这个概念来源于三十多年前的一篇数据库论文Sagas ，一个Saga事务是一个有多个短时事务组成的长时的事务。 在分布式事务场景下，我们把一个Saga分布式事务看做是一个由多个本地事务组成的事务，每个本地事务都有一个与之对应的补偿事务。在Saga事务的执行过程中，如果某一步执行出现异常，Saga事务会被终止，同时会调用对应的补偿事务完成相关的恢复操作，这样保证Saga相关的本地事务要么都是执行成功，要么通过补偿恢复成为事务执行之前的状态。")]),a._v(" "),r("p",[r("strong",[a._v("自动反向补偿")])]),a._v(" "),r("p",[a._v("Saga定义了一个事务中的每个子事务都有一个与之对应的反向补偿操作。由Saga事务管理器根据程序执行结果生成一张有向无环图，并在需要执行回滚操作时，根据该图依次按照相反的顺序调用反向补偿操作。Saga事务管理器只用于控制何时重试，何时补偿，并不负责补偿的内容，补偿的具体操作需要由开发者自行提供。")]),a._v(" "),r("p",[a._v("ShardingSphere采用反向SQL技术，将对数据库进行更新操作的SQL自动生成反向SQL，并交由saga-actuator执行，使用方则无需再关注如何实现补偿方法，将柔性事务管理器的应用范畴成功的定位回了事务的本源——数据库层面。")]),a._v(" "),r("h1",{attrs:{id:"实现原理"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#实现原理"}},[a._v("#")]),a._v(" 实现原理")]),a._v(" "),r("hr"),a._v(" "),r("blockquote",[r("p",[a._v("Saga柔性事务的实现类为SagaShardingTransactionMananger, ShardingSphere通过Hook的方式拦截逻辑SQL的解析和路由结果，这样，在分片物理SQL执行前，可以生成逆向SQL，在事务提交阶段再把SQL调用链交给Saga引擎处理。")])]),a._v(" "),r("p",[r("img",{attrs:{src:t(3463),alt:""}})]),a._v(" "),r("h3",{attrs:{id:"init-saga引擎初始化"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#init-saga引擎初始化"}},[a._v("#")]),a._v(" Init（Saga引擎初始化）")]),a._v(" "),r("p",[a._v("包含Saga柔性事务的应用启动时，saga-actuator引擎会根据saga.properties的配置进行初始化的流程。")]),a._v(" "),r("h3",{attrs:{id:"begin-开启saga全局事务"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#begin-开启saga全局事务"}},[a._v("#")]),a._v(" Begin（开启Saga全局事务）")]),a._v(" "),r("p",[a._v("每次开启Saga全局事务时，将会生成本次全局事务的上下文（SagaTransactionContext），事务上下文记录了所有子事务的正向SQL和逆向SQL，作为生成事务调用链的元数据使用。")]),a._v(" "),r("h3",{attrs:{id:"执行物理sql"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#执行物理sql"}},[a._v("#")]),a._v(" 执行物理SQL")]),a._v(" "),r("p",[a._v("在物理SQL执行前，ShardingSphere根据SQL的类型生成逆向SQL，这里是通过Hook的方式拦截Parser的解析结果进行实现。")]),a._v(" "),r("h3",{attrs:{id:"commit-rollback-提交saga事务"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#commit-rollback-提交saga事务"}},[a._v("#")]),a._v(" Commit/rollback（提交Saga事务）")]),a._v(" "),r("p",[a._v("提交阶段会生成Saga执行引擎所需的调用链路图，commit操作产生ForwardRecovery（正向SQL补偿）任务，rollback操作产生BackwardRecovery任务（逆向SQL补偿）。)")])])}),[],!1,null,null,null);r.default=e.exports}}]);