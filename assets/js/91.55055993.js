(window.webpackJsonp=window.webpackJsonp||[]).push([[91],{2514:function(s,n,a){s.exports=a.p+"assets/img/es-dsl-com-2.db1df170.png"},2515:function(s,n,a){s.exports=a.p+"assets/img/es-dsl-com-3.1d97c8ec.png"},2516:function(s,n,a){s.exports=a.p+"assets/img/es-dsl-dismax-2.29f5aadc.png"},2517:function(s,n,a){s.exports=a.p+"assets/img/es-dsl-dismax-4.92ea80ab.png"},2518:function(s,n,a){s.exports=a.p+"assets/img/es-dsl-dismax-5.a85baace.png"},2519:function(s,n,a){s.exports=a.p+"assets/img/es-dsl-dismax-6.2ba20cb3.png"},2520:function(s,n,a){s.exports=a.p+"assets/img/es-dsl-dismax-7.4c2b7d17.png"},2521:function(s,n,a){s.exports=a.p+"assets/img/es-dsl-dismax-8.3349d199.png"},2522:function(s,n,a){s.exports=a.p+"assets/img/es-dsl-dismax-9.46ec401f.png"},2523:function(s,n,a){s.exports=a.p+"assets/img/es-dsl-dismax-3.82203298.png"},2524:function(s,n,a){s.exports=a.p+"assets/img/es-dsl-dismax-10.923ba0e6.png"},3941:function(s,n,a){"use strict";a.r(n);var t=a(7),e=Object(t.a)({},(function(){var s=this,n=s._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"es详解-查询-dsl查询之复合查询详解"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#es详解-查询-dsl查询之复合查询详解"}},[s._v("#")]),s._v(" ES详解 - 查询：DSL查询之复合查询详解")]),s._v(" "),n("p",[s._v("=================================================")]),s._v(" "),n("blockquote",[n("p",[s._v("在查询中会有多种条件组合的查询，在ElasticSearch中叫复合查询。它提供了5种复合查询方式："),n("strong",[s._v("bool query(布尔查询)")]),s._v("、"),n("strong",[s._v("boosting query(提高查询)")]),s._v("、"),n("strong",[s._v("constant_score（固定分数查询）")]),s._v("、"),n("strong",[s._v("dis_max(最佳匹配查询）")]),s._v("、"),n("strong",[s._v("function_score(函数查询）")]),s._v("。@pdai")])]),s._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"#es%E8%AF%A6%E8%A7%A3---%E6%9F%A5%E8%AF%A2dsl%E6%9F%A5%E8%AF%A2%E4%B9%8B%E5%A4%8D%E5%90%88%E6%9F%A5%E8%AF%A2%E8%AF%A6%E8%A7%A3"}},[s._v("ES详解 - 查询：DSL查询之复合查询详解")]),s._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"#%E5%A4%8D%E5%90%88%E6%9F%A5%E8%AF%A2%E5%BC%95%E5%85%A5"}},[s._v("复合查询引入")])]),s._v(" "),n("li",[n("a",{attrs:{href:"#bool-query%E5%B8%83%E5%B0%94%E6%9F%A5%E8%AF%A2"}},[s._v("bool query(布尔查询)")]),s._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"#%E6%A6%82%E5%BF%B5"}},[s._v("概念")])]),s._v(" "),n("li",[n("a",{attrs:{href:"#%E4%B8%80%E4%BA%9B%E4%BE%8B%E5%AD%90"}},[s._v("一些例子")])])])]),s._v(" "),n("li",[n("a",{attrs:{href:"#boosting-query%E6%8F%90%E9%AB%98%E6%9F%A5%E8%AF%A2"}},[s._v("boosting query(提高查询)")]),s._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"#%E6%A6%82%E5%BF%B5-1"}},[s._v("概念")])]),s._v(" "),n("li",[n("a",{attrs:{href:"#%E4%BE%8B%E5%AD%90"}},[s._v("例子")])])])]),s._v(" "),n("li",[n("a",{attrs:{href:"#constant_score%E5%9B%BA%E5%AE%9A%E5%88%86%E6%95%B0%E6%9F%A5%E8%AF%A2"}},[s._v("constant_score（固定分数查询）")]),s._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"#%E4%BE%8B%E5%AD%90-1"}},[s._v("例子")])])])]),s._v(" "),n("li",[n("a",{attrs:{href:"#dis_max%E6%9C%80%E4%BD%B3%E5%8C%B9%E9%85%8D%E6%9F%A5%E8%AF%A2"}},[s._v("dis_max(最佳匹配查询）")]),s._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"#%E4%BE%8B%E5%AD%90-2"}},[s._v("例子")])])])]),s._v(" "),n("li",[n("a",{attrs:{href:"#function_score%E5%87%BD%E6%95%B0%E6%9F%A5%E8%AF%A2"}},[s._v("function_score(函数查询）")]),s._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"#%E4%BE%8B%E5%AD%90-3"}},[s._v("例子")])])])]),s._v(" "),n("li",[n("a",{attrs:{href:"#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"}},[s._v("参考文章")])])])])]),s._v(" "),n("h1",{attrs:{id:"复合查询引入"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#复合查询引入"}},[s._v("#")]),s._v(" 复合查询引入")]),s._v(" "),n("hr"),s._v(" "),n("p",[s._v("在"),n("a",{attrs:{href:"https://pdai.tech/md/db/nosql-es/elasticsearch-x-usage.html#%E5%A4%9A%E6%9D%A1%E4%BB%B6%E6%9F%A5%E8%AF%A2-bool",target:"_blank",rel:"noopener noreferrer"}},[s._v("前文"),n("OutboundLink")],1),s._v("中，我们使用"),n("code",[s._v("bool")]),s._v("查询来组合多个查询条件。")]),s._v(" "),n("p",[s._v("比如之前介绍的语句")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('GET /bank/_search\n{\n  "query": {\n    "bool": {\n      "must": [\n        { "match": { "age": "40" } }\n      ],\n      "must_not": [\n        { "match": { "state": "ID" } }\n      ]\n    }\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br")])]),n("p",[s._v("这种查询就是本文要介绍的"),n("strong",[s._v("复合查询")]),s._v("，并且bool查询只是复合查询一种。")]),s._v(" "),n("h1",{attrs:{id:"bool-query-布尔查询"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#bool-query-布尔查询"}},[s._v("#")]),s._v(" bool query(布尔查询)")]),s._v(" "),n("hr"),s._v(" "),n("blockquote",[n("p",[s._v("通过布尔逻辑将较小的查询组合成较大的查询。")])]),s._v(" "),n("h3",{attrs:{id:"概念"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#概念"}},[s._v("#")]),s._v(" 概念")]),s._v(" "),n("p",[s._v("Bool查询语法有以下特点")]),s._v(" "),n("ul",[n("li",[s._v("子查询可以任意顺序出现")]),s._v(" "),n("li",[s._v("可以嵌套多个查询，包括bool查询")]),s._v(" "),n("li",[s._v("如果bool查询中没有must条件，should中必须至少满足一条才会返回结果。")])]),s._v(" "),n("p",[s._v("bool查询包含四种操作符，分别是must,should,must_not,filter。他们均是一种数组，数组里面是对应的判断条件。")]),s._v(" "),n("ul",[n("li",[n("code",[s._v("must")]),s._v("： 必须匹配。贡献算分")]),s._v(" "),n("li",[n("code",[s._v("must_not")]),s._v("：过滤子句，必须不能匹配，但不贡献算分")]),s._v(" "),n("li",[n("code",[s._v("should")]),s._v("： 选择性匹配，至少满足一条。贡献算分")]),s._v(" "),n("li",[n("code",[s._v("filter")]),s._v("： 过滤子句，必须匹配，但不贡献算分")])]),s._v(" "),n("h3",{attrs:{id:"一些例子"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#一些例子"}},[s._v("#")]),s._v(" 一些例子")]),s._v(" "),n("p",[s._v("看下官方举例")]),s._v(" "),n("ul",[n("li",[s._v("例子1")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('POST _search\n{\n  "query": {\n    "bool" : {\n      "must" : {\n        "term" : { "user.id" : "kimchy" }\n      },\n      "filter": {\n        "term" : { "tags" : "production" }\n      },\n      "must_not" : {\n        "range" : {\n          "age" : { "gte" : 10, "lte" : 20 }\n        }\n      },\n      "should" : [\n        { "term" : { "tags" : "env1" } },\n        { "term" : { "tags" : "deployed" } }\n      ],\n      "minimum_should_match" : 1,\n      "boost" : 1.0\n    }\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br")])]),n("p",[s._v("在filter元素下指定的查询对评分没有影响 , 评分返回为0。分数仅受已指定查询的影响。")]),s._v(" "),n("ul",[n("li",[s._v("例子2")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('GET _search\n{\n  "query": {\n    "bool": {\n      "filter": {\n        "term": {\n          "status": "active"\n        }\n      }\n    }\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br")])]),n("p",[s._v("这个例子查询查询为所有文档分配0分，因为没有指定评分查询。")]),s._v(" "),n("ul",[n("li",[s._v("例子3")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('GET _search\n{\n  "query": {\n    "bool": {\n      "must": {\n        "match_all": {}\n      },\n      "filter": {\n        "term": {\n          "status": "active"\n        }\n      }\n    }\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br")])]),n("p",[s._v("此bool查询具有match_all查询，该查询为所有文档指定1.0分。")]),s._v(" "),n("ul",[n("li",[s._v("例子4")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('GET /_search\n{\n  "query": {\n    "bool": {\n      "should": [\n        { "match": { "name.first": { "query": "shay", "_name": "first" } } },\n        { "match": { "name.last": { "query": "banon", "_name": "last" } } }\n      ],\n      "filter": {\n        "terms": {\n          "name.last": [ "banon", "kimchy" ],\n          "_name": "test"\n        }\n      }\n    }\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br")])]),n("p",[s._v("每个query条件都可以有一个"),n("code",[s._v("_name")]),s._v("属性，用来追踪搜索出的数据到底match了哪个条件。")]),s._v(" "),n("h1",{attrs:{id:"boosting-query-提高查询"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#boosting-query-提高查询"}},[s._v("#")]),s._v(" boosting query(提高查询)")]),s._v(" "),n("hr"),s._v(" "),n("blockquote",[n("p",[s._v("不同于bool查询，bool查询中只要一个子查询条件不匹配那么搜索的数据就不会出现。而boosting query则是降低显示的权重/优先级（即score)。")])]),s._v(" "),n("h3",{attrs:{id:"概念-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#概念-2"}},[s._v("#")]),s._v(" 概念")]),s._v(" "),n("p",[s._v("比如搜索逻辑是 name = 'apple' and type ='fruit'，对于只满足部分条件的数据，不是不显示，而是降低显示的优先级（即score)")]),s._v(" "),n("h3",{attrs:{id:"例子"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#例子"}},[s._v("#")]),s._v(" 例子")]),s._v(" "),n("p",[s._v("首先创建数据")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('POST /test-dsl-boosting/_bulk\n{ "index": { "_id": 1 }}\n{ "content":"Apple Mac" }\n{ "index": { "_id": 2 }}\n{ "content":"Apple Fruit" }\n{ "index": { "_id": 3 }}\n{ "content":"Apple employee like Apple Pie and Apple Juice" }\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[s._v("对匹配"),n("code",[s._v("pie")]),s._v("的做降级显示处理")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('GET /test-dsl-boosting/_search\n{\n  "query": {\n    "boosting": {\n      "positive": {\n        "term": {\n          "content": "apple"\n        }\n      },\n      "negative": {\n        "term": {\n          "content": "pie"\n        }\n      },\n      "negative_boost": 0.5\n    }\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br")])]),n("p",[s._v("执行结果如下")]),s._v(" "),n("p",[n("img",{attrs:{src:a(2514),alt:""}})]),s._v(" "),n("h1",{attrs:{id:"constant-score-固定分数查询"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#constant-score-固定分数查询"}},[s._v("#")]),s._v(" constant_score（固定分数查询）")]),s._v(" "),n("hr"),s._v(" "),n("blockquote",[n("p",[s._v("查询某个条件时，固定的返回指定的score；显然当不需要计算score时，只需要filter条件即可，因为filter context忽略score。")])]),s._v(" "),n("h3",{attrs:{id:"例子-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#例子-2"}},[s._v("#")]),s._v(" 例子")]),s._v(" "),n("p",[s._v("首先创建数据")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('POST /test-dsl-constant/_bulk\n{ "index": { "_id": 1 }}\n{ "content":"Apple Mac" }\n{ "index": { "_id": 2 }}\n{ "content":"Apple Fruit" }\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("查询apple")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('GET /test-dsl-constant/_search\n{\n  "query": {\n    "constant_score": {\n      "filter": {\n        "term": { "content": "apple" }\n      },\n      "boost": 1.2\n    }\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("p",[s._v("执行结果如下")]),s._v(" "),n("p",[n("img",{attrs:{src:a(2515),alt:""}})]),s._v(" "),n("h1",{attrs:{id:"dis-max-最佳匹配查询"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#dis-max-最佳匹配查询"}},[s._v("#")]),s._v(" dis_max(最佳匹配查询）")]),s._v(" "),n("hr"),s._v(" "),n("blockquote",[n("p",[s._v("分离最大化查询（Disjunction Max Query）指的是： 将任何与任一查询匹配的文档作为结果返回，但只将最佳匹配的评分作为查询的评分结果返回 。")])]),s._v(" "),n("h3",{attrs:{id:"例子-3"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#例子-3"}},[s._v("#")]),s._v(" 例子")]),s._v(" "),n("p",[s._v("假设有个网站允许用户搜索博客的内容，以下面两篇博客内容文档为例：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('POST /test-dsl-dis-max/_bulk\n{ "index": { "_id": 1 }}\n{"title": "Quick brown rabbits","body":  "Brown rabbits are commonly seen."}\n{ "index": { "_id": 2 }}\n{"title": "Keeping pets healthy","body":  "My quick brown fox eats rabbits on a regular basis."}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("用户输入词组 “Brown fox” 然后点击搜索按钮。事先，我们并不知道用户的搜索项是会在 title 还是在 body 字段中被找到，但是，用户很有可能是想搜索相关的词组。用肉眼判断，文档 2 的匹配度更高，因为它同时包括要查找的两个词：")]),s._v(" "),n("p",[s._v("现在运行以下 bool 查询：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('GET /test-dsl-dis-max/_search\n{\n    "query": {\n        "bool": {\n            "should": [\n                { "match": { "title": "Brown fox" }},\n                { "match": { "body":  "Brown fox" }}\n            ]\n        }\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("p",[n("img",{attrs:{src:a(2516),alt:""}})]),s._v(" "),n("p",[s._v("为了理解导致这样的原因，需要看下如何计算评分的")]),s._v(" "),n("ul",[n("li",[n("strong",[s._v("should 条件的计算分数")])])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('GET /test-dsl-dis-max/_search\n{\n    "query": {\n        "bool": {\n            "should": [\n                { "match": { "title": "Brown fox" }},\n                { "match": { "body":  "Brown fox" }}\n            ]\n        }\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("p",[s._v("要计算上述分数，首先要计算match的分数")]),s._v(" "),n("ol",[n("li",[s._v("第一个match 中 "),n("code",[s._v("brown的分数")])])]),s._v(" "),n("p",[s._v("doc 1 分数 = 0.6931471")]),s._v(" "),n("p",[n("img",{attrs:{src:a(2517),alt:""}})]),s._v(" "),n("ol",{attrs:{start:"2"}},[n("li",[s._v("title中没有fox，所以第一个match 中 "),n("code",[s._v("brown fox 的分数 = brown分数 + 0 = 0.6931471")])])]),s._v(" "),n("p",[s._v("doc 1 分数 = 0.6931471 + 0 = 0.6931471")]),s._v(" "),n("p",[n("img",{attrs:{src:a(2518),alt:""}})]),s._v(" "),n("ol",{attrs:{start:"3"}},[n("li",[s._v("第二个 match 中 "),n("code",[s._v("brown分数")])])]),s._v(" "),n("p",[s._v("doc 1 分数 = 0.21110919")]),s._v(" "),n("p",[s._v("doc 2 分数 = 0.160443")]),s._v(" "),n("p",[n("img",{attrs:{src:a(2519),alt:""}})]),s._v(" "),n("ol",{attrs:{start:"4"}},[n("li",[s._v("第二个 match 中 "),n("code",[s._v("fox分数")])])]),s._v(" "),n("p",[s._v("doc 1 分数 = 0")]),s._v(" "),n("p",[s._v("doc 2 分数 = 0.60996956")]),s._v(" "),n("p",[n("img",{attrs:{src:a(2520),alt:""}})]),s._v(" "),n("ol",{attrs:{start:"5"}},[n("li",[s._v("所以第二个 match 中 "),n("code",[s._v("brown fox分数 = brown分数 + fox分数")])])]),s._v(" "),n("p",[s._v("doc 1 分数 = 0.21110919 + 0 = 0.21110919")]),s._v(" "),n("p",[s._v("doc 2 分数 = 0.160443 + 0.60996956 = 0.77041256")]),s._v(" "),n("p",[n("img",{attrs:{src:a(2521),alt:""}})]),s._v(" "),n("ol",{attrs:{start:"6"}},[n("li",[s._v("所以整个语句分数， "),n("code",[s._v("should分数 = 第一个match + 第二个match分数")])])]),s._v(" "),n("p",[s._v("doc 1 分数 = 0.6931471 + 0.21110919 = 0.90425634")]),s._v(" "),n("p",[s._v("doc 2 分数 = 0 + 0.77041256 = 0.77041256")]),s._v(" "),n("p",[n("img",{attrs:{src:a(2522),alt:""}})]),s._v(" "),n("ul",[n("li",[n("strong",[s._v("引入了dis_max")])])]),s._v(" "),n("p",[s._v("不使用 bool 查询，可以使用 dis_max 即分离 最大化查询（Disjunction Max Query） 。分离（Disjunction）的意思是 或（or） ，这与可以把结合（conjunction）理解成 与（and） 相对应。分离最大化查询（Disjunction Max Query）指的是： 将任何与任一查询匹配的文档作为结果返回，但只将最佳匹配的评分作为查询的评分结果返回 ：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('GET /test-dsl-dis-max/_search\n{\n    "query": {\n        "dis_max": {\n            "queries": [\n                { "match": { "title": "Brown fox" }},\n                { "match": { "body":  "Brown fox" }}\n            ],\n            "tie_breaker": 0\n        }\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br")])]),n("p",[n("img",{attrs:{src:a(2523),alt:""}})]),s._v(" "),n("p",[s._v("0.77041256怎么来的呢？ 下文给你解释它如何计算出来的。")]),s._v(" "),n("ul",[n("li",[n("strong",[s._v("dis_max 条件的计算分数")])])]),s._v(" "),n("p",[s._v("分数 = 第一个匹配条件分数 + tie_breaker * 第二个匹配的条件的分数 ...")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('GET /test-dsl-dis-max/_search\n{\n    "query": {\n        "dis_max": {\n            "queries": [\n                { "match": { "title": "Brown fox" }},\n                { "match": { "body":  "Brown fox" }}\n            ],\n            "tie_breaker": 0\n        }\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br")])]),n("p",[s._v("doc 1 分数 = 0.6931471 + 0.21110919 * 0 = 0.6931471")]),s._v(" "),n("p",[s._v("doc 2 分数 = 0.77041256 = 0.77041256")]),s._v(" "),n("p",[n("img",{attrs:{src:a(2524),alt:""}})]),s._v(" "),n("p",[s._v("这样你就能理解通过dis_max将doc 2 置前了， 当然这里如果缺省"),n("code",[s._v("tie_breaker")]),s._v("字段的话默认就是0，你还可以设置它的比例（在0到1之间）来控制排名。（显然值为1时和should查询是一致的）")]),s._v(" "),n("h1",{attrs:{id:"function-score-函数查询"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#function-score-函数查询"}},[s._v("#")]),s._v(" function_score(函数查询）")]),s._v(" "),n("hr"),s._v(" "),n("blockquote",[n("p",[s._v("简而言之就是用自定义function的方式来计算_score。")])]),s._v(" "),n("p",[s._v("可以ES有哪些自定义function呢？")]),s._v(" "),n("ul",[n("li",[n("code",[s._v("script_score")]),s._v(" 使用自定义的脚本来完全控制分值计算逻辑。如果你需要以上预定义函数之外的功能，可以根据需要通过脚本进行实现。")]),s._v(" "),n("li",[n("code",[s._v("weight")]),s._v(" 对每份文档适用一个简单的提升，且该提升不会被归约：当weight为2时，结果为2 * _score。")]),s._v(" "),n("li",[n("code",[s._v("random_score")]),s._v(" 使用一致性随机分值计算来对每个用户采用不同的结果排序方式，对相同用户仍然使用相同的排序方式。")]),s._v(" "),n("li",[n("code",[s._v("field_value_factor")]),s._v(" 使用文档中某个字段的值来改变_score，比如将受欢迎程度或者投票数量考虑在内。")]),s._v(" "),n("li",[n("code",[s._v("衰减函数(Decay Function)")]),s._v(" - "),n("code",[s._v("linear")]),s._v("，"),n("code",[s._v("exp")]),s._v("，"),n("code",[s._v("gauss")])])]),s._v(" "),n("h3",{attrs:{id:"例子-4"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#例子-4"}},[s._v("#")]),s._v(" 例子")]),s._v(" "),n("p",[s._v("以最简单的random_score 为例")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('GET /_search\n{\n  "query": {\n    "function_score": {\n      "query": { "match_all": {} },\n      "boost": "5",\n      "random_score": {}, \n      "boost_mode": "multiply"\n    }\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("p",[s._v("进一步的，它还可以使用上述function的组合(functions)")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('GET /_search\n{\n  "query": {\n    "function_score": {\n      "query": { "match_all": {} },\n      "boost": "5", \n      "functions": [\n        {\n          "filter": { "match": { "test": "bar" } },\n          "random_score": {}, \n          "weight": 23\n        },\n        {\n          "filter": { "match": { "test": "cat" } },\n          "weight": 42\n        }\n      ],\n      "max_boost": 42,\n      "score_mode": "max",\n      "boost_mode": "multiply",\n      "min_score": 42\n    }\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br")])]),n("p",[s._v("script_score 可以使用如下方式")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('GET /_search\n{\n  "query": {\n    "function_score": {\n      "query": {\n        "match": { "message": "elasticsearch" }\n      },\n      "script_score": {\n        "script": {\n          "source": "Math.log(2 + doc[\'my-int\'].value)"\n        }\n      }\n    }\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br")])]),n("p",[s._v("更多相关内容，可以参考"),n("a",{attrs:{href:"https://www.elastic.co/guide/en/elasticsearch/reference/7.12/query-dsl-function-score-query.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("官方文档 在新窗口打开"),n("OutboundLink")],1),s._v(" PS: 形成体系化认知以后，具体用的时候查询下即可。")]),s._v(" "),n("h1",{attrs:{id:"参考文章"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#参考文章"}},[s._v("#")]),s._v(" 参考文章")]),s._v(" "),n("hr"),s._v(" "),n("p",[s._v("https://www.elastic.co/guide/en/elasticsearch/reference/current/compound-queries.html")]),s._v(" "),n("p",[s._v("https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-bool-query.html")]),s._v(" "),n("p",[s._v("https://www.elastic.co/guide/en/elasticsearch/reference/7.12/query-dsl-function-score-query.html)")])])}),[],!1,null,null,null);n.default=e.exports}}]);