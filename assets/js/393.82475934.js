(window.webpackJsonp=window.webpackJsonp||[]).push([[393],{288:function(s,a,r){s.exports=r.p+"assets/img/sharding-x-shard-2.83b3f0ba.png"},3493:function(s,a,r){s.exports=r.p+"assets/img/sharding-x-shadow-1.76becd6f.png"},4234:function(s,a,r){"use strict";r.r(a);var e=r(7),t=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"shardingsphere详解-通过影子库进行压测"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#shardingsphere详解-通过影子库进行压测"}},[s._v("#")]),s._v(" ShardingSphere详解 - 通过影子库进行压测")]),s._v(" "),a("p",[s._v("=============================================================")]),s._v(" "),a("blockquote",[a("p",[s._v("Apache ShardingSphere 关注于全链路压测场景下，数据库层面的解决方案。 将压测数据自动路由至用户指定的数据库，是 Apache ShardingSphere 影子库模块的主要设计目标; 这篇文章主要转载自"),a("a",{attrs:{href:"https://shardingsphere.apache.org/document/5.1.0/cn/reference/shadow",target:"_blank",rel:"noopener noreferrer"}},[s._v("ShardingSphere官方 在新窗口打开"),a("OutboundLink")],1),s._v("网站（V5.1.0版本）。@pdai")])]),s._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#shardingsphere%E8%AF%A6%E8%A7%A3---%E9%80%9A%E8%BF%87%E5%BD%B1%E5%AD%90%E5%BA%93%E8%BF%9B%E8%A1%8C%E5%8E%8B%E6%B5%8B"}},[s._v("ShardingSphere详解 - 通过影子库进行压测")]),s._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#%E8%83%8C%E6%99%AF"}},[s._v("背景")])]),s._v(" "),a("li",[a("a",{attrs:{href:"#%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84"}},[s._v("整体架构")])]),s._v(" "),a("li",[a("a",{attrs:{href:"#%E5%BD%B1%E5%AD%90%E8%A7%84%E5%88%99"}},[s._v("影子规则")])]),s._v(" "),a("li",[a("a",{attrs:{href:"#%E8%B7%AF%E7%94%B1%E8%BF%87%E7%A8%8B"}},[s._v("路由过程")])]),s._v(" "),a("li",[a("a",{attrs:{href:"#%E5%BD%B1%E5%AD%90%E5%88%A4%E5%AE%9A%E6%B5%81%E7%A8%8B"}},[s._v("影子判定流程")]),s._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#dml-%E8%AF%AD%E5%8F%A5"}},[s._v("DML 语句")])]),s._v(" "),a("li",[a("a",{attrs:{href:"#ddl-%E8%AF%AD%E5%8F%A5"}},[s._v("DDL 语句")])])])]),s._v(" "),a("li",[a("a",{attrs:{href:"#%E5%BD%B1%E5%AD%90%E7%AE%97%E6%B3%95"}},[s._v("影子算法")])]),s._v(" "),a("li",[a("a",{attrs:{href:"#%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B"}},[s._v("使用案例")]),s._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#%E5%9C%BA%E6%99%AF%E9%9C%80%E6%B1%82"}},[s._v("场景需求")])]),s._v(" "),a("li",[a("a",{attrs:{href:"#%E5%BD%B1%E5%AD%90%E5%BA%93%E9%85%8D%E7%BD%AE"}},[s._v("影子库配置")])]),s._v(" "),a("li",[a("a",{attrs:{href:"#%E5%BD%B1%E5%AD%90%E5%BA%93%E7%8E%AF%E5%A2%83"}},[s._v("影子库环境")])]),s._v(" "),a("li",[a("a",{attrs:{href:"#%E5%BD%B1%E5%AD%90%E7%AE%97%E6%B3%95%E4%BD%BF%E7%94%A8"}},[s._v("影子算法使用")]),s._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#%E5%88%97%E5%BD%B1%E5%AD%90%E7%AE%97%E6%B3%95%E4%BD%BF%E7%94%A8"}},[s._v("列影子算法使用")])]),s._v(" "),a("li",[a("a",{attrs:{href:"#%E4%BD%BF%E7%94%A8-hint-%E5%BD%B1%E5%AD%90%E7%AE%97%E6%B3%95"}},[s._v("使用 Hint 影子算法")])]),s._v(" "),a("li",[a("a",{attrs:{href:"#%E6%B7%B7%E5%90%88%E4%BD%BF%E7%94%A8%E5%BD%B1%E5%AD%90%E6%A8%A1%E5%BC%8F"}},[s._v("混合使用影子模式")])]),s._v(" "),a("li",[a("a",{attrs:{href:"#%E4%BD%BF%E7%94%A8%E9%BB%98%E8%AE%A4%E5%BD%B1%E5%AD%90%E7%AE%97%E6%B3%95"}},[s._v("使用默认影子算法")])])])])])])])])]),s._v(" "),a("h1",{attrs:{id:"背景"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#背景"}},[s._v("#")]),s._v(" 背景")]),s._v(" "),a("hr"),s._v(" "),a("blockquote",[a("p",[s._v("Apache ShardingSphere 关注于全链路压测场景下，数据库层面的解决方案。 将压测数据自动路由至用户指定的数据库，是 Apache ShardingSphere 影子库模块的主要设计目标。")])]),s._v(" "),a("p",[s._v("在基于微服务的分布式应用架构下，业务需要多个服务是通过一系列的服务、中间件的调用来完成，所以单个服务的压力测试已无法代表真实场景。 在测试环境中，如果重新搭建一整套与生产环境类似的压测环境，成本过高，并且往往无法模拟线上环境的复杂度以及流量。 因此，业内通常选择全链路压测的方式，即在生产环境进行压测，这样所获得的测试结果能够准确地反应系统真实容量和性能水平。")]),s._v(" "),a("p",[a("strong",[s._v("挑战")])]),s._v(" "),a("p",[s._v("全链路压测是一项复杂而庞大的工作。 需要各个微服务、中间件之间配合与调整，以应对不同流量以及压测标识的透传。 通常会搭建一整套压测平台以适用不同测试计划。 在数据库层面需要做好数据隔离，为了保证生产数据的可靠性与完整性，需要将压测产生的数据路由到压测环境数据库，防止压测数据对生产数据库中真实数据造成污染。 这就要求业务应用在执行 SQL 前，能够根据透传的压测标识，做好数据分类，将相应的 SQL 路由到与之对应的数据源。")]),s._v(" "),a("h1",{attrs:{id:"整体架构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#整体架构"}},[s._v("#")]),s._v(" 整体架构")]),s._v(" "),a("hr"),s._v(" "),a("p",[s._v("Apache ShardingSphere 通过解析 SQL，对传入的 SQL 进行影子判定，根据配置文件中用户设置的影子规则，路由到生产库或者影子库。")]),s._v(" "),a("p",[a("img",{attrs:{src:r(3493),alt:""}})]),s._v(" "),a("h1",{attrs:{id:"影子规则"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#影子规则"}},[s._v("#")]),s._v(" 影子规则")]),s._v(" "),a("hr"),s._v(" "),a("p",[s._v("影子规则包含影子数据源映射关系，影子表以及影子算法。")]),s._v(" "),a("p",[a("img",{attrs:{src:r(288),alt:""}})]),s._v(" "),a("ul",[a("li",[a("p",[a("strong",[s._v("影子库映射")]),s._v("：生产数据源名称和影子数据源名称映射关系。")])]),s._v(" "),a("li",[a("p",[a("strong",[s._v("影子表")]),s._v("：压测相关的影子表。影子表必须存在于指定的影子库中，并且需要指定影子算法。")])]),s._v(" "),a("li",[a("p",[a("strong",[s._v("影子算法")]),s._v("：SQL 路由影子算法。")])]),s._v(" "),a("li",[a("p",[a("strong",[s._v("默认影子算法")]),s._v("：默认影子算法。选配项，对于没有配置影子算法表的默认匹配算法。")])])]),s._v(" "),a("h1",{attrs:{id:"路由过程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#路由过程"}},[s._v("#")]),s._v(" 路由过程")]),s._v(" "),a("hr"),s._v(" "),a("p",[s._v("以 INSERT 语句为例，在写入数据时，Apache ShardingSphere 会对 SQL 进行解析，再根据配置文件中的规则，构造一条路由链。在当前版本的功能中， 影子功能处于路由链中的最后一个执行单元，即，如果有其他需要路由的规则存在，如分片，Apache ShardingSphere 会首先根据分片规则，路由到某一个数据库，再 执行影子路由判定流程，判定执行SQL满足影子规则的配置，数据路由到与之对应的影子库，生产数据则维持不变。")]),s._v(" "),a("h1",{attrs:{id:"影子判定流程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#影子判定流程"}},[s._v("#")]),s._v(" 影子判定流程")]),s._v(" "),a("hr"),s._v(" "),a("blockquote",[a("p",[s._v("影子库功能对执行的 SQL 语句进行影子判定。影子判定支持两种类型算法，用户可根据实际业务需求选择一种或者组合使用。")])]),s._v(" "),a("h3",{attrs:{id:"dml-语句"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#dml-语句"}},[s._v("#")]),s._v(" DML 语句")]),s._v(" "),a("p",[s._v("支持两种算法。影子判定会首先判断执行 SQL 相关表与配置的影子表是否有交集。如果有交集，依次判定交集部分影子表关联的影子算法，有任何一个判定成功。SQL 语句路由到影子库。 影子表没有交集或者影子算法判定不成功，SQL 语句路由到生产库。")]),s._v(" "),a("h3",{attrs:{id:"ddl-语句"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ddl-语句"}},[s._v("#")]),s._v(" DDL 语句")]),s._v(" "),a("p",[s._v("仅支持注解影子算法。在压测场景下，DDL 语句一般不需要测试。主要在初始化或者修改影子库中影子表时使用。")]),s._v(" "),a("p",[s._v("影子判定会首先判断执行 SQL 是否包含注解。如果包含注解，影子规则中配置的 HINT 影子算法依次判定。有任何一个判定成功。SQL 语句路由到影子库。 执行 SQL 不包含注解或者 HINT 影子算法判定不成功，SQL 语句路由到生产库。")]),s._v(" "),a("h1",{attrs:{id:"影子算法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#影子算法"}},[s._v("#")]),s._v(" 影子算法")]),s._v(" "),a("hr"),s._v(" "),a("p",[s._v("影子算法详情，请参见"),a("a",{attrs:{href:"https://shardingsphere.apache.org/document/5.1.0/cn/user-manual/shardingsphere-jdbc/builtin-algorithm/shadow/",target:"_blank",rel:"noopener noreferrer"}},[s._v("内置影子算法列表 在新窗口打开"),a("OutboundLink")],1)]),s._v(" "),a("h1",{attrs:{id:"使用案例"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用案例"}},[s._v("#")]),s._v(" 使用案例")]),s._v(" "),a("hr"),s._v(" "),a("h3",{attrs:{id:"场景需求"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#场景需求"}},[s._v("#")]),s._v(" 场景需求")]),s._v(" "),a("p",[s._v("假设一个电商网站要对下单业务进行压测。压测相关表 t_order 为影子表，生产数据执行到 ds 生产数据库，压测数据执行到数据库 ds_shadow 影子库。")]),s._v(" "),a("h3",{attrs:{id:"影子库配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#影子库配置"}},[s._v("#")]),s._v(" 影子库配置")]),s._v(" "),a("p",[s._v("建议配置如下（YAML 格式展示）：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("data-sources:\n  shadow-data-source:\n    source-data-source-name: ds\n    shadow-data-source-name: ds-shadow\ntables:\n  t_order:\n    data-source-names: shadow-data-source\n    shadow-algorithm-names:\n      - simple-hint-algorithm\n      - user-id-value-match-algorithm\nshadow-algorithms:\n  simple-hint-algorithm:\n    type: SIMPLE_HINT\n    props:\n      foo: bar\n  user-id-value-match-algorithm:\n    type: VALUE_MATCH\n    props:\n      operation: insert\n      column: user_id\n      value: 0\n      \nsql-parser:\n  sql-comment-parse-enabled: true\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br")])]),a("p",[a("strong",[s._v("注意")]),s._v("： 如果使用注解影子算法，需要开启解析 SQL 注释配置项 sql-comment-parse-enabled: true。默认关闭。 请参考 SQL 解析配置")]),s._v(" "),a("h3",{attrs:{id:"影子库环境"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#影子库环境"}},[s._v("#")]),s._v(" 影子库环境")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("创建影子库 ds_shadow。")])]),s._v(" "),a("li",[a("p",[s._v("创建影子表，表结构与生产环境必须一致。假设在影子库创建 t_order 表。创建表语句需要添加 SQL 注释 "),a("code",[s._v("/*foo:bar,...*/")]),s._v("。即：")])])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("CREATE TABLE t_order (order_id INT(11) primary key, user_id int(11) not null, ...) /*foo:bar,...*/\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("执行到影子库。")]),s._v(" "),a("p",[a("strong",[s._v("注意")]),s._v("：如果使用 MySQL 客户端进行测试，链接需要使用参数：-c 例如：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("mysql> mysql -u root -h127.0.0.1 -P3306 -proot -c\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("参数说明：保留注释，发送注释到服务端。")]),s._v(" "),a("p",[s._v("执行包含注解 SQL 例如：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("SELECT * FROM table_name /*shadow:true,foo:bar*/;\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("不使用参数 -c 会被 MySQL 客户端截取注释语句变为:")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("SELECT * FROM table_name;\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("影响测试结果。")]),s._v(" "),a("h3",{attrs:{id:"影子算法使用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#影子算法使用"}},[s._v("#")]),s._v(" 影子算法使用")]),s._v(" "),a("h4",{attrs:{id:"列影子算法使用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#列影子算法使用"}},[s._v("#")]),s._v(" 列影子算法使用")]),s._v(" "),a("p",[s._v("假设 t_order 表中包含下单用户ID的 user_id 列。 实现的效果，当用户ID为 0 的用户创建订单产生的数据。 即：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("INSERT INTO t_order (order_id, user_id, ...) VALUES (xxx..., 0, ...)\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("会执行到影子库，其他数据执行到生产库。")]),s._v(" "),a("p",[s._v("无需修改任何 SQL 或者代码，只需要对压力测试的数据进行控制就可以实现在线的压力测试。")]),s._v(" "),a("p",[s._v("算法配置如下（YAML 格式展示）：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("shadow-algorithms:\n  user-id-value-match-algorithm:\n    type: VALUE_MATCH\n    props:\n      operation: insert\n      column: user_id\n      value: 0\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[a("strong",[s._v("注意")]),s._v("：影子表使用列影子算法时，相同类型操作（INSERT, UPDATE, DELETE, SELECT）目前仅支持单个字段。")]),s._v(" "),a("h4",{attrs:{id:"使用-hint-影子算法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用-hint-影子算法"}},[s._v("#")]),s._v(" 使用 Hint 影子算法")]),s._v(" "),a("p",[s._v("假设 t_order 表中不包含可以对值进行匹配的列。添加注解 "),a("code",[s._v("/*foo:bar,...*/")]),s._v(" 到执行 SQL 中，即：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("SELECT * FROM t_order WHERE order_id = xxx /*foo:bar,...*/\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("会执行到影子库，其他数据执行到生产库。")]),s._v(" "),a("p",[s._v("算法配置如下（YAML 格式展示）：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("shadow-algorithms:\n  simple-hint-algorithm:\n    type: SIMPLE_HINT\n    props:\n      foo: bar\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("h4",{attrs:{id:"混合使用影子模式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#混合使用影子模式"}},[s._v("#")]),s._v(" 混合使用影子模式")]),s._v(" "),a("p",[s._v("假设对 t_order 表压测需要覆盖以上两种场景，即，")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("INSERT INTO t_order (order_id, user_id, ...) VALUES (xxx..., 0, ...);\n\nSELECT * FROM t_order WHERE order_id = xxx /*foo:bar,...*/;\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("都会执行到影子库，其他数据执行到生产库。")]),s._v(" "),a("p",[s._v("算法配置如下（YAML 格式展示）：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("shadow-algorithms:\n  user-id-value-match-algorithm:\n    type: VALUE_MATCH\n    props:\n      operation: insert\n      column: user_id\n      value: 0\n  simple-hint-algorithm:\n    type: SIMPLE_HINT\n    props:\n      foo: bar\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("h4",{attrs:{id:"使用默认影子算法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用默认影子算法"}},[s._v("#")]),s._v(" 使用默认影子算法")]),s._v(" "),a("p",[s._v("假设对 t_order 表压测使用列影子算法，其他相关其他表都需要使用 Hint 影子算法。即,")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("INSERT INTO t_order (order_id, user_id, ...) VALUES (xxx..., 0, ...);\n\nINSERT INTO t_xxx_1 (order_item_id, order_id, ...) VALUES (xxx..., xxx..., ...) /*foo:bar,...*/;\n\nSELECT * FROM t_xxx_2 WHERE order_id = xxx /*foo:bar,...*/;\n\nSELECT * FROM t_xxx_3 WHERE order_id = xxx /*foo:bar,...*/;\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("都会执行到影子库，其他数据执行到生产库。")]),s._v(" "),a("p",[s._v("配置如下（YAML 格式展示）：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("data-sources:\n  shadow-data-source:\n    source-data-source-name: ds\n    shadow-data-source-name: ds-shadow\ntables:\n  t_order:\n    data-source-names: shadow-data-source\n    shadow-algorithm-names:\n      - simple-hint-algorithm\n      - user-id-value-match-algorithm\ndefault-shadow-algorithm-name: simple-note-algorithm\nshadow-algorithms:\n  simple-hint-algorithm:\n    type: SIMPLE_HINT\n    props:\n      foo: bar\n  user-id-value-match-algorithm:\n    type: VALUE_MATCH\n    props:\n      operation: insert\n      column: user_id\n      value: 0\n      \nsql-parser:\n  sql-comment-parse-enabled: true\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br")])]),a("p",[a("strong",[s._v("注意")]),s._v(" 默认影子算法仅支持 Hint 影子算法。 使用时必须确保配置文件中 props 的配置项小于等于 SQL 注释中的配置项，且配置文件的具体配置要和 SQL 注释中写的配置一样，配置文件中配置项越少，匹配条件越宽松")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("simple-note-algorithm:\n  type: SIMPLE_HINT\n  props:\n    foo: bar\n    foo1: bar1\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("如当前 props 项中配置了 2 条配置，在 SQL 中可以匹配的写法有如下：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("SELECT * FROM t_xxx_2 WHERE order_id = xxx /*foo:bar, foo1:bar1*/\nSELECT * FROM t_xxx_2 WHERE order_id = xxx /*foo:bar, foo1:bar1, foo2:bar2, ...*/\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("simple-note-algorithm:\n  type: SIMPLE_HINT\n  props:\n    foo: bar\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("如当前 props 项中配置了 1 条配置，在sql中可以匹配的写法有如下：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("SELECT * FROM t_xxx_2 WHERE order_id = xxx /*foo:foo*/\nSELECT * FROM t_xxx_2 WHERE order_id = xxx /*foo:foo, foo1:bar1, ...*/\n```)")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])])])}),[],!1,null,null,null);a.default=t.exports}}]);