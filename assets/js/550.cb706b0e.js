(window.webpackJsonp=window.webpackJsonp||[]).push([[550],{3699:function(e,s,t){"use strict";t.r(s);var r=t(7),i=Object(r.a)({},(function(){var e=this,s=e._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("h1",{attrs:{id:"▶springboot定时任务-timer实现方式"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#▶springboot定时任务-timer实现方式"}},[e._v("#")]),e._v(" ▶SpringBoot定时任务 - Timer实现方式")]),e._v(" "),s("p",[e._v("===========================================================")]),e._v(" "),s("blockquote",[s("p",[e._v("定时任务在实际开发中有着广泛的用途，本文主要帮助你构建定时任务的知识体系，同时展示Timer 的schedule和scheduleAtFixedRate例子；后续的文章中我们将逐一介绍其它常见的与SpringBoot的集成。@pdai")])]),e._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"#springboot%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1---timer%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F"}},[e._v("▶SpringBoot定时任务 - Timer实现方式")]),e._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"#%E7%9F%A5%E8%AF%86%E5%87%86%E5%A4%87"}},[e._v("知识准备")]),e._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"#%E4%BB%80%E4%B9%88%E6%A0%B7%E7%9A%84%E5%9C%BA%E6%99%AF%E4%BC%9A%E4%BD%BF%E7%94%A8%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1"}},[e._v("什么样的场景会使用定时任务？")])]),e._v(" "),s("li",[s("a",{attrs:{href:"#%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%9C%89%E5%93%AA%E4%BA%9B%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F"}},[e._v("定时任务有哪些实现方式？")])])])]),e._v(" "),s("li",[s("a",{attrs:{href:"#timer%E5%AE%9E%E7%8E%B0%E6%A1%88%E4%BE%8B"}},[e._v("Timer实现案例")]),e._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"#schedule%E5%BB%B6%E8%BF%9F%E4%BB%BB%E5%8A%A1"}},[e._v("schedule延迟任务")])]),e._v(" "),s("li",[s("a",{attrs:{href:"#schedule%E5%91%A8%E6%9C%9F%E4%BB%BB%E5%8A%A1"}},[e._v("schedule周期任务")])]),e._v(" "),s("li",[s("a",{attrs:{href:"#scheduleatfixedrate"}},[e._v("scheduleAtFixedRate")])])])]),e._v(" "),s("li",[s("a",{attrs:{href:"#%E8%BF%9B%E4%B8%80%E6%AD%A5%E7%90%86%E8%A7%A3"}},[e._v("进一步理解")]),e._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"#schedule-%E5%92%8C-scheduleatfixedrate-%E6%9C%89%E4%BD%95%E5%8C%BA%E5%88%AB"}},[e._v("schedule 和 scheduleAtFixedRate 有何区别？")])]),e._v(" "),s("li",[s("a",{attrs:{href:"#%E4%B8%BA%E4%BB%80%E4%B9%88%E5%87%A0%E4%B9%8E%E5%BE%88%E5%B0%91%E4%BD%BF%E7%94%A8timer%E8%BF%99%E7%A7%8D%E6%96%B9%E5%BC%8F"}},[e._v("为什么几乎很少使用Timer这种方式？")])])])]),e._v(" "),s("li",[s("a",{attrs:{href:"#%E7%A4%BA%E4%BE%8B%E6%BA%90%E7%A0%81"}},[e._v("示例源码")])])])])]),e._v(" "),s("h1",{attrs:{id:"知识准备"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#知识准备"}},[e._v("#")]),e._v(" 知识准备")]),e._v(" "),s("hr"),e._v(" "),s("blockquote",[s("p",[e._v("需要对定时任务的使用场景和常见的实现方式。")])]),e._v(" "),s("h3",{attrs:{id:"什么样的场景会使用定时任务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#什么样的场景会使用定时任务"}},[e._v("#")]),e._v(" 什么样的场景会使用定时任务？")]),e._v(" "),s("p",[e._v("比如每天/每周/每月生成日志汇总，定时发送推送信息，定时生成数据表格等")]),e._v(" "),s("h3",{attrs:{id:"定时任务有哪些实现方式"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#定时任务有哪些实现方式"}},[e._v("#")]),e._v(" 定时任务有哪些实现方式？")]),e._v(" "),s("blockquote",[s("p",[e._v("首先你需要构建如下实现定时任务的知识体系。在后续的文章中我们将逐一介绍在SpringBoot下的集成。")])]),e._v(" "),s("ul",[s("li",[s("strong",[e._v("定时任务基础")]),e._v(" "),s("ul",[s("li",[e._v("Cron表达式")]),e._v(" "),s("li",[e._v("Linux定时任务工具crontb")])])]),e._v(" "),s("li",[s("strong",[e._v("JDK内置")]),e._v(" "),s("ul",[s("li",[e._v("Timer")]),e._v(" "),s("li",[e._v("ScheduleExecutorService")])])]),e._v(" "),s("li",[s("strong",[e._v("Netty")]),e._v(" "),s("ul",[s("li",[e._v("HashedWheelTimer")])])]),e._v(" "),s("li",[s("strong",[e._v("Spring")]),e._v(" "),s("ul",[s("li",[e._v("Spring自带Schedule")]),e._v(" "),s("li",[e._v("Spring集成Quartz")])])]),e._v(" "),s("li",[s("strong",[e._v("分布式集群")]),e._v(" "),s("ul",[s("li",[e._v("Quartz持久化JDBC方式")]),e._v(" "),s("li",[e._v("Elastic-job")]),e._v(" "),s("li",[e._v("xxl-job")])])])]),e._v(" "),s("h1",{attrs:{id:"timer实现案例"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#timer实现案例"}},[e._v("#")]),e._v(" Timer实现案例")]),e._v(" "),s("hr"),e._v(" "),s("blockquote",[s("p",[e._v("Timer 的schedule和scheduleAtFixedRate例子如下。")])]),e._v(" "),s("h3",{attrs:{id:"schedule延迟任务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#schedule延迟任务"}},[e._v("#")]),e._v(" schedule延迟任务")]),e._v(" "),s("p",[e._v("执行定时任务，延迟1秒开始执行。")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('@SneakyThrows\npublic static void timer() {\n    // start timer\n    Timer timer = new Timer();\n    timer.schedule(new TimerTask() {\n        public void run() {\n            log.info("timer-task @{}", LocalDateTime.now());\n        }\n    }, 1000);\n\n    // waiting to process(sleep to mock)\n    Thread.sleep(3000);\n\n    // stop timer\n    timer.cancel();\n}\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br"),s("span",{staticClass:"line-number"},[e._v("16")]),s("br")])]),s("p",[e._v("输出")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("10:05:47.440 [Timer-0] INFO tech.pdai.springboot.schedule.timer.timertest.TimerTester - timer-task @2021-10-01T20:05:47.436\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("h3",{attrs:{id:"schedule周期任务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#schedule周期任务"}},[e._v("#")]),e._v(" schedule周期任务")]),e._v(" "),s("p",[e._v("延迟0.5秒开始执行，每秒执行一次， 10秒后停止。")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('@SneakyThrows\npublic static void timerPeriod() {\n    // start timer\n    Timer timer = new Timer();\n    timer.schedule(new TimerTask() {\n        @SneakyThrows\n        public void run() {\n            log.info("timer-period-task @{}", LocalDateTime.now());\n            Thread.sleep(100); // 可以设置的执行时间, 来测试当执行时间大于执行周期时任务执行的变化 \n        }\n    }, 500, 1000);\n\n    // waiting to process(sleep to mock)\n    Thread.sleep(10000);\n\n    // stop timer\n    timer.cancel();\n}\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br"),s("span",{staticClass:"line-number"},[e._v("16")]),s("br"),s("span",{staticClass:"line-number"},[e._v("17")]),s("br"),s("span",{staticClass:"line-number"},[e._v("18")]),s("br")])]),s("p",[e._v("输出")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("10:05:49.781 [Timer-1] INFO tech.pdai.springboot.schedule.timer.timertest.TimerTester - timer-period-task @2021-10-01T10:05:49.781\n10:05:50.781 [Timer-1] INFO tech.pdai.springboot.schedule.timer.timertest.TimerTester - timer-period-task @2021-10-01T10:05:50.781\n10:05:51.781 [Timer-1] INFO tech.pdai.springboot.schedule.timer.timertest.TimerTester - timer-period-task @2021-10-01T10:05:51.781\n10:05:52.781 [Timer-1] INFO tech.pdai.springboot.schedule.timer.timertest.TimerTester - timer-period-task @2021-10-01T10:05:52.781\n10:05:53.782 [Timer-1] INFO tech.pdai.springboot.schedule.timer.timertest.TimerTester - timer-period-task @2021-10-01T10:05:53.782\n10:05:54.783 [Timer-1] INFO tech.pdai.springboot.schedule.timer.timertest.TimerTester - timer-period-task @2021-10-01T10:05:54.783\n10:05:55.783 [Timer-1] INFO tech.pdai.springboot.schedule.timer.timertest.TimerTester - timer-period-task @2021-10-01T10:05:55.783\n10:05:56.784 [Timer-1] INFO tech.pdai.springboot.schedule.timer.timertest.TimerTester - timer-period-task @2021-10-01T10:05:56.784\n10:05:57.785 [Timer-1] INFO tech.pdai.springboot.schedule.timer.timertest.TimerTester - timer-period-task @2021-10-01T10:05:57.785\n10:05:58.786 [Timer-1] INFO tech.pdai.springboot.schedule.timer.timertest.TimerTester - timer-period-task @2021-10-01T10:05:58.786\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br")])]),s("h3",{attrs:{id:"scheduleatfixedrate"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#scheduleatfixedrate"}},[e._v("#")]),e._v(" scheduleAtFixedRate")]),e._v(" "),s("p",[e._v("延迟0.5秒开始执行，每秒执行一次， 10秒后停止。")]),e._v(" "),s("p",[e._v("同时测试某次任务执行时间大于周期时间的变化。")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('@SneakyThrows\npublic static void timerFixedRate() {\n    // start timer\n    Timer timer = new Timer();\n    timer.scheduleAtFixedRate(new TimerTask() {\n        int count = 0;\n\n        @SneakyThrows\n        public void run() {\n            if (count++==2) {\n                Thread.sleep(5000); // 某一次执行时间超过了period(执行周期）\n            }\n            log.info("timer-fixedRate-task @{}", LocalDateTime.now());\n\n        }\n    }, 500, 1000);\n\n    // waiting to process(sleep to mock)\n    Thread.sleep(10000);\n\n    // stop timer\n    timer.cancel();\n}\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br"),s("span",{staticClass:"line-number"},[e._v("16")]),s("br"),s("span",{staticClass:"line-number"},[e._v("17")]),s("br"),s("span",{staticClass:"line-number"},[e._v("18")]),s("br"),s("span",{staticClass:"line-number"},[e._v("19")]),s("br"),s("span",{staticClass:"line-number"},[e._v("20")]),s("br"),s("span",{staticClass:"line-number"},[e._v("21")]),s("br"),s("span",{staticClass:"line-number"},[e._v("22")]),s("br"),s("span",{staticClass:"line-number"},[e._v("23")]),s("br")])]),s("p",[e._v("输出")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("10:05:59.781 [Timer-2] INFO tech.pdai.springboot.schedule.timer.timertest.TimerTester - timer-fixedRate-task @2021-10-01T10:05:59.781\n10:06:00.782 [Timer-2] INFO tech.pdai.springboot.schedule.timer.timertest.TimerTester - timer-fixedRate-task @2021-10-01T10:06:00.782\n10:06:06.783 [Timer-2] INFO tech.pdai.springboot.schedule.timer.timertest.TimerTester - timer-fixedRate-task @2021-10-01T10:06:06.783\n10:06:06.783 [Timer-2] INFO tech.pdai.springboot.schedule.timer.timertest.TimerTester - timer-fixedRate-task @2021-10-01T10:06:06.783\n10:06:06.783 [Timer-2] INFO tech.pdai.springboot.schedule.timer.timertest.TimerTester - timer-fixedRate-task @2021-10-01T10:06:06.783\n10:06:06.783 [Timer-2] INFO tech.pdai.springboot.schedule.timer.timertest.TimerTester - timer-fixedRate-task @2021-10-01T10:06:06.783\n10:06:06.783 [Timer-2] INFO tech.pdai.springboot.schedule.timer.timertest.TimerTester - timer-fixedRate-task @2021-10-01T10:06:06.783\n10:06:06.783 [Timer-2] INFO tech.pdai.springboot.schedule.timer.timertest.TimerTester - timer-fixedRate-task @2021-10-01T10:06:06.783\n10:06:07.781 [Timer-2] INFO tech.pdai.springboot.schedule.timer.timertest.TimerTester - timer-fixedRate-task @2021-10-01T10:06:07.781\n10:06:08.781 [Timer-2] INFO tech.pdai.springboot.schedule.timer.timertest.TimerTester - timer-fixedRate-task @2021-10-01T10:06:08.781\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br")])]),s("p",[e._v("（你会发现周期执行1秒中执行一次，但是某次执行了5秒，这时候，后续的任务会加快执行进度，一次性就执行了，执行的时间都是10:06:06.783， 所以scheduleAtFixedRate最大的特点是"),s("strong",[e._v("保证了总时间段内的执行次数")]),e._v("）")]),e._v(" "),s("h1",{attrs:{id:"进一步理解"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#进一步理解"}},[e._v("#")]),e._v(" 进一步理解")]),e._v(" "),s("hr"),e._v(" "),s("blockquote",[s("p",[e._v("我们再通过一些问题来帮助你更深入理解Timer实现方式。@pdai")])]),e._v(" "),s("h3",{attrs:{id:"schedule-和-scheduleatfixedrate-有何区别"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#schedule-和-scheduleatfixedrate-有何区别"}},[e._v("#")]),e._v(" schedule 和 scheduleAtFixedRate 有何区别？")]),e._v(" "),s("ul",[s("li",[s("p",[s("strong",[e._v("schedule")]),e._v("：每次执行完当前任务后，然后间隔一个period的时间再执行下一个任务； 当某个任务执行周期大于时间间隔时，依然按照间隔时间执行下个任务，即它"),s("strong",[e._v("保证了任务之间执行的间隔")]),e._v("。")])]),e._v(" "),s("li",[s("p",[s("strong",[e._v("scheduleAtFixedRate")]),e._v("：每次执行时间为上一次任务开始起向后推一个period间隔，也就是说下次执行时间相对于上一次任务开始的时间点；按照上述的例子，它"),s("strong",[e._v("保证了总时间段内的任务的执行次数")])])])]),e._v(" "),s("h3",{attrs:{id:"为什么几乎很少使用timer这种方式"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#为什么几乎很少使用timer这种方式"}},[e._v("#")]),e._v(" 为什么几乎很少使用Timer这种方式？")]),e._v(" "),s("p",[e._v("Timer底层是使用一个单线来实现多个Timer任务处理的，所有任务都是由同一个线程来调度，所有任务都是串行执行，意味着同一时间只能有一个任务得到执行，而前一个任务的延迟或者异常会影响到之后的任务。")]),e._v(" "),s("p",[e._v("如果有一个定时任务在运行时，产生未处理的异常，那么当前这个线程就会停止，那么所有的定时任务都会停止，受到影响。")]),e._v(" "),s("p",[e._v("PS：在这点上你可以看到，定时任务Job中"),s("strong",[e._v("异常")]),e._v("和"),s("strong",[e._v("超时")]),e._v("等一般都是要自行处理的，以防止对其它任务的影响。")]),e._v(" "),s("h1",{attrs:{id:"示例源码"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#示例源码"}},[e._v("#")]),e._v(" 示例源码")]),e._v(" "),s("hr"),e._v(" "),s("p",[e._v("https://github.com/realpdai/tech-pdai-spring-demos")])])}),[],!1,null,null,null);s.default=i.exports}}]);