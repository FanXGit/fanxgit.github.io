(window.webpackJsonp=window.webpackJsonp||[]).push([[485],{3390:function(s,n,e){s.exports=e.p+"assets/img/tomcat-x-server-1.e332b784.jpg"},4204:function(s,n,e){"use strict";e.r(n);var a=e(7),t=Object(a.a)({},(function(){var s=this,n=s._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"tomcat-server的设计和实现-standardserver"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#tomcat-server的设计和实现-standardserver"}},[s._v("#")]),s._v(" Tomcat - Server的设计和实现: StandardServer")]),s._v(" "),n("p",[s._v("==============================================================================")]),s._v(" "),n("blockquote",[n("p",[s._v("基于前面的几篇文章，我们终于可以总体上梳理Server的具体实现了，这里体现在StandardServer具体的功能实现上。@pdai")])]),s._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"#tomcat---server%E7%9A%84%E8%AE%BE%E8%AE%A1%E5%92%8C%E5%AE%9E%E7%8E%B0-standardserver"}},[s._v("Tomcat - Server的设计和实现: StandardServer")]),s._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"#%E7%90%86%E8%A7%A3%E6%80%9D%E8%B7%AF"}},[s._v("理解思路")])]),s._v(" "),n("li",[n("a",{attrs:{href:"#server%E7%BB%93%E6%9E%84%E8%AE%BE%E8%AE%A1"}},[s._v("Server结构设计")]),s._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"#serverxml"}},[s._v("server.xml")])]),s._v(" "),n("li",[n("a",{attrs:{href:"#server%E4%B8%AD%E7%9A%84%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1"}},[s._v("Server中的接口设计")])])])]),s._v(" "),n("li",[n("a",{attrs:{href:"#standardserver%E7%9A%84%E5%AE%9E%E7%8E%B0"}},[s._v("StandardServer的实现")]),s._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"#%E7%BA%BF%E7%A8%8B%E6%B1%A0"}},[s._v("线程池")])]),s._v(" "),n("li",[n("a",{attrs:{href:"#service%E7%9B%B8%E5%85%B3%E6%96%B9%E6%B3%95%E5%AE%9E%E7%8E%B0"}},[s._v("Service相关方法实现")])]),s._v(" "),n("li",[n("a",{attrs:{href:"#lifecycle%E7%9B%B8%E5%85%B3%E6%A8%A1%E6%9D%BF%E6%96%B9%E6%B3%95"}},[s._v("Lifecycle相关模板方法")])])])]),s._v(" "),n("li",[n("a",{attrs:{href:"#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"}},[s._v("参考文章")])])])])]),s._v(" "),n("h1",{attrs:{id:"理解思路"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#理解思路"}},[s._v("#")]),s._v(" 理解思路")]),s._v(" "),n("hr"),s._v(" "),n("ul",[n("li",[n("strong",[s._v("第一：抓住StandardServer整体类依赖结构来理解")])])]),s._v(" "),n("p",[n("img",{attrs:{src:e(3390),alt:""}})]),s._v(" "),n("ul",[n("li",[n("strong",[s._v("第二：结合server.xml来理解")])])]),s._v(" "),n("p",[s._v("见下文具体阐述。")]),s._v(" "),n("ul",[n("li",[n("strong",[s._v("第三：结合Server Config官方配置文档")])])]),s._v(" "),n("p",[s._v("http://tomcat.apache.org/tomcat-9.0-doc/config/server.html")]),s._v(" "),n("h1",{attrs:{id:"server结构设计"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#server结构设计"}},[s._v("#")]),s._v(" Server结构设计")]),s._v(" "),n("hr"),s._v(" "),n("blockquote",[n("p",[s._v("我们需要从高一点的维度去理解Server的结构设计，而不是多少方法多少代码；这里的理解一定是要结合Server.xml对应理解。@pdai")])]),s._v(" "),n("h3",{attrs:{id:"server-xml"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#server-xml"}},[s._v("#")]),s._v(" server.xml")]),s._v(" "),n("ul",[n("li",[s._v("首先要看下server.xml，这样你便知道了需要了解的四个部分")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('<Server port="8005" shutdown="SHUTDOWN">\n  \x3c!-- 1.属性说明\n    port:指定一个端口，这个端口负责监听关闭Tomcat的请求\n    shutdown:向以上端口发送的关闭服务器的命令字符串\n  --\x3e\n\n  \x3c!-- 2.Listener 相关 --\x3e\n  <Listener className="org.apache.catalina.core.AprLifecycleListener" />\n  <Listener className="org.apache.catalina.mbeans.ServerLifecycleListener" />\n  <Listener className="org.apache.catalina.mbeans.GlobalResourcesLifecycleListener" />\n  <Listener className="org.apache.catalina.storeconfig.StoreConfigLifecycleListener"/>\n\n  \x3c!-- 3.GlobalNamingResources 相关 --\x3e\n  <GlobalNamingResources>\n\n    <Environment name="simpleValue" type="java.lang.Integer" value="30"/>\n\n    <Resource name="UserDatabase" auth="Container"\n              type="org.apache.catalina.UserDatabase"\n       description="User database that can be updated and saved"\n           factory="org.apache.catalina.users.MemoryUserDatabaseFactory"\n          pathname="conf/tomcat-users.xml" />\n\n  </GlobalNamingResources>\n\n  \x3c!-- 4.service 相关 --\x3e\n  <Service name="Catalina">\n\n  </Service>\n</Server>\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br")])]),n("h3",{attrs:{id:"server中的接口设计"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#server中的接口设计"}},[s._v("#")]),s._v(" Server中的接口设计")]),s._v(" "),n("ul",[n("li",[n("strong",[s._v("公共属性")]),s._v(", 包括上面的port，shutdown, address等")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("/**\n  * @return the port number we listen to for shutdown commands.\n  *\n  * @see #getPortOffset()\n  * @see #getPortWithOffset()\n  */\npublic int getPort();\n\n\n/**\n  * Set the port number we listen to for shutdown commands.\n  *\n  * @param port The new port number\n  *\n  * @see #setPortOffset(int)\n  */\npublic void setPort(int port);\n\n/**\n  * Get the number that offsets the port used for shutdown commands.\n  * For example, if port is 8005, and portOffset is 1000,\n  * the server listens at 9005.\n  *\n  * @return the port offset\n  */\npublic int getPortOffset();\n\n/**\n  * Set the number that offsets the server port used for shutdown commands.\n  * For example, if port is 8005, and you set portOffset to 1000,\n  * connector listens at 9005.\n  *\n  * @param portOffset sets the port offset\n  */\npublic void setPortOffset(int portOffset);\n\n/**\n  * Get the actual port on which server is listening for the shutdown commands.\n  * If you do not set port offset, port is returned. If you set\n  * port offset, port offset + port is returned.\n  *\n  * @return the port with offset\n  */\npublic int getPortWithOffset();\n\n/**\n  * @return the address on which we listen to for shutdown commands.\n  */\npublic String getAddress();\n\n\n/**\n  * Set the address on which we listen to for shutdown commands.\n  *\n  * @param address The new address\n  */\npublic void setAddress(String address);\n\n\n/**\n  * @return the shutdown command string we are waiting for.\n  */\npublic String getShutdown();\n\n\n/**\n  * Set the shutdown command we are waiting for.\n  *\n  * @param shutdown The new shutdown command\n  */\npublic void setShutdown(String shutdown);\n\n/**\n  * Get the utility thread count.\n  * @return the thread count\n  */\npublic int getUtilityThreads();\n\n\n/**\n  * Set the utility thread count.\n  * @param utilityThreads the new thread count\n  */\npublic void setUtilityThreads(int utilityThreads);\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br"),n("span",{staticClass:"line-number"},[s._v("64")]),n("br"),n("span",{staticClass:"line-number"},[s._v("65")]),n("br"),n("span",{staticClass:"line-number"},[s._v("66")]),n("br"),n("span",{staticClass:"line-number"},[s._v("67")]),n("br"),n("span",{staticClass:"line-number"},[s._v("68")]),n("br"),n("span",{staticClass:"line-number"},[s._v("69")]),n("br"),n("span",{staticClass:"line-number"},[s._v("70")]),n("br"),n("span",{staticClass:"line-number"},[s._v("71")]),n("br"),n("span",{staticClass:"line-number"},[s._v("72")]),n("br"),n("span",{staticClass:"line-number"},[s._v("73")]),n("br"),n("span",{staticClass:"line-number"},[s._v("74")]),n("br"),n("span",{staticClass:"line-number"},[s._v("75")]),n("br"),n("span",{staticClass:"line-number"},[s._v("76")]),n("br"),n("span",{staticClass:"line-number"},[s._v("77")]),n("br"),n("span",{staticClass:"line-number"},[s._v("78")]),n("br"),n("span",{staticClass:"line-number"},[s._v("79")]),n("br"),n("span",{staticClass:"line-number"},[s._v("80")]),n("br"),n("span",{staticClass:"line-number"},[s._v("81")]),n("br"),n("span",{staticClass:"line-number"},[s._v("82")]),n("br"),n("span",{staticClass:"line-number"},[s._v("83")]),n("br"),n("span",{staticClass:"line-number"},[s._v("84")]),n("br")])]),n("table",[n("thead",[n("tr",[n("th",[s._v("属性")]),s._v(" "),n("th",[s._v("描述")])])]),s._v(" "),n("tbody",[n("tr",[n("td",[s._v("className")]),s._v(" "),n("td",[s._v("使用的Java类名称。此类必须实现org.apache.catalina.Server接口。如果未指定类名，则将使用标准实现。")])]),s._v(" "),n("tr",[n("td",[s._v("address")]),s._v(" "),n("td",[s._v("该服务器等待关闭命令的TCP / IP地址。如果未指定地址，localhost则使用。")])]),s._v(" "),n("tr",[n("td",[s._v("port")]),s._v(" "),n("td",[s._v("该服务器等待关闭命令的TCP / IP端口号。设置为-1禁用关闭端口。注意：当使用Apache Commons Daemon启动Tomcat （在Windows上作为服务运行，或者在un * xes上使用jsvc运行）时，禁用关闭端口非常有效。但是，当使用标准shell脚本运行Tomcat时，不能使用它，因为它将阻止shutdown.bat")])]),s._v(" "),n("tr",[n("td",[s._v("portOffset")]),s._v(" "),n("td",[s._v("应用于port和嵌套到任何嵌套连接器的端口的偏移量。它必须是一个非负整数。如果未指定，0则使用默认值。")])]),s._v(" "),n("tr",[n("td",[s._v("shutdown")]),s._v(" "),n("td",[s._v("为了关闭Tomcat，必须通过与指定端口号的TCP / IP连接接收的命令字符串。")])]),s._v(" "),n("tr",[n("td",[s._v("utilityThreads")]),s._v(" "),n("td",[s._v("此service中用于各种实用程序任务（包括重复执行的线程）的线程数。特殊值0将导致使用该值 Runtime.getRuntime().availableProcessors()。Runtime.getRuntime().availableProcessors() + value除非小于1，否则将使用负值， 在这种情况下将使用1个线程。预设值是1。")])])])]),s._v(" "),n("ul",[n("li",[s._v("NamingResources")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("/**\n  * @return the global naming resources.\n  */\npublic NamingResourcesImpl getGlobalNamingResources();\n\n\n/**\n  * Set the global naming resources.\n  *\n  * @param globalNamingResources The new global naming resources\n  */\npublic void setGlobalNamingResources\n    (NamingResourcesImpl globalNamingResources);\n\n\n/**\n  * @return the global naming resources context.\n  */\npublic javax.naming.Context getGlobalNamingContext();\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br")])]),n("ul",[n("li",[s._v("Service相关， 包括添加Service， 查找Service，删除service等")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("/**\n  * Add a new Service to the set of defined Services.\n  *\n  * @param service The Service to be added\n  */\npublic void addService(Service service);\n\n\n/**\n  * Wait until a proper shutdown command is received, then return.\n  */\npublic void await();\n\n\n/**\n  * Find the specified Service\n  *\n  * @param name Name of the Service to be returned\n  * @return the specified Service, or <code>null</code> if none exists.\n  */\npublic Service findService(String name);\n\n\n/**\n  * @return the set of Services defined within this Server.\n  */\npublic Service[] findServices();\n\n\n/**\n  * Remove the specified Service from the set associated from this\n  * Server.\n  *\n  * @param service The Service to be removed\n  */\npublic void removeService(Service service);\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br")])]),n("h1",{attrs:{id:"standardserver的实现"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#standardserver的实现"}},[s._v("#")]),s._v(" StandardServer的实现")]),s._v(" "),n("hr"),s._v(" "),n("h3",{attrs:{id:"线程池"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#线程池"}},[s._v("#")]),s._v(" 线程池")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('// 此service中用于各种实用程序任务（包括重复执行的线程）的线程数\n@Override\npublic int getUtilityThreads() {\n    return utilityThreads;\n}\n\n\n/**\n  * 获取内部进程数计算逻辑：\n  * > 0时，即utilityThreads的值。\n  * <=0时，Runtime.getRuntime().availableProcessors() + result...\n  */\nprivate static int getUtilityThreadsInternal(int utilityThreads) {\n    int result = utilityThreads;\n    if (result <= 0) {\n        result = Runtime.getRuntime().availableProcessors() + result;\n        if (result < 2) {\n            result = 2;\n        }\n    }\n    return result;\n}\n\n\n@Override\npublic void setUtilityThreads(int utilityThreads) {\n    // Use local copies to ensure thread safety\n    int oldUtilityThreads = this.utilityThreads;\n    if (getUtilityThreadsInternal(utilityThreads) < getUtilityThreadsInternal(oldUtilityThreads)) {\n        return;\n    }\n    this.utilityThreads = utilityThreads;\n    if (oldUtilityThreads != utilityThreads && utilityExecutor != null) {\n        reconfigureUtilityExecutor(getUtilityThreadsInternal(utilityThreads));\n    }\n}\n\n// 线程池\nprivate synchronized void reconfigureUtilityExecutor(int threads) {\n    // The ScheduledThreadPoolExecutor doesn\'t use MaximumPoolSize, only CorePoolSize is available\n    if (utilityExecutor != null) {\n        utilityExecutor.setCorePoolSize(threads);\n    } else {\n        ScheduledThreadPoolExecutor scheduledThreadPoolExecutor =\n                new ScheduledThreadPoolExecutor(threads,\n                        new TaskThreadFactory("Catalina-utility-", utilityThreadsAsDaemon, Thread.MIN_PRIORITY));\n        scheduledThreadPoolExecutor.setKeepAliveTime(10, TimeUnit.SECONDS);\n        scheduledThreadPoolExecutor.setRemoveOnCancelPolicy(true);\n        scheduledThreadPoolExecutor.setExecuteExistingDelayedTasksAfterShutdownPolicy(false);\n        utilityExecutor = scheduledThreadPoolExecutor;\n        utilityExecutorWrapper = new org.apache.tomcat.util.threads.ScheduledThreadPoolExecutor(utilityExecutor);\n    }\n}\n\n\n/**\n  * Get if the utility threads are daemon threads.\n  * @return the threads daemon flag\n  */\npublic boolean getUtilityThreadsAsDaemon() {\n    return utilityThreadsAsDaemon;\n}\n\n\n/**\n  * Set the utility threads daemon flag. The default value is true.\n  * @param utilityThreadsAsDaemon the new thread daemon flag\n  */\npublic void setUtilityThreadsAsDaemon(boolean utilityThreadsAsDaemon) {\n    this.utilityThreadsAsDaemon = utilityThreadsAsDaemon;\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br"),n("span",{staticClass:"line-number"},[s._v("64")]),n("br"),n("span",{staticClass:"line-number"},[s._v("65")]),n("br"),n("span",{staticClass:"line-number"},[s._v("66")]),n("br"),n("span",{staticClass:"line-number"},[s._v("67")]),n("br"),n("span",{staticClass:"line-number"},[s._v("68")]),n("br"),n("span",{staticClass:"line-number"},[s._v("69")]),n("br"),n("span",{staticClass:"line-number"},[s._v("70")]),n("br"),n("span",{staticClass:"line-number"},[s._v("71")]),n("br")])]),n("h3",{attrs:{id:"service相关方法实现"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#service相关方法实现"}},[s._v("#")]),s._v(" Service相关方法实现")]),s._v(" "),n("p",[s._v("里面的方法都很简单。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('/**\n  * Add a new Service to the set of defined Services.\n  *\n  * @param service The Service to be added\n  */\n@Override\npublic void addService(Service service) {\n\n    service.setServer(this);\n\n    synchronized (servicesLock) {\n        Service results[] = new Service[services.length + 1];\n        System.arraycopy(services, 0, results, 0, services.length);\n        results[services.length] = service;\n        services = results;\n\n        if (getState().isAvailable()) {\n            try {\n                service.start();\n            } catch (LifecycleException e) {\n                // Ignore\n            }\n        }\n\n        // Report this property change to interested listeners\n        support.firePropertyChange("service", null, service);\n    }\n\n}\n\npublic void stopAwait() {\n    stopAwait=true;\n    Thread t = awaitThread;\n    if (t != null) {\n        ServerSocket s = awaitSocket;\n        if (s != null) {\n            awaitSocket = null;\n            try {\n                s.close();\n            } catch (IOException e) {\n                // Ignored\n            }\n        }\n        t.interrupt();\n        try {\n            t.join(1000);\n        } catch (InterruptedException e) {\n            // Ignored\n        }\n    }\n}\n\n/**\n  * Wait until a proper shutdown command is received, then return.\n  * This keeps the main thread alive - the thread pool listening for http\n  * connections is daemon threads.\n  */\n@Override\npublic void await() {\n    // Negative values - don\'t wait on port - tomcat is embedded or we just don\'t like ports\n    if (getPortWithOffset() == -2) {\n        // undocumented yet - for embedding apps that are around, alive.\n        return;\n    }\n    if (getPortWithOffset() == -1) {\n        try {\n            awaitThread = Thread.currentThread();\n            while(!stopAwait) {\n                try {\n                    Thread.sleep( 10000 );\n                } catch( InterruptedException ex ) {\n                    // continue and check the flag\n                }\n            }\n        } finally {\n            awaitThread = null;\n        }\n        return;\n    }\n\n    // Set up a server socket to wait on\n    try {\n        awaitSocket = new ServerSocket(getPortWithOffset(), 1,\n                InetAddress.getByName(address));\n    } catch (IOException e) {\n        log.error(sm.getString("standardServer.awaitSocket.fail", address,\n                String.valueOf(getPortWithOffset()), String.valueOf(getPort()),\n                String.valueOf(getPortOffset())), e);\n        return;\n    }\n\n    try {\n        awaitThread = Thread.currentThread();\n\n        // Loop waiting for a connection and a valid command\n        while (!stopAwait) {\n            ServerSocket serverSocket = awaitSocket;\n            if (serverSocket == null) {\n                break;\n            }\n\n            // Wait for the next connection\n            Socket socket = null;\n            StringBuilder command = new StringBuilder();\n            try {\n                InputStream stream;\n                long acceptStartTime = System.currentTimeMillis();\n                try {\n                    socket = serverSocket.accept();\n                    socket.setSoTimeout(10 * 1000);  // Ten seconds\n                    stream = socket.getInputStream();\n                } catch (SocketTimeoutException ste) {\n                    // This should never happen but bug 56684 suggests that\n                    // it does.\n                    log.warn(sm.getString("standardServer.accept.timeout",\n                            Long.valueOf(System.currentTimeMillis() - acceptStartTime)), ste);\n                    continue;\n                } catch (AccessControlException ace) {\n                    log.warn(sm.getString("standardServer.accept.security"), ace);\n                    continue;\n                } catch (IOException e) {\n                    if (stopAwait) {\n                        // Wait was aborted with socket.close()\n                        break;\n                    }\n                    log.error(sm.getString("standardServer.accept.error"), e);\n                    break;\n                }\n\n                // Read a set of characters from the socket\n                int expected = 1024; // Cut off to avoid DoS attack\n                while (expected < shutdown.length()) {\n                    if (random == null)\n                        random = new Random();\n                    expected += (random.nextInt() % 1024);\n                }\n                while (expected > 0) {\n                    int ch = -1;\n                    try {\n                        ch = stream.read();\n                    } catch (IOException e) {\n                        log.warn(sm.getString("standardServer.accept.readError"), e);\n                        ch = -1;\n                    }\n                    // Control character or EOF (-1) terminates loop\n                    if (ch < 32 || ch == 127) {\n                        break;\n                    }\n                    command.append((char) ch);\n                    expected--;\n                }\n            } finally {\n                // Close the socket now that we are done with it\n                try {\n                    if (socket != null) {\n                        socket.close();\n                    }\n                } catch (IOException e) {\n                    // Ignore\n                }\n            }\n\n            // Match against our command string\n            boolean match = command.toString().equals(shutdown);\n            if (match) {\n                log.info(sm.getString("standardServer.shutdownViaPort"));\n                break;\n            } else\n                log.warn(sm.getString("standardServer.invalidShutdownCommand", command.toString()));\n        }\n    } finally {\n        ServerSocket serverSocket = awaitSocket;\n        awaitThread = null;\n        awaitSocket = null;\n\n        // Close the server socket and return\n        if (serverSocket != null) {\n            try {\n                serverSocket.close();\n            } catch (IOException e) {\n                // Ignore\n            }\n        }\n    }\n}\n\n\n/**\n  * @return the specified Service (if it exists); otherwise return\n  * <code>null</code>.\n  *\n  * @param name Name of the Service to be returned\n  */\n@Override\npublic Service findService(String name) {\n    if (name == null) {\n        return null;\n    }\n    synchronized (servicesLock) {\n        for (Service service : services) {\n            if (name.equals(service.getName())) {\n                return service;\n            }\n        }\n    }\n    return null;\n}\n\n\n/**\n  * @return the set of Services defined within this Server.\n  */\n@Override\npublic Service[] findServices() {\n    return services;\n}\n\n/**\n  * @return the JMX service names.\n  */\npublic ObjectName[] getServiceNames() {\n    ObjectName onames[]=new ObjectName[ services.length ];\n    for( int i=0; i<services.length; i++ ) {\n        onames[i]=((StandardService)services[i]).getObjectName();\n    }\n    return onames;\n}\n\n\n/**\n  * Remove the specified Service from the set associated from this\n  * Server.\n  *\n  * @param service The Service to be removed\n  */\n@Override\npublic void removeService(Service service) {\n\n    synchronized (servicesLock) {\n        int j = -1;\n        for (int i = 0; i < services.length; i++) {\n            if (service == services[i]) {\n                j = i;\n                break;\n            }\n        }\n        if (j < 0)\n            return;\n        try {\n            services[j].stop();\n        } catch (LifecycleException e) {\n            // Ignore\n        }\n        int k = 0;\n        Service results[] = new Service[services.length - 1];\n        for (int i = 0; i < services.length; i++) {\n            if (i != j)\n                results[k++] = services[i];\n        }\n        services = results;\n\n        // Report this property change to interested listeners\n        support.firePropertyChange("service", service, null);\n    }\n\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br"),n("span",{staticClass:"line-number"},[s._v("64")]),n("br"),n("span",{staticClass:"line-number"},[s._v("65")]),n("br"),n("span",{staticClass:"line-number"},[s._v("66")]),n("br"),n("span",{staticClass:"line-number"},[s._v("67")]),n("br"),n("span",{staticClass:"line-number"},[s._v("68")]),n("br"),n("span",{staticClass:"line-number"},[s._v("69")]),n("br"),n("span",{staticClass:"line-number"},[s._v("70")]),n("br"),n("span",{staticClass:"line-number"},[s._v("71")]),n("br"),n("span",{staticClass:"line-number"},[s._v("72")]),n("br"),n("span",{staticClass:"line-number"},[s._v("73")]),n("br"),n("span",{staticClass:"line-number"},[s._v("74")]),n("br"),n("span",{staticClass:"line-number"},[s._v("75")]),n("br"),n("span",{staticClass:"line-number"},[s._v("76")]),n("br"),n("span",{staticClass:"line-number"},[s._v("77")]),n("br"),n("span",{staticClass:"line-number"},[s._v("78")]),n("br"),n("span",{staticClass:"line-number"},[s._v("79")]),n("br"),n("span",{staticClass:"line-number"},[s._v("80")]),n("br"),n("span",{staticClass:"line-number"},[s._v("81")]),n("br"),n("span",{staticClass:"line-number"},[s._v("82")]),n("br"),n("span",{staticClass:"line-number"},[s._v("83")]),n("br"),n("span",{staticClass:"line-number"},[s._v("84")]),n("br"),n("span",{staticClass:"line-number"},[s._v("85")]),n("br"),n("span",{staticClass:"line-number"},[s._v("86")]),n("br"),n("span",{staticClass:"line-number"},[s._v("87")]),n("br"),n("span",{staticClass:"line-number"},[s._v("88")]),n("br"),n("span",{staticClass:"line-number"},[s._v("89")]),n("br"),n("span",{staticClass:"line-number"},[s._v("90")]),n("br"),n("span",{staticClass:"line-number"},[s._v("91")]),n("br"),n("span",{staticClass:"line-number"},[s._v("92")]),n("br"),n("span",{staticClass:"line-number"},[s._v("93")]),n("br"),n("span",{staticClass:"line-number"},[s._v("94")]),n("br"),n("span",{staticClass:"line-number"},[s._v("95")]),n("br"),n("span",{staticClass:"line-number"},[s._v("96")]),n("br"),n("span",{staticClass:"line-number"},[s._v("97")]),n("br"),n("span",{staticClass:"line-number"},[s._v("98")]),n("br"),n("span",{staticClass:"line-number"},[s._v("99")]),n("br"),n("span",{staticClass:"line-number"},[s._v("100")]),n("br"),n("span",{staticClass:"line-number"},[s._v("101")]),n("br"),n("span",{staticClass:"line-number"},[s._v("102")]),n("br"),n("span",{staticClass:"line-number"},[s._v("103")]),n("br"),n("span",{staticClass:"line-number"},[s._v("104")]),n("br"),n("span",{staticClass:"line-number"},[s._v("105")]),n("br"),n("span",{staticClass:"line-number"},[s._v("106")]),n("br"),n("span",{staticClass:"line-number"},[s._v("107")]),n("br"),n("span",{staticClass:"line-number"},[s._v("108")]),n("br"),n("span",{staticClass:"line-number"},[s._v("109")]),n("br"),n("span",{staticClass:"line-number"},[s._v("110")]),n("br"),n("span",{staticClass:"line-number"},[s._v("111")]),n("br"),n("span",{staticClass:"line-number"},[s._v("112")]),n("br"),n("span",{staticClass:"line-number"},[s._v("113")]),n("br"),n("span",{staticClass:"line-number"},[s._v("114")]),n("br"),n("span",{staticClass:"line-number"},[s._v("115")]),n("br"),n("span",{staticClass:"line-number"},[s._v("116")]),n("br"),n("span",{staticClass:"line-number"},[s._v("117")]),n("br"),n("span",{staticClass:"line-number"},[s._v("118")]),n("br"),n("span",{staticClass:"line-number"},[s._v("119")]),n("br"),n("span",{staticClass:"line-number"},[s._v("120")]),n("br"),n("span",{staticClass:"line-number"},[s._v("121")]),n("br"),n("span",{staticClass:"line-number"},[s._v("122")]),n("br"),n("span",{staticClass:"line-number"},[s._v("123")]),n("br"),n("span",{staticClass:"line-number"},[s._v("124")]),n("br"),n("span",{staticClass:"line-number"},[s._v("125")]),n("br"),n("span",{staticClass:"line-number"},[s._v("126")]),n("br"),n("span",{staticClass:"line-number"},[s._v("127")]),n("br"),n("span",{staticClass:"line-number"},[s._v("128")]),n("br"),n("span",{staticClass:"line-number"},[s._v("129")]),n("br"),n("span",{staticClass:"line-number"},[s._v("130")]),n("br"),n("span",{staticClass:"line-number"},[s._v("131")]),n("br"),n("span",{staticClass:"line-number"},[s._v("132")]),n("br"),n("span",{staticClass:"line-number"},[s._v("133")]),n("br"),n("span",{staticClass:"line-number"},[s._v("134")]),n("br"),n("span",{staticClass:"line-number"},[s._v("135")]),n("br"),n("span",{staticClass:"line-number"},[s._v("136")]),n("br"),n("span",{staticClass:"line-number"},[s._v("137")]),n("br"),n("span",{staticClass:"line-number"},[s._v("138")]),n("br"),n("span",{staticClass:"line-number"},[s._v("139")]),n("br"),n("span",{staticClass:"line-number"},[s._v("140")]),n("br"),n("span",{staticClass:"line-number"},[s._v("141")]),n("br"),n("span",{staticClass:"line-number"},[s._v("142")]),n("br"),n("span",{staticClass:"line-number"},[s._v("143")]),n("br"),n("span",{staticClass:"line-number"},[s._v("144")]),n("br"),n("span",{staticClass:"line-number"},[s._v("145")]),n("br"),n("span",{staticClass:"line-number"},[s._v("146")]),n("br"),n("span",{staticClass:"line-number"},[s._v("147")]),n("br"),n("span",{staticClass:"line-number"},[s._v("148")]),n("br"),n("span",{staticClass:"line-number"},[s._v("149")]),n("br"),n("span",{staticClass:"line-number"},[s._v("150")]),n("br"),n("span",{staticClass:"line-number"},[s._v("151")]),n("br"),n("span",{staticClass:"line-number"},[s._v("152")]),n("br"),n("span",{staticClass:"line-number"},[s._v("153")]),n("br"),n("span",{staticClass:"line-number"},[s._v("154")]),n("br"),n("span",{staticClass:"line-number"},[s._v("155")]),n("br"),n("span",{staticClass:"line-number"},[s._v("156")]),n("br"),n("span",{staticClass:"line-number"},[s._v("157")]),n("br"),n("span",{staticClass:"line-number"},[s._v("158")]),n("br"),n("span",{staticClass:"line-number"},[s._v("159")]),n("br"),n("span",{staticClass:"line-number"},[s._v("160")]),n("br"),n("span",{staticClass:"line-number"},[s._v("161")]),n("br"),n("span",{staticClass:"line-number"},[s._v("162")]),n("br"),n("span",{staticClass:"line-number"},[s._v("163")]),n("br"),n("span",{staticClass:"line-number"},[s._v("164")]),n("br"),n("span",{staticClass:"line-number"},[s._v("165")]),n("br"),n("span",{staticClass:"line-number"},[s._v("166")]),n("br"),n("span",{staticClass:"line-number"},[s._v("167")]),n("br"),n("span",{staticClass:"line-number"},[s._v("168")]),n("br"),n("span",{staticClass:"line-number"},[s._v("169")]),n("br"),n("span",{staticClass:"line-number"},[s._v("170")]),n("br"),n("span",{staticClass:"line-number"},[s._v("171")]),n("br"),n("span",{staticClass:"line-number"},[s._v("172")]),n("br"),n("span",{staticClass:"line-number"},[s._v("173")]),n("br"),n("span",{staticClass:"line-number"},[s._v("174")]),n("br"),n("span",{staticClass:"line-number"},[s._v("175")]),n("br"),n("span",{staticClass:"line-number"},[s._v("176")]),n("br"),n("span",{staticClass:"line-number"},[s._v("177")]),n("br"),n("span",{staticClass:"line-number"},[s._v("178")]),n("br"),n("span",{staticClass:"line-number"},[s._v("179")]),n("br"),n("span",{staticClass:"line-number"},[s._v("180")]),n("br"),n("span",{staticClass:"line-number"},[s._v("181")]),n("br"),n("span",{staticClass:"line-number"},[s._v("182")]),n("br"),n("span",{staticClass:"line-number"},[s._v("183")]),n("br"),n("span",{staticClass:"line-number"},[s._v("184")]),n("br"),n("span",{staticClass:"line-number"},[s._v("185")]),n("br"),n("span",{staticClass:"line-number"},[s._v("186")]),n("br"),n("span",{staticClass:"line-number"},[s._v("187")]),n("br"),n("span",{staticClass:"line-number"},[s._v("188")]),n("br"),n("span",{staticClass:"line-number"},[s._v("189")]),n("br"),n("span",{staticClass:"line-number"},[s._v("190")]),n("br"),n("span",{staticClass:"line-number"},[s._v("191")]),n("br"),n("span",{staticClass:"line-number"},[s._v("192")]),n("br"),n("span",{staticClass:"line-number"},[s._v("193")]),n("br"),n("span",{staticClass:"line-number"},[s._v("194")]),n("br"),n("span",{staticClass:"line-number"},[s._v("195")]),n("br"),n("span",{staticClass:"line-number"},[s._v("196")]),n("br"),n("span",{staticClass:"line-number"},[s._v("197")]),n("br"),n("span",{staticClass:"line-number"},[s._v("198")]),n("br"),n("span",{staticClass:"line-number"},[s._v("199")]),n("br"),n("span",{staticClass:"line-number"},[s._v("200")]),n("br"),n("span",{staticClass:"line-number"},[s._v("201")]),n("br"),n("span",{staticClass:"line-number"},[s._v("202")]),n("br"),n("span",{staticClass:"line-number"},[s._v("203")]),n("br"),n("span",{staticClass:"line-number"},[s._v("204")]),n("br"),n("span",{staticClass:"line-number"},[s._v("205")]),n("br"),n("span",{staticClass:"line-number"},[s._v("206")]),n("br"),n("span",{staticClass:"line-number"},[s._v("207")]),n("br"),n("span",{staticClass:"line-number"},[s._v("208")]),n("br"),n("span",{staticClass:"line-number"},[s._v("209")]),n("br"),n("span",{staticClass:"line-number"},[s._v("210")]),n("br"),n("span",{staticClass:"line-number"},[s._v("211")]),n("br"),n("span",{staticClass:"line-number"},[s._v("212")]),n("br"),n("span",{staticClass:"line-number"},[s._v("213")]),n("br"),n("span",{staticClass:"line-number"},[s._v("214")]),n("br"),n("span",{staticClass:"line-number"},[s._v("215")]),n("br"),n("span",{staticClass:"line-number"},[s._v("216")]),n("br"),n("span",{staticClass:"line-number"},[s._v("217")]),n("br"),n("span",{staticClass:"line-number"},[s._v("218")]),n("br"),n("span",{staticClass:"line-number"},[s._v("219")]),n("br"),n("span",{staticClass:"line-number"},[s._v("220")]),n("br"),n("span",{staticClass:"line-number"},[s._v("221")]),n("br"),n("span",{staticClass:"line-number"},[s._v("222")]),n("br"),n("span",{staticClass:"line-number"},[s._v("223")]),n("br"),n("span",{staticClass:"line-number"},[s._v("224")]),n("br"),n("span",{staticClass:"line-number"},[s._v("225")]),n("br"),n("span",{staticClass:"line-number"},[s._v("226")]),n("br"),n("span",{staticClass:"line-number"},[s._v("227")]),n("br"),n("span",{staticClass:"line-number"},[s._v("228")]),n("br"),n("span",{staticClass:"line-number"},[s._v("229")]),n("br"),n("span",{staticClass:"line-number"},[s._v("230")]),n("br"),n("span",{staticClass:"line-number"},[s._v("231")]),n("br"),n("span",{staticClass:"line-number"},[s._v("232")]),n("br"),n("span",{staticClass:"line-number"},[s._v("233")]),n("br"),n("span",{staticClass:"line-number"},[s._v("234")]),n("br"),n("span",{staticClass:"line-number"},[s._v("235")]),n("br"),n("span",{staticClass:"line-number"},[s._v("236")]),n("br"),n("span",{staticClass:"line-number"},[s._v("237")]),n("br"),n("span",{staticClass:"line-number"},[s._v("238")]),n("br"),n("span",{staticClass:"line-number"},[s._v("239")]),n("br"),n("span",{staticClass:"line-number"},[s._v("240")]),n("br"),n("span",{staticClass:"line-number"},[s._v("241")]),n("br"),n("span",{staticClass:"line-number"},[s._v("242")]),n("br"),n("span",{staticClass:"line-number"},[s._v("243")]),n("br"),n("span",{staticClass:"line-number"},[s._v("244")]),n("br"),n("span",{staticClass:"line-number"},[s._v("245")]),n("br"),n("span",{staticClass:"line-number"},[s._v("246")]),n("br"),n("span",{staticClass:"line-number"},[s._v("247")]),n("br"),n("span",{staticClass:"line-number"},[s._v("248")]),n("br"),n("span",{staticClass:"line-number"},[s._v("249")]),n("br"),n("span",{staticClass:"line-number"},[s._v("250")]),n("br"),n("span",{staticClass:"line-number"},[s._v("251")]),n("br"),n("span",{staticClass:"line-number"},[s._v("252")]),n("br"),n("span",{staticClass:"line-number"},[s._v("253")]),n("br"),n("span",{staticClass:"line-number"},[s._v("254")]),n("br"),n("span",{staticClass:"line-number"},[s._v("255")]),n("br"),n("span",{staticClass:"line-number"},[s._v("256")]),n("br"),n("span",{staticClass:"line-number"},[s._v("257")]),n("br"),n("span",{staticClass:"line-number"},[s._v("258")]),n("br"),n("span",{staticClass:"line-number"},[s._v("259")]),n("br"),n("span",{staticClass:"line-number"},[s._v("260")]),n("br"),n("span",{staticClass:"line-number"},[s._v("261")]),n("br"),n("span",{staticClass:"line-number"},[s._v("262")]),n("br"),n("span",{staticClass:"line-number"},[s._v("263")]),n("br"),n("span",{staticClass:"line-number"},[s._v("264")]),n("br"),n("span",{staticClass:"line-number"},[s._v("265")]),n("br"),n("span",{staticClass:"line-number"},[s._v("266")]),n("br")])]),n("h3",{attrs:{id:"lifecycle相关模板方法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#lifecycle相关模板方法"}},[s._v("#")]),s._v(" Lifecycle相关模板方法")]),s._v(" "),n("p",[s._v("这里只展示startInternal方法")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('/**\n * Start nested components ({@link Service}s) and implement the requirements\n * of {@link org.apache.catalina.util.LifecycleBase#startInternal()}.\n *\n * @exception LifecycleException if this component detects a fatal error\n *  that prevents this component from being used\n */\n@Override\nprotected void startInternal() throws LifecycleException {\n\n    fireLifecycleEvent(CONFIGURE_START_EVENT, null);\n    setState(LifecycleState.STARTING);\n\n    globalNamingResources.start();\n\n    // Start our defined Services\n    synchronized (servicesLock) {\n        for (int i = 0; i < services.length; i++) {\n            services[i].start();\n        }\n    }\n\n    if (periodicEventDelay > 0) {\n        monitorFuture = getUtilityExecutor().scheduleWithFixedDelay(\n                new Runnable() {\n                    @Override\n                    public void run() {\n                        startPeriodicLifecycleEvent();\n                    }\n                }, 0, 60, TimeUnit.SECONDS);\n    }\n}\n    \nprotected void startPeriodicLifecycleEvent() {\n    if (periodicLifecycleEventFuture == null || (periodicLifecycleEventFuture != null && periodicLifecycleEventFuture.isDone())) {\n        if (periodicLifecycleEventFuture != null && periodicLifecycleEventFuture.isDone()) {\n            // There was an error executing the scheduled task, get it and log it\n            try {\n                periodicLifecycleEventFuture.get();\n            } catch (InterruptedException | ExecutionException e) {\n                log.error(sm.getString("standardServer.periodicEventError"), e);\n            }\n        }\n        periodicLifecycleEventFuture = getUtilityExecutor().scheduleAtFixedRate(\n                new Runnable() {\n                    @Override\n                    public void run() {\n                        fireLifecycleEvent(Lifecycle.PERIODIC_EVENT, null);\n                    }\n                }, periodicEventDelay, periodicEventDelay, TimeUnit.SECONDS);\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br")])]),n("p",[s._v("方法的第一行代码先触发 CONFIGURE_START_EVENT 事件，以便执行 StandardServer 的 LifecycleListener 监听器，然后调用 setState 方法设置成 LifecycleBase 的 state 属性为 LifecycleState.STARTING。 接着就 globalNamingResources.start()，跟 initInternal 方法其实是类似的。")]),s._v(" "),n("p",[s._v("再接着就调用 Service 的 start 方法来启动 Service 组件。可以看出，StandardServe 的 startInternal 跟 initInternal 方法类似，都是调用内部的 service 组件的相关方法。")]),s._v(" "),n("p",[s._v("调用完 service.init 方法后，就使用 getUtilityExecutor() 返回的线程池延迟执行startPeriodicLifecycleEvent 方法，而在 startPeriodicLifecycleEvent 方法里，也是使用 getUtilityExecutor() 方法，定期执行 fireLifecycleEvent 方法，处理 Lifecycle.PERIODIC_EVENT 事件，如果有需要定期处理的，可以再 Server 的 LifecycleListener 里处理 Lifecycle.PERIODIC_EVENT 事件。")]),s._v(" "),n("h1",{attrs:{id:"参考文章"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#参考文章"}},[s._v("#")]),s._v(" 参考文章")]),s._v(" "),n("hr"),s._v(" "),n("p",[s._v("https://segmentfault.com/a/1190000022016991)")])])}),[],!1,null,null,null);n.default=t.exports}}]);