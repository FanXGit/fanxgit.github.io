(window.webpackJsonp=window.webpackJsonp||[]).push([[486],{3394:function(n,s,e){n.exports=e.p+"assets/img/tomcat-x-service-1.e7c30e2d.jpg"},4207:function(n,s,e){"use strict";e.r(s);var a=e(7),t=Object(a.a)({},(function(){var n=this,s=n._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":n.$parent.slotKey}},[s("h1",{attrs:{id:"tomcat-service的设计和实现-standardservice"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#tomcat-service的设计和实现-standardservice"}},[n._v("#")]),n._v(" Tomcat - Service的设计和实现: StandardService")]),n._v(" "),s("p",[n._v("==================================================================================")]),n._v(" "),s("blockquote",[s("p",[n._v("上文讲了Server的具体实现了，本文主要讲Service的设计和实现；我们从上文其实已经知道Server中包含多个service了。@pdai")])]),n._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"#tomcat---service%E7%9A%84%E8%AE%BE%E8%AE%A1%E5%92%8C%E5%AE%9E%E7%8E%B0-standardservice"}},[n._v("Tomcat - Service的设计和实现: StandardService")]),n._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"#%E7%90%86%E8%A7%A3%E6%80%9D%E8%B7%AF"}},[n._v("理解思路")])]),n._v(" "),s("li",[s("a",{attrs:{href:"#service%E7%BB%93%E6%9E%84%E8%AE%BE%E8%AE%A1"}},[n._v("Service结构设计")]),n._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"#serverxml"}},[n._v("server.xml")])]),n._v(" "),s("li",[s("a",{attrs:{href:"#service%E4%B8%AD%E7%9A%84%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1"}},[n._v("Service中的接口设计")])])])]),n._v(" "),s("li",[s("a",{attrs:{href:"#standardservice%E7%9A%84%E5%AE%9E%E7%8E%B0"}},[n._v("StandardService的实现")]),n._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"#engine%E7%9B%B8%E5%85%B3"}},[n._v("Engine相关")])]),n._v(" "),s("li",[s("a",{attrs:{href:"#connectors%E7%9B%B8%E5%85%B3"}},[n._v("Connectors相关")])]),n._v(" "),s("li",[s("a",{attrs:{href:"#executor%E7%9B%B8%E5%85%B3"}},[n._v("Executor相关")])]),n._v(" "),s("li",[s("a",{attrs:{href:"#lifecycle%E7%9B%B8%E5%85%B3%E6%A8%A1%E6%9D%BF%E6%96%B9%E6%B3%95"}},[n._v("Lifecycle相关模板方法")])]),n._v(" "),s("li",[s("a",{attrs:{href:"#%E8%A1%A5%E5%85%85%E4%B8%8Bmapperlistener"}},[n._v("补充下MapperListener")])])])]),n._v(" "),s("li",[s("a",{attrs:{href:"#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"}},[n._v("参考文章")])])])])]),n._v(" "),s("h1",{attrs:{id:"理解思路"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#理解思路"}},[n._v("#")]),n._v(" 理解思路")]),n._v(" "),s("hr"),n._v(" "),s("ul",[s("li",[s("strong",[n._v("第一：类比StandardServer, 抓住StandardService整体类依赖结构来理解")])])]),n._v(" "),s("p",[s("img",{attrs:{src:e(3394),alt:""}})]),n._v(" "),s("ul",[s("li",[s("strong",[n._v("第二：结合server.xml中service配置来理解")])])]),n._v(" "),s("p",[n._v("见下文具体阐述。")]),n._v(" "),s("ul",[s("li",[s("strong",[n._v("第三：结合Service Config官方配置文档")])])]),n._v(" "),s("p",[n._v("http://tomcat.apache.org/tomcat-9.0-doc/config/service.html")]),n._v(" "),s("h1",{attrs:{id:"service结构设计"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#service结构设计"}},[n._v("#")]),n._v(" Service结构设计")]),n._v(" "),s("hr"),n._v(" "),s("blockquote",[s("p",[n._v("我们需要从高一点的维度去理解service的结构设计，而不是多少方法多少代码；这里的理解一定是要结合Server.xml中service配置部分对应理解。@pdai")])]),n._v(" "),s("h3",{attrs:{id:"server-xml"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#server-xml"}},[n._v("#")]),n._v(" server.xml")]),n._v(" "),s("ul",[s("li",[n._v("首先要看下server.xml中Service的配置，这样你便知道了需要了解的4个部分")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v('\x3c!--\n    每个Service元素只能有一个Engine元素.元素处理在同一个<Service>中所有<Connector>元素接收到的客户请求\n--\x3e\n\n<Service name="Catalina">\n\x3c!-- 1. 属性说明\n\tname:Service的名称\n--\x3e\n\n    \x3c!--2. 一个或多个excecutors --\x3e\n    \x3c!--\n    <Executor name="tomcatThreadPool" namePrefix="catalina-exec-"\n        maxThreads="150" minSpareThreads="4"/>\n    --\x3e\n\n    \x3c!--\n\t\t3.Connector元素:\n\t\t\t由Connector接口定义.<Connector>元素代表与客户程序实际交互的组件,它负责接收客户请求,以及向客户返回响应结果.\n    --\x3e\n    <Connector port="80" maxHttpHeaderSize="8192"\n               maxThreads="150" minSpareThreads="25" maxSpareThreads="75"\n               enableLookups="false" redirectPort="8443" acceptCount="100"\n               connectionTimeout="20000" disableUploadTimeout="true" />\n    \x3c!-- 属性说明\n\t\tport:服务器连接器的端口号,该连接器将在指定端口侦听来自客户端的请求。\n\t\tenableLookups:如果为true，则可以通过调用request.getRemoteHost()进行DNS查询来得到远程客户端的实际主机名；\n\t\t\t\t\t若为false则不进行DNS查询，而是返回其ip地址。\n\t\tredirectPort:服务器正在处理http请求时收到了一个SSL传输请求后重定向的端口号。\n\t\tacceptCount:当所有可以使用的处理请求的线程都被用光时,可以放到处理队列中的请求数,超过这个数的请求将不予处理，而返回Connection refused错误。\n\t\tconnectionTimeout:等待超时的时间数（以毫秒为单位）。\n\t\tmaxThreads:设定在监听端口的线程的最大数目,这个值也决定了服务器可以同时响应客户请求的最大数目.默认值为200。\n\t\tprotocol:必须设定为AJP/1.3协议。\n\t\taddress:如果服务器有两个以上IP地址,该属性可以设定端口监听的IP地址,默认情况下,端口会监听服务器上所有IP地址。\n\t\tminProcessors:服务器启动时创建的处理请求的线程数，每个请求由一个线程负责。\n\t\tmaxProcessors:最多可以创建的处理请求的线程数。\n\t\tminSpareThreads:最小备用线程 。\n\t\tmaxSpareThreads:最大备用线程。\n\t\tdebug:日志等级。\n\t\tdisableUploadTimeout:禁用上传超时,主要用于大数据上传时。\n    --\x3e\n\n\n    <Connector port="8009" enableLookups="false" redirectPort="8443" protocol="AJP/1.3" />\n    \x3c!-- 负责和其他HTTP服务器建立连接。在把Tomcat与其他HTTP服务器集成时就需要用到这个连接器。 --\x3e\n\t\n    \x3c!--\n\t\t4. Engine\n    --\x3e\n    <Engine name="Catalina" defaultHost="localhost">\n    \n    </Engine>\n  </Service>\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br"),s("span",{staticClass:"line-number"},[n._v("24")]),s("br"),s("span",{staticClass:"line-number"},[n._v("25")]),s("br"),s("span",{staticClass:"line-number"},[n._v("26")]),s("br"),s("span",{staticClass:"line-number"},[n._v("27")]),s("br"),s("span",{staticClass:"line-number"},[n._v("28")]),s("br"),s("span",{staticClass:"line-number"},[n._v("29")]),s("br"),s("span",{staticClass:"line-number"},[n._v("30")]),s("br"),s("span",{staticClass:"line-number"},[n._v("31")]),s("br"),s("span",{staticClass:"line-number"},[n._v("32")]),s("br"),s("span",{staticClass:"line-number"},[n._v("33")]),s("br"),s("span",{staticClass:"line-number"},[n._v("34")]),s("br"),s("span",{staticClass:"line-number"},[n._v("35")]),s("br"),s("span",{staticClass:"line-number"},[n._v("36")]),s("br"),s("span",{staticClass:"line-number"},[n._v("37")]),s("br"),s("span",{staticClass:"line-number"},[n._v("38")]),s("br"),s("span",{staticClass:"line-number"},[n._v("39")]),s("br"),s("span",{staticClass:"line-number"},[n._v("40")]),s("br"),s("span",{staticClass:"line-number"},[n._v("41")]),s("br"),s("span",{staticClass:"line-number"},[n._v("42")]),s("br"),s("span",{staticClass:"line-number"},[n._v("43")]),s("br"),s("span",{staticClass:"line-number"},[n._v("44")]),s("br"),s("span",{staticClass:"line-number"},[n._v("45")]),s("br"),s("span",{staticClass:"line-number"},[n._v("46")]),s("br"),s("span",{staticClass:"line-number"},[n._v("47")]),s("br"),s("span",{staticClass:"line-number"},[n._v("48")]),s("br"),s("span",{staticClass:"line-number"},[n._v("49")]),s("br"),s("span",{staticClass:"line-number"},[n._v("50")]),s("br"),s("span",{staticClass:"line-number"},[n._v("51")]),s("br"),s("span",{staticClass:"line-number"},[n._v("52")]),s("br")])]),s("h3",{attrs:{id:"service中的接口设计"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#service中的接口设计"}},[n._v("#")]),n._v(" Service中的接口设计")]),n._v(" "),s("ul",[s("li",[s("strong",[n._v("公共属性")]),n._v(", name等")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("/**\n  * @return the name of this Service.\n  */\npublic String getName();\n\n/**\n  * Set the name of this Service.\n  *\n  * @param name The new service name\n  */\npublic void setName(String name);\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br")])]),s("ul",[s("li",[n._v("父Server相关")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("/**\n  * @return the <code>Server</code> with which we are associated (if any).\n  */\npublic Server getServer();\n\n/**\n  * Set the <code>Server</code> with which we are associated (if any).\n  *\n  * @param server The server that owns this Service\n  */\npublic void setServer(Server server);\n\n/**\n  * @return the parent class loader for this component. If not set, return\n  * {@link #getServer()} {@link Server#getParentClassLoader()}. If no server\n  * has been set, return the system class loader.\n  */\npublic ClassLoader getParentClassLoader();\n\n/**\n  * Set the parent class loader for this service.\n  *\n  * @param parent The new parent class loader\n  */\npublic void setParentClassLoader(ClassLoader parent);\n\n/**\n  * @return the domain under which this container will be / has been\n  * registered.\n  */\npublic String getDomain();\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br"),s("span",{staticClass:"line-number"},[n._v("24")]),s("br"),s("span",{staticClass:"line-number"},[n._v("25")]),s("br"),s("span",{staticClass:"line-number"},[n._v("26")]),s("br"),s("span",{staticClass:"line-number"},[n._v("27")]),s("br"),s("span",{staticClass:"line-number"},[n._v("28")]),s("br"),s("span",{staticClass:"line-number"},[n._v("29")]),s("br"),s("span",{staticClass:"line-number"},[n._v("30")]),s("br"),s("span",{staticClass:"line-number"},[n._v("31")]),s("br")])]),s("ul",[s("li",[n._v("Connector相关")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("/**\n  * Add a new Connector to the set of defined Connectors, and associate it\n  * with this Service's Container.\n  *\n  * @param connector The Connector to be added\n  */\npublic void addConnector(Connector connector);\n\n/**\n  * Find and return the set of Connectors associated with this Service.\n  *\n  * @return the set of associated Connectors\n  */\npublic Connector[] findConnectors();\n\n/**\n  * Remove the specified Connector from the set associated from this\n  * Service.  The removed Connector will also be disassociated from our\n  * Container.\n  *\n  * @param connector The Connector to be removed\n  */\npublic void removeConnector(Connector connector);\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br")])]),s("ul",[s("li",[n._v("Engine")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("/**\n  * @return the <code>Engine</code> that handles requests for all\n  * <code>Connectors</code> associated with this Service.\n  */\npublic Engine getContainer();\n\n/**\n  * Set the <code>Engine</code> that handles requests for all\n  * <code>Connectors</code> associated with this Service.\n  *\n  * @param engine The new Engine\n  */\npublic void setContainer(Engine engine);\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br")])]),s("ul",[s("li",[n._v("Excutor相关")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("/**\n  * Adds a named executor to the service\n  * @param ex Executor\n  */\npublic void addExecutor(Executor ex);\n\n/**\n  * Retrieves all executors\n  * @return Executor[]\n  */\npublic Executor[] findExecutors();\n\n/**\n  * Retrieves executor by name, null if not found\n  * @param name String\n  * @return Executor\n  */\npublic Executor getExecutor(String name);\n\n/**\n  * Removes an executor from the service\n  * @param ex Executor\n  */\npublic void removeExecutor(Executor ex);\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br"),s("span",{staticClass:"line-number"},[n._v("24")]),s("br")])]),s("h1",{attrs:{id:"standardservice的实现"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#standardservice的实现"}},[n._v("#")]),n._v(" StandardService的实现")]),n._v(" "),s("hr"),n._v(" "),s("p",[n._v("属性和父Server相关比较简单，这里主要看下其它的方法：")]),n._v(" "),s("h3",{attrs:{id:"engine相关"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#engine相关"}},[n._v("#")]),n._v(" Engine相关")]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v('\nprivate Engine engine = null;\n\n@Override\npublic Engine getContainer() {\n    return engine;\n}\n\n@Override\npublic void setContainer(Engine engine) {\n    Engine oldEngine = this.engine;\n    if (oldEngine != null) {\n        oldEngine.setService(null);\n    }\n    this.engine = engine;\n    if (this.engine != null) {\n        this.engine.setService(this);\n    }\n    if (getState().isAvailable()) {\n        if (this.engine != null) {\n            try {\n                this.engine.start(); // 启动Engine\n            } catch (LifecycleException e) {\n                log.error(sm.getString("standardService.engine.startFailed"), e);\n            }\n        }\n        // 重启Mapper - Restart MapperListener to pick up new engine.\n        try {\n            mapperListener.stop();\n        } catch (LifecycleException e) {\n            log.error(sm.getString("standardService.mapperListener.stopFailed"), e);\n        }\n        try {\n            mapperListener.start();\n        } catch (LifecycleException e) {\n            log.error(sm.getString("standardService.mapperListener.startFailed"), e);\n        }\n        if (oldEngine != null) {\n            try {\n                oldEngine.stop();\n            } catch (LifecycleException e) {\n                log.error(sm.getString("standardService.engine.stopFailed"), e);\n            }\n        }\n    }\n\n    // 触发container属性变更事件\n    support.firePropertyChange("container", oldEngine, this.engine);\n}\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br"),s("span",{staticClass:"line-number"},[n._v("24")]),s("br"),s("span",{staticClass:"line-number"},[n._v("25")]),s("br"),s("span",{staticClass:"line-number"},[n._v("26")]),s("br"),s("span",{staticClass:"line-number"},[n._v("27")]),s("br"),s("span",{staticClass:"line-number"},[n._v("28")]),s("br"),s("span",{staticClass:"line-number"},[n._v("29")]),s("br"),s("span",{staticClass:"line-number"},[n._v("30")]),s("br"),s("span",{staticClass:"line-number"},[n._v("31")]),s("br"),s("span",{staticClass:"line-number"},[n._v("32")]),s("br"),s("span",{staticClass:"line-number"},[n._v("33")]),s("br"),s("span",{staticClass:"line-number"},[n._v("34")]),s("br"),s("span",{staticClass:"line-number"},[n._v("35")]),s("br"),s("span",{staticClass:"line-number"},[n._v("36")]),s("br"),s("span",{staticClass:"line-number"},[n._v("37")]),s("br"),s("span",{staticClass:"line-number"},[n._v("38")]),s("br"),s("span",{staticClass:"line-number"},[n._v("39")]),s("br"),s("span",{staticClass:"line-number"},[n._v("40")]),s("br"),s("span",{staticClass:"line-number"},[n._v("41")]),s("br"),s("span",{staticClass:"line-number"},[n._v("42")]),s("br"),s("span",{staticClass:"line-number"},[n._v("43")]),s("br"),s("span",{staticClass:"line-number"},[n._v("44")]),s("br"),s("span",{staticClass:"line-number"},[n._v("45")]),s("br"),s("span",{staticClass:"line-number"},[n._v("46")]),s("br"),s("span",{staticClass:"line-number"},[n._v("47")]),s("br"),s("span",{staticClass:"line-number"},[n._v("48")]),s("br"),s("span",{staticClass:"line-number"},[n._v("49")]),s("br")])]),s("h3",{attrs:{id:"connectors相关"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#connectors相关"}},[n._v("#")]),n._v(" Connectors相关")]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v('/**\n  * The set of Connectors associated with this Service.\n  */\nprotected Connector connectors[] = new Connector[0];\nprivate final Object connectorsLock = new Object();\n\n/**\n  * Add a new Connector to the set of defined Connectors, and associate it\n  * with this Service\'s Container.\n  *\n  * @param connector The Connector to be added\n  */\n@Override\npublic void addConnector(Connector connector) {\n\n    synchronized (connectorsLock) {\n        connector.setService(this);\n        Connector results[] = new Connector[connectors.length + 1];\n        System.arraycopy(connectors, 0, results, 0, connectors.length);\n        results[connectors.length] = connector;\n        connectors = results;\n    }\n\n    try {\n        if (getState().isAvailable()) {\n            connector.start();\n        }\n    } catch (LifecycleException e) {\n        throw new IllegalArgumentException(\n                sm.getString("standardService.connector.startFailed", connector), e);\n    }\n\n    // Report this property change to interested listeners\n    support.firePropertyChange("connector", null, connector);\n}\n\n\npublic ObjectName[] getConnectorNames() {\n    ObjectName results[] = new ObjectName[connectors.length];\n    for (int i=0; i<results.length; i++) {\n        results[i] = connectors[i].getObjectName();\n    }\n    return results;\n}\n\n/**\n  * 当前Service相关的所有Connectors.\n  */\n@Override\npublic Connector[] findConnectors() {\n    return connectors;\n}\n\n/**\n  * 删除connector\n  *\n  * @param connector The Connector to be removed\n  */\n@Override\npublic void removeConnector(Connector connector) {\n\n    synchronized (connectorsLock) {\n        // 找到conector位置\n        int j = -1;\n        for (int i = 0; i < connectors.length; i++) {\n            if (connector == connectors[i]) {\n                j = i;\n                break;\n            }\n        }\n        if (j < 0)\n            return;\n        if (connectors[j].getState().isAvailable()) {\n            try {\n                connectors[j].stop(); // 停止\n            } catch (LifecycleException e) {\n                log.error(sm.getString(\n                        "standardService.connector.stopFailed",\n                        connectors[j]), e);\n            }\n        }\n        connector.setService(null); // 去除父service绑定\n        int k = 0;\n        Connector results[] = new Connector[connectors.length - 1];\n        for (int i = 0; i < connectors.length; i++) {\n            if (i != j)\n                results[k++] = connectors[i]; // 后续connector向前移位\n        }\n        connectors = results;\n\n        // 触发connector属性变更事件\n        support.firePropertyChange("connector", connector, null);\n    }\n}\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br"),s("span",{staticClass:"line-number"},[n._v("24")]),s("br"),s("span",{staticClass:"line-number"},[n._v("25")]),s("br"),s("span",{staticClass:"line-number"},[n._v("26")]),s("br"),s("span",{staticClass:"line-number"},[n._v("27")]),s("br"),s("span",{staticClass:"line-number"},[n._v("28")]),s("br"),s("span",{staticClass:"line-number"},[n._v("29")]),s("br"),s("span",{staticClass:"line-number"},[n._v("30")]),s("br"),s("span",{staticClass:"line-number"},[n._v("31")]),s("br"),s("span",{staticClass:"line-number"},[n._v("32")]),s("br"),s("span",{staticClass:"line-number"},[n._v("33")]),s("br"),s("span",{staticClass:"line-number"},[n._v("34")]),s("br"),s("span",{staticClass:"line-number"},[n._v("35")]),s("br"),s("span",{staticClass:"line-number"},[n._v("36")]),s("br"),s("span",{staticClass:"line-number"},[n._v("37")]),s("br"),s("span",{staticClass:"line-number"},[n._v("38")]),s("br"),s("span",{staticClass:"line-number"},[n._v("39")]),s("br"),s("span",{staticClass:"line-number"},[n._v("40")]),s("br"),s("span",{staticClass:"line-number"},[n._v("41")]),s("br"),s("span",{staticClass:"line-number"},[n._v("42")]),s("br"),s("span",{staticClass:"line-number"},[n._v("43")]),s("br"),s("span",{staticClass:"line-number"},[n._v("44")]),s("br"),s("span",{staticClass:"line-number"},[n._v("45")]),s("br"),s("span",{staticClass:"line-number"},[n._v("46")]),s("br"),s("span",{staticClass:"line-number"},[n._v("47")]),s("br"),s("span",{staticClass:"line-number"},[n._v("48")]),s("br"),s("span",{staticClass:"line-number"},[n._v("49")]),s("br"),s("span",{staticClass:"line-number"},[n._v("50")]),s("br"),s("span",{staticClass:"line-number"},[n._v("51")]),s("br"),s("span",{staticClass:"line-number"},[n._v("52")]),s("br"),s("span",{staticClass:"line-number"},[n._v("53")]),s("br"),s("span",{staticClass:"line-number"},[n._v("54")]),s("br"),s("span",{staticClass:"line-number"},[n._v("55")]),s("br"),s("span",{staticClass:"line-number"},[n._v("56")]),s("br"),s("span",{staticClass:"line-number"},[n._v("57")]),s("br"),s("span",{staticClass:"line-number"},[n._v("58")]),s("br"),s("span",{staticClass:"line-number"},[n._v("59")]),s("br"),s("span",{staticClass:"line-number"},[n._v("60")]),s("br"),s("span",{staticClass:"line-number"},[n._v("61")]),s("br"),s("span",{staticClass:"line-number"},[n._v("62")]),s("br"),s("span",{staticClass:"line-number"},[n._v("63")]),s("br"),s("span",{staticClass:"line-number"},[n._v("64")]),s("br"),s("span",{staticClass:"line-number"},[n._v("65")]),s("br"),s("span",{staticClass:"line-number"},[n._v("66")]),s("br"),s("span",{staticClass:"line-number"},[n._v("67")]),s("br"),s("span",{staticClass:"line-number"},[n._v("68")]),s("br"),s("span",{staticClass:"line-number"},[n._v("69")]),s("br"),s("span",{staticClass:"line-number"},[n._v("70")]),s("br"),s("span",{staticClass:"line-number"},[n._v("71")]),s("br"),s("span",{staticClass:"line-number"},[n._v("72")]),s("br"),s("span",{staticClass:"line-number"},[n._v("73")]),s("br"),s("span",{staticClass:"line-number"},[n._v("74")]),s("br"),s("span",{staticClass:"line-number"},[n._v("75")]),s("br"),s("span",{staticClass:"line-number"},[n._v("76")]),s("br"),s("span",{staticClass:"line-number"},[n._v("77")]),s("br"),s("span",{staticClass:"line-number"},[n._v("78")]),s("br"),s("span",{staticClass:"line-number"},[n._v("79")]),s("br"),s("span",{staticClass:"line-number"},[n._v("80")]),s("br"),s("span",{staticClass:"line-number"},[n._v("81")]),s("br"),s("span",{staticClass:"line-number"},[n._v("82")]),s("br"),s("span",{staticClass:"line-number"},[n._v("83")]),s("br"),s("span",{staticClass:"line-number"},[n._v("84")]),s("br"),s("span",{staticClass:"line-number"},[n._v("85")]),s("br"),s("span",{staticClass:"line-number"},[n._v("86")]),s("br"),s("span",{staticClass:"line-number"},[n._v("87")]),s("br"),s("span",{staticClass:"line-number"},[n._v("88")]),s("br"),s("span",{staticClass:"line-number"},[n._v("89")]),s("br"),s("span",{staticClass:"line-number"},[n._v("90")]),s("br"),s("span",{staticClass:"line-number"},[n._v("91")]),s("br"),s("span",{staticClass:"line-number"},[n._v("92")]),s("br"),s("span",{staticClass:"line-number"},[n._v("93")]),s("br"),s("span",{staticClass:"line-number"},[n._v("94")]),s("br")])]),s("h3",{attrs:{id:"executor相关"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#executor相关"}},[n._v("#")]),n._v(" Executor相关")]),n._v(" "),s("p",[n._v("CRUD方法，代码比较简单")]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v('/**\n  * Adds a named executor to the service\n  * @param ex Executor\n  */\n@Override\npublic void addExecutor(Executor ex) {\n    synchronized (executors) {\n        if (!executors.contains(ex)) {\n            executors.add(ex);\n            if (getState().isAvailable()) {\n                try {\n                    ex.start(); // 启动\n                } catch (LifecycleException x) {\n                    log.error(sm.getString("standardService.executor.start"), x);\n                }\n            }\n        }\n    }\n}\n\n/**\n  * Retrieves all executors\n  * @return Executor[]\n  */\n@Override\npublic Executor[] findExecutors() {\n    synchronized (executors) {\n        Executor[] arr = new Executor[executors.size()];\n        executors.toArray(arr);\n        return arr;\n    }\n}\n\n\n/**\n  * Retrieves executor by name, null if not found\n  * @param executorName String\n  * @return Executor\n  */\n@Override\npublic Executor getExecutor(String executorName) {\n    synchronized (executors) {\n        for (Executor executor: executors) {\n            if (executorName.equals(executor.getName()))\n                return executor;\n        }\n    }\n    return null;\n}\n\n/**\n  * Removes an executor from the service\n  * @param ex Executor\n  */\n@Override\npublic void removeExecutor(Executor ex) {\n    synchronized (executors) {\n        if ( executors.remove(ex) && getState().isAvailable() ) {\n            try {\n                ex.stop(); // 停止\n            } catch (LifecycleException e) {\n                log.error(sm.getString("standardService.executor.stop"), e);\n            }\n        }\n    }\n}\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br"),s("span",{staticClass:"line-number"},[n._v("24")]),s("br"),s("span",{staticClass:"line-number"},[n._v("25")]),s("br"),s("span",{staticClass:"line-number"},[n._v("26")]),s("br"),s("span",{staticClass:"line-number"},[n._v("27")]),s("br"),s("span",{staticClass:"line-number"},[n._v("28")]),s("br"),s("span",{staticClass:"line-number"},[n._v("29")]),s("br"),s("span",{staticClass:"line-number"},[n._v("30")]),s("br"),s("span",{staticClass:"line-number"},[n._v("31")]),s("br"),s("span",{staticClass:"line-number"},[n._v("32")]),s("br"),s("span",{staticClass:"line-number"},[n._v("33")]),s("br"),s("span",{staticClass:"line-number"},[n._v("34")]),s("br"),s("span",{staticClass:"line-number"},[n._v("35")]),s("br"),s("span",{staticClass:"line-number"},[n._v("36")]),s("br"),s("span",{staticClass:"line-number"},[n._v("37")]),s("br"),s("span",{staticClass:"line-number"},[n._v("38")]),s("br"),s("span",{staticClass:"line-number"},[n._v("39")]),s("br"),s("span",{staticClass:"line-number"},[n._v("40")]),s("br"),s("span",{staticClass:"line-number"},[n._v("41")]),s("br"),s("span",{staticClass:"line-number"},[n._v("42")]),s("br"),s("span",{staticClass:"line-number"},[n._v("43")]),s("br"),s("span",{staticClass:"line-number"},[n._v("44")]),s("br"),s("span",{staticClass:"line-number"},[n._v("45")]),s("br"),s("span",{staticClass:"line-number"},[n._v("46")]),s("br"),s("span",{staticClass:"line-number"},[n._v("47")]),s("br"),s("span",{staticClass:"line-number"},[n._v("48")]),s("br"),s("span",{staticClass:"line-number"},[n._v("49")]),s("br"),s("span",{staticClass:"line-number"},[n._v("50")]),s("br"),s("span",{staticClass:"line-number"},[n._v("51")]),s("br"),s("span",{staticClass:"line-number"},[n._v("52")]),s("br"),s("span",{staticClass:"line-number"},[n._v("53")]),s("br"),s("span",{staticClass:"line-number"},[n._v("54")]),s("br"),s("span",{staticClass:"line-number"},[n._v("55")]),s("br"),s("span",{staticClass:"line-number"},[n._v("56")]),s("br"),s("span",{staticClass:"line-number"},[n._v("57")]),s("br"),s("span",{staticClass:"line-number"},[n._v("58")]),s("br"),s("span",{staticClass:"line-number"},[n._v("59")]),s("br"),s("span",{staticClass:"line-number"},[n._v("60")]),s("br"),s("span",{staticClass:"line-number"},[n._v("61")]),s("br"),s("span",{staticClass:"line-number"},[n._v("62")]),s("br"),s("span",{staticClass:"line-number"},[n._v("63")]),s("br"),s("span",{staticClass:"line-number"},[n._v("64")]),s("br"),s("span",{staticClass:"line-number"},[n._v("65")]),s("br"),s("span",{staticClass:"line-number"},[n._v("66")]),s("br")])]),s("h3",{attrs:{id:"lifecycle相关模板方法"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#lifecycle相关模板方法"}},[n._v("#")]),n._v(" Lifecycle相关模板方法")]),n._v(" "),s("p",[n._v("首先看 "),s("strong",[n._v("initInternal")]),n._v(" 方法")]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("/**\n * Invoke a pre-startup initialization. This is used to allow connectors\n * to bind to restricted ports under Unix operating environments.\n */\n@Override\nprotected void initInternal() throws LifecycleException {\n\n    super.initInternal();\n\n    if (engine != null) {\n        engine.init();\n    }\n\n    // Initialize any Executors\n    for (Executor executor : findExecutors()) {\n        if (executor instanceof JmxEnabled) {\n            ((JmxEnabled) executor).setDomain(getDomain());\n        }\n        executor.init();\n    }\n\n    // Initialize mapper listener\n    mapperListener.init();\n\n    // Initialize our defined Connectors\n    synchronized (connectorsLock) {\n        for (Connector connector : connectors) {\n            connector.init();\n        }\n    }\n}\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br"),s("span",{staticClass:"line-number"},[n._v("24")]),s("br"),s("span",{staticClass:"line-number"},[n._v("25")]),s("br"),s("span",{staticClass:"line-number"},[n._v("26")]),s("br"),s("span",{staticClass:"line-number"},[n._v("27")]),s("br"),s("span",{staticClass:"line-number"},[n._v("28")]),s("br"),s("span",{staticClass:"line-number"},[n._v("29")]),s("br"),s("span",{staticClass:"line-number"},[n._v("30")]),s("br"),s("span",{staticClass:"line-number"},[n._v("31")]),s("br")])]),s("p",[n._v("initInternal 代码很短，思路也很清晰，就是依次调用了这个成员变量的 init 方法")]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("engine.init() \nexecutor.init \nmapperListener.init()\nconnector.init()\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br")])]),s("p",[s("strong",[n._v("startInternal 方法")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v('/**\n * Start nested components ({@link Executor}s, {@link Connector}s and\n * {@link Container}s) and implement the requirements of\n * {@link org.apache.catalina.util.LifecycleBase#startInternal()}.\n *\n * @exception LifecycleException if this component detects a fatal error\n *  that prevents this component from being used\n */\n@Override\nprotected void startInternal() throws LifecycleException {\n\n    if(log.isInfoEnabled())\n        log.info(sm.getString("standardService.start.name", this.name));\n    setState(LifecycleState.STARTING);\n\n    // Start our defined Container first\n    if (engine != null) {\n        synchronized (engine) {\n            engine.start();\n        }\n    }\n\n    synchronized (executors) {\n        for (Executor executor: executors) {\n            executor.start();\n        }\n    }\n\n    mapperListener.start();\n\n    // Start our defined Connectors second\n    synchronized (connectorsLock) {\n        for (Connector connector: connectors) {\n            // If it has already failed, don\'t try and start it\n            if (connector.getState() != LifecycleState.FAILED) {\n                connector.start();\n            }\n        }\n    }\n}\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br"),s("span",{staticClass:"line-number"},[n._v("24")]),s("br"),s("span",{staticClass:"line-number"},[n._v("25")]),s("br"),s("span",{staticClass:"line-number"},[n._v("26")]),s("br"),s("span",{staticClass:"line-number"},[n._v("27")]),s("br"),s("span",{staticClass:"line-number"},[n._v("28")]),s("br"),s("span",{staticClass:"line-number"},[n._v("29")]),s("br"),s("span",{staticClass:"line-number"},[n._v("30")]),s("br"),s("span",{staticClass:"line-number"},[n._v("31")]),s("br"),s("span",{staticClass:"line-number"},[n._v("32")]),s("br"),s("span",{staticClass:"line-number"},[n._v("33")]),s("br"),s("span",{staticClass:"line-number"},[n._v("34")]),s("br"),s("span",{staticClass:"line-number"},[n._v("35")]),s("br"),s("span",{staticClass:"line-number"},[n._v("36")]),s("br"),s("span",{staticClass:"line-number"},[n._v("37")]),s("br"),s("span",{staticClass:"line-number"},[n._v("38")]),s("br"),s("span",{staticClass:"line-number"},[n._v("39")]),s("br"),s("span",{staticClass:"line-number"},[n._v("40")]),s("br")])]),s("p",[n._v("startInternal 跟 initInternal 方法一样，也是依次调用")]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("engine.start();\nexecutor.start();\nmapperListener.start();\nconnector.start();\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br")])]),s("h3",{attrs:{id:"补充下mapperlistener"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#补充下mapperlistener"}},[n._v("#")]),n._v(" 补充下MapperListener")]),n._v(" "),s("p",[n._v("mapperListener 的作用是在 start 的时候将容器类对象注册到 Mapper 对象中。")]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("/**\n * Create mapper listener.\n *\n * @param service The service this listener is associated with\n */\npublic MapperListener(Service service) {\n    this.service = service;\n    this.mapper = service.getMapper();\n}\nservice.getMapper() 返回的是 StandardService 对象的 mapper 成员变量。\n\n/**\n * Mapper.\n */\nprotected final Mapper mapper = new Mapper();\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br")])]),s("p",[n._v("Mapper是 Tomcat 处理 Http 请求时非常重要的组件。Tomcat 使用 Mapper 来处理一个 Request 到 Host、Context 的映射关系，从而决定使用哪个 Service 来处理请求。")]),n._v(" "),s("p",[n._v("MapperListener 也是继承自 LifecycleMBeanBase，不过没有重载 initInternal 方法。")]),n._v(" "),s("ul",[s("li",[n._v("startInternal 方法")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("@Override\npublic void startInternal() throws LifecycleException {\n\n    setState(LifecycleState.STARTING);\n\n    Engine engine = service.getContainer();\n    if (engine == null) {\n        return;\n    }\n\n    findDefaultHost();\n\n    addListeners(engine);\n\n    Container[] conHosts = engine.findChildren();\n    for (Container conHost : conHosts) {\n        Host host = (Host) conHost;\n        if (!LifecycleState.NEW.equals(host.getState())) {\n            // Registering the host will register the context and wrappers\n            registerHost(host);\n        }\n    }\n}\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br")])]),s("ul",[s("li",[n._v("findDefaultHost() 方法")])]),n._v(" "),s("p",[n._v("首先看 findDefaultHost() 方法")]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v('private void findDefaultHost() {\n\n    Engine engine = service.getContainer();\n    String defaultHost = engine.getDefaultHost();\n\n    boolean found = false;\n\n    if (defaultHost != null && defaultHost.length() > 0) {\n        Container[] containers = engine.findChildren();\n\n        for (Container container : containers) {\n            Host host = (Host) container;\n            if (defaultHost.equalsIgnoreCase(host.getName())) {\n                found = true;\n                break;\n            }\n\n            String[] aliases = host.findAliases();\n            for (String alias : aliases) {\n                if (defaultHost.equalsIgnoreCase(alias)) {\n                    found = true;\n                    break;\n                }\n            }\n        }\n    }\n\n    if (found) {\n        mapper.setDefaultHostName(defaultHost);\n    } else {\n        log.error(sm.getString("mapperListener.unknownDefaultHost", defaultHost, service));\n    }\n}\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br"),s("span",{staticClass:"line-number"},[n._v("24")]),s("br"),s("span",{staticClass:"line-number"},[n._v("25")]),s("br"),s("span",{staticClass:"line-number"},[n._v("26")]),s("br"),s("span",{staticClass:"line-number"},[n._v("27")]),s("br"),s("span",{staticClass:"line-number"},[n._v("28")]),s("br"),s("span",{staticClass:"line-number"},[n._v("29")]),s("br"),s("span",{staticClass:"line-number"},[n._v("30")]),s("br"),s("span",{staticClass:"line-number"},[n._v("31")]),s("br"),s("span",{staticClass:"line-number"},[n._v("32")]),s("br"),s("span",{staticClass:"line-number"},[n._v("33")]),s("br")])]),s("p",[n._v("findDefaultHost() 是主要是找出 defaultHost ，并调用 "),s("code",[n._v("mapper.setDefaultHostName(defaultHost);")]),n._v(" 这个 defaultHost 是 server.xml 的 "),s("code",[n._v("<Engine>")]),n._v(' 标签的属性，一般都是 "localHost"。')]),n._v(" "),s("p",[n._v("从上面代码 for 代码块里可以看出，Host 是 Engine 的子 Container。for 语句就是找出一个名字跟 defaultHost 指定的名字相同的 Host 对象。")]),n._v(" "),s("ul",[s("li",[n._v("addListeners(engine) 方法")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("/**\n * Add this mapper to the container and all child containers\n *\n * @param container\n */\nprivate void addListeners(Container container) {\n    container.addContainerListener(this);\n    container.addLifecycleListener(this);\n    for (Container child : container.findChildren()) {\n        addListeners(child);\n    }\n}\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br")])]),s("p",[n._v("这个方法的作用是，将 MapperListener 这个监听器添加到 Engine 及其子容器中")]),n._v(" "),s("ul",[s("li",[n._v("registerHost 调用 registerHost方法来注册 Engine 的字容器 Host。")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v('/**\n * Register host.\n */\nprivate void registerHost(Host host) {\n\n    String[] aliases = host.findAliases();\n    mapper.addHost(host.getName(), aliases, host);\n\n    for (Container container : host.findChildren()) {\n        if (container.getState().isAvailable()) {\n            registerContext((Context) container);\n        }\n    }\n\n    // Default host may have changed\n    findDefaultHost();\n\n    if(log.isDebugEnabled()) {\n        log.debug(sm.getString("mapperListener.registerHost",\n                host.getName(), domain, service));\n    }\n}\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br")])]),s("p",[n._v("registerHost 方法先调用 mapper.addHost，然后调用 registerContext 方法注册 Host 的子容器 Context。 mapper.addHost 方法是将 Host 加入的 Mapper 类的的成员变量MappedHost[] hosts 中。")]),n._v(" "),s("p",[n._v("接着看 registerContext 方法")]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v('/**\n * Register context.\n */\nprivate void registerContext(Context context) {\n\n    String contextPath = context.getPath();\n    if ("/".equals(contextPath)) {\n        contextPath = "";\n    }\n    Host host = (Host)context.getParent();\n\n    WebResourceRoot resources = context.getResources();\n    String[] welcomeFiles = context.findWelcomeFiles();\n    List<WrapperMappingInfo> wrappers = new ArrayList<>();\n\n    for (Container container : context.findChildren()) {\n        prepareWrapperMappingInfo(context, (Wrapper) container, wrappers);\n\n        if(log.isDebugEnabled()) {\n            log.debug(sm.getString("mapperListener.registerWrapper",\n                    container.getName(), contextPath, service));\n        }\n    }\n\n    mapper.addContextVersion(host.getName(), host, contextPath,\n            context.getWebappVersion(), context, welcomeFiles, resources,\n            wrappers);\n\n    if(log.isDebugEnabled()) {\n        log.debug(sm.getString("mapperListener.registerContext",\n                contextPath, service));\n    }\n}\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br"),s("span",{staticClass:"line-number"},[n._v("24")]),s("br"),s("span",{staticClass:"line-number"},[n._v("25")]),s("br"),s("span",{staticClass:"line-number"},[n._v("26")]),s("br"),s("span",{staticClass:"line-number"},[n._v("27")]),s("br"),s("span",{staticClass:"line-number"},[n._v("28")]),s("br"),s("span",{staticClass:"line-number"},[n._v("29")]),s("br"),s("span",{staticClass:"line-number"},[n._v("30")]),s("br"),s("span",{staticClass:"line-number"},[n._v("31")]),s("br"),s("span",{staticClass:"line-number"},[n._v("32")]),s("br"),s("span",{staticClass:"line-number"},[n._v("33")]),s("br")])]),s("p",[n._v("registerContext 里先获取一些对象，比如 WebResourceRoot 对象、WrapperMappingInfo 对象，然后调用 mapper.addContextVersion。")]),n._v(" "),s("p",[n._v("Mapper#addContextVersion 方法比较琐细，就不细讲了。")]),n._v(" "),s("p",[n._v("其主要逻辑是将 Context 对象，以及 Context 的子容器 Wrapper 对象，每一个都分别构建一个对应的 MappedContext 和 MappedWrapper 对象，")]),n._v(" "),s("p",[n._v("然后把 MappedContext 和 MappedWrapper 塞进 ContextVersion 对象中，")]),n._v(" "),s("p",[n._v("最后把 Context 和 ContextVersion 的对应关系放在 Mapper 对象的一个 Map 里。")]),n._v(" "),s("p",[n._v("这里的 MappedContext 和 MappedWrapper 在 Tomcat 处理 Http 请求的时候是比较关键的。")]),n._v(" "),s("p",[n._v("registerHost 最后再更新了一下可能发生改变里的的 defaultHost。")]),n._v(" "),s("h1",{attrs:{id:"参考文章"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#参考文章"}},[n._v("#")]),n._v(" 参考文章")]),n._v(" "),s("hr"),n._v(" "),s("p",[n._v("https://segmentfault.com/a/1190000022026318)")])])}),[],!1,null,null,null);s.default=t.exports}}]);