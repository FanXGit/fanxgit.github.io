(window.webpackJsonp=window.webpackJsonp||[]).push([[78],{2463:function(s,a,n){s.exports=n.p+"assets/img/es-usage-1.7f6ecdc8.png"},2464:function(s,a,n){s.exports=n.p+"assets/img/es-usage-2.7994ff85.png"},2465:function(s,a,n){s.exports=n.p+"assets/img/es-usage-3.5510f415.png"},2466:function(s,a,n){s.exports=n.p+"assets/img/es-usage-4.d18a68d0.png"},2467:function(s,a,n){s.exports=n.p+"assets/img/es-usage-5.2b049cd3.png"},2468:function(s,a,n){s.exports=n.p+"assets/img/es-usage-6.ff663e38.png"},2469:function(s,a,n){s.exports=n.p+"assets/img/es-usage-7.fa097470.png"},2470:function(s,a,n){s.exports=n.p+"assets/img/es-usage-8.58bc7907.png"},2471:function(s,a,n){s.exports=n.p+"assets/img/es-usage-9.db6e05f9.png"},2472:function(s,a,n){s.exports=n.p+"assets/img/es-usage-10.e82bd49e.png"},2473:function(s,a,n){s.exports=n.p+"assets/img/es-usage-11.a849b9b4.png"},2474:function(s,a,n){s.exports=n.p+"assets/img/es-usage-12.723136ff.png"},3937:function(s,a,n){"use strict";n.r(a);var e=n(7),t=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"es详解-入门-查询和聚合的基础使用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#es详解-入门-查询和聚合的基础使用"}},[s._v("#")]),s._v(" ES详解 - 入门：查询和聚合的基础使用")]),s._v(" "),a("p",[s._v("=============================================")]),s._v(" "),a("blockquote",[a("p",[s._v("安装完ElasticSearch 和 Kibana后，为了快速上手，我们通过官网GitHub提供的一个数据进行入门学习，主要包括"),a("strong",[s._v("查询数据")]),s._v("和"),a("strong",[s._v("聚合数据")]),s._v("。@pdai")])]),s._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#es%E8%AF%A6%E8%A7%A3---%E5%85%A5%E9%97%A8%E6%9F%A5%E8%AF%A2%E5%92%8C%E8%81%9A%E5%90%88%E7%9A%84%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8"}},[s._v("ES详解 - 入门：查询和聚合的基础使用")]),s._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#%E5%85%A5%E9%97%A8%E4%BB%8E%E7%B4%A2%E5%BC%95%E6%96%87%E6%A1%A3%E5%BC%80%E5%A7%8B"}},[s._v("入门：从索引文档开始")])]),s._v(" "),a("li",[a("a",{attrs:{href:"#%E5%AD%A6%E4%B9%A0%E5%87%86%E5%A4%87%E6%89%B9%E9%87%8F%E7%B4%A2%E5%BC%95%E6%96%87%E6%A1%A3"}},[s._v("学习准备：批量索引文档")])]),s._v(" "),a("li",[a("a",{attrs:{href:"#%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE"}},[s._v("查询数据")]),s._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#%E6%9F%A5%E8%AF%A2%E6%89%80%E6%9C%89"}},[s._v("查询所有")])]),s._v(" "),a("li",[a("a",{attrs:{href:"#%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2fromsize"}},[s._v("分页查询(from+size)")])]),s._v(" "),a("li",[a("a",{attrs:{href:"#%E6%8C%87%E5%AE%9A%E5%AD%97%E6%AE%B5%E6%9F%A5%E8%AF%A2match"}},[s._v("指定字段查询：match")])]),s._v(" "),a("li",[a("a",{attrs:{href:"#%E6%9F%A5%E8%AF%A2%E6%AE%B5%E8%90%BD%E5%8C%B9%E9%85%8Dmatch_phrase"}},[s._v("查询段落匹配：match_phrase")])]),s._v(" "),a("li",[a("a",{attrs:{href:"#%E5%A4%9A%E6%9D%A1%E4%BB%B6%E6%9F%A5%E8%AF%A2-bool"}},[s._v("多条件查询: bool")])]),s._v(" "),a("li",[a("a",{attrs:{href:"#%E6%9F%A5%E8%AF%A2%E6%9D%A1%E4%BB%B6query-or-filter"}},[s._v("查询条件：query or filter")])])])]),s._v(" "),a("li",[a("a",{attrs:{href:"#%E8%81%9A%E5%90%88%E6%9F%A5%E8%AF%A2aggregation"}},[s._v("聚合查询：Aggregation")]),s._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#%E7%AE%80%E5%8D%95%E8%81%9A%E5%90%88"}},[s._v("简单聚合")])]),s._v(" "),a("li",[a("a",{attrs:{href:"#%E5%B5%8C%E5%A5%97%E8%81%9A%E5%90%88"}},[s._v("嵌套聚合")])]),s._v(" "),a("li",[a("a",{attrs:{href:"#%E5%AF%B9%E8%81%9A%E5%90%88%E7%BB%93%E6%9E%9C%E6%8E%92%E5%BA%8F"}},[s._v("对聚合结果排序")])])])])])])]),s._v(" "),a("h1",{attrs:{id:"入门-从索引文档开始"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#入门-从索引文档开始"}},[s._v("#")]),s._v(" 入门：从索引文档开始")]),s._v(" "),a("hr"),s._v(" "),a("ul",[a("li",[s._v("索引一个文档")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('PUT /customer/_doc/1\n{\n  "name": "John Doe"\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("为了方便测试，我们使用kibana的dev tool来进行学习测试：")]),s._v(" "),a("p",[a("img",{attrs:{src:n(2463),alt:""}})]),s._v(" "),a("p",[s._v("查询刚才插入的文档")]),s._v(" "),a("p",[a("img",{attrs:{src:n(2464),alt:""}})]),s._v(" "),a("h1",{attrs:{id:"学习准备-批量索引文档"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#学习准备-批量索引文档"}},[s._v("#")]),s._v(" 学习准备：批量索引文档")]),s._v(" "),a("hr"),s._v(" "),a("blockquote",[a("p",[s._v("ES 还提供了批量操作，比如这里我们可以使用批量操作来插入一些数据，供我们在后面学习使用。")])]),s._v(" "),a("p",[s._v("使用批量来批处理文档操作比单独提交请求要快得多，因为它减少了网络往返。")]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("下载测试数据")])])]),s._v(" "),a("p",[s._v("数据是index为bank，accounts.json "),a("a",{attrs:{href:"https://github.com/elastic/elasticsearch/blob/v6.8.18/docs/src/test/resources/accounts.json",target:"_blank",rel:"noopener noreferrer"}},[s._v("下载地址 在新窗口打开"),a("OutboundLink")],1),s._v("（如果你无法下载，也可以clone ES的"),a("a",{attrs:{href:"https://github.com/elastic/elasticsearch",target:"_blank",rel:"noopener noreferrer"}},[s._v("官方仓库 在新窗口打开"),a("OutboundLink")],1),s._v("，选择本文中使用的版本分支，然后进入/docs/src/test/resources/accounts.json目录获取）")]),s._v(" "),a("p",[s._v("数据的格式如下")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('{\n  "account_number": 0,\n  "balance": 16623,\n  "firstname": "Bradshaw",\n  "lastname": "Mckenzie",\n  "age": 29,\n  "gender": "F",\n  "address": "244 Columbus Place",\n  "employer": "Euron",\n  "email": "bradshawmckenzie@euron.com",\n  "city": "Hobucken",\n  "state": "CO"\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("ul",[a("li",[a("strong",[s._v("批量插入数据")])])]),s._v(" "),a("p",[s._v("将accounts.json拷贝至指定目录，我这里放在"),a("code",[s._v("/opt/")]),s._v("下面,")]),s._v(" "),a("p",[s._v("然后执行")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('curl -H "Content-Type: application/json" -XPOST "localhost:9200/bank/_bulk?pretty&refresh" --data-binary "@/opt/accounts.json"\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ul",[a("li",[a("strong",[s._v("查看状态")])])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('[elasticsearch@pdai-centos root]$ curl "localhost:9200/_cat/indices?v=true" | grep bank\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n100  1524  100  1524    0     0   119k      0 --:--:-- --:--:-- --:--:--  124k\nyellow open   bank                            yq3eSlAWRMO2Td0Sl769rQ   1   1       1000            0    379.2kb        379.2kb\n[elasticsearch@pdai-centos root]$\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("h1",{attrs:{id:"查询数据"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#查询数据"}},[s._v("#")]),s._v(" 查询数据")]),s._v(" "),a("hr"),s._v(" "),a("blockquote",[a("p",[s._v("我们通过kibana来进行查询测试。")])]),s._v(" "),a("h3",{attrs:{id:"查询所有"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#查询所有"}},[s._v("#")]),s._v(" 查询所有")]),s._v(" "),a("p",[a("code",[s._v("match_all")]),s._v("表示查询所有的数据，"),a("code",[s._v("sort")]),s._v("即按照什么字段排序")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('GET /bank/_search\n{\n  "query": { "match_all": {} },\n  "sort": [\n    { "account_number": "asc" }\n  ]\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("结果")]),s._v(" "),a("p",[a("img",{attrs:{src:n(2465),alt:""}})]),s._v(" "),a("p",[s._v("相关字段解释")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("took")]),s._v(" – Elasticsearch运行查询所花费的时间（以毫秒为单位）")]),s._v(" "),a("li",[a("code",[s._v("timed_out")]),s._v(" –搜索请求是否超时")]),s._v(" "),a("li",[a("code",[s._v("_shards")]),s._v(" - 搜索了多少个碎片，以及成功，失败或跳过了多少个碎片的细目分类。")]),s._v(" "),a("li",[a("code",[s._v("max_score")]),s._v(" – 找到的最相关文档的分数")]),s._v(" "),a("li",[a("code",[s._v("hits.total.value")]),s._v(" - 找到了多少个匹配的文档")]),s._v(" "),a("li",[a("code",[s._v("hits.sort")]),s._v(" - 文档的排序位置（不按相关性得分排序时）")]),s._v(" "),a("li",[a("code",[s._v("hits._score")]),s._v(" - 文档的相关性得分（使用match_all时不适用）")])]),s._v(" "),a("h3",{attrs:{id:"分页查询-from-size"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#分页查询-from-size"}},[s._v("#")]),s._v(" 分页查询(from+size)")]),s._v(" "),a("p",[s._v("本质上就是from和size两个字段")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('GET /bank/_search\n{\n  "query": { "match_all": {} },\n  "sort": [\n    { "account_number": "asc" }\n  ],\n  "from": 10,\n  "size": 10\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("p",[s._v("结果")]),s._v(" "),a("p",[a("img",{attrs:{src:n(2466),alt:""}})]),s._v(" "),a("h3",{attrs:{id:"指定字段查询-match"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#指定字段查询-match"}},[s._v("#")]),s._v(" 指定字段查询：match")]),s._v(" "),a("p",[s._v("如果要在字段中搜索特定字词，可以使用"),a("code",[s._v("match")]),s._v("; 如下语句将查询address 字段中包含 mill 或者 lane的数据")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('GET /bank/_search\n{\n  "query": { "match": { "address": "mill lane" } }\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("结果")]),s._v(" "),a("p",[a("img",{attrs:{src:n(2467),alt:""}})]),s._v(" "),a("p",[s._v("（由于ES底层是按照分词索引的，所以上述查询结果是address 字段中包含 mill 或者 lane的数据）")]),s._v(" "),a("h3",{attrs:{id:"查询段落匹配-match-phrase"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#查询段落匹配-match-phrase"}},[s._v("#")]),s._v(" 查询段落匹配：match_phrase")]),s._v(" "),a("p",[s._v('如果我们希望查询的条件是 address字段中包含 "mill lane"，则可以使用'),a("code",[s._v("match_phrase")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('GET /bank/_search\n{\n  "query": { "match_phrase": { "address": "mill lane" } }\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("结果")]),s._v(" "),a("p",[a("img",{attrs:{src:n(2468),alt:""}})]),s._v(" "),a("h3",{attrs:{id:"多条件查询-bool"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#多条件查询-bool"}},[s._v("#")]),s._v(" 多条件查询: bool")]),s._v(" "),a("p",[s._v("如果要构造更复杂的查询，可以使用"),a("code",[s._v("bool")]),s._v("查询来组合多个查询条件。")]),s._v(" "),a("p",[s._v("例如，以下请求在bank索引中搜索40岁客户的帐户，但不包括居住在爱达荷州（ID）的任何人")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('GET /bank/_search\n{\n  "query": {\n    "bool": {\n      "must": [\n        { "match": { "age": "40" } }\n      ],\n      "must_not": [\n        { "match": { "state": "ID" } }\n      ]\n    }\n  }\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("p",[s._v("结果")]),s._v(" "),a("p",[a("img",{attrs:{src:n(2469),alt:""}})]),s._v(" "),a("p",[a("code",[s._v("must")]),s._v(", "),a("code",[s._v("should")]),s._v(", "),a("code",[s._v("must_not")]),s._v(" 和 "),a("code",[s._v("filter")]),s._v(" 都是"),a("code",[s._v("bool")]),s._v("查询的子句。那么"),a("code",[s._v("filter")]),s._v("和上述"),a("code",[s._v("query")]),s._v("子句有啥区别呢？")]),s._v(" "),a("h3",{attrs:{id:"查询条件-query-or-filter"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#查询条件-query-or-filter"}},[s._v("#")]),s._v(" 查询条件：query or filter")]),s._v(" "),a("p",[s._v("先看下如下查询, 在"),a("code",[s._v("bool")]),s._v("查询的子句中同时具备query/must 和 filter")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('GET /bank/_search\n{\n  "query": {\n    "bool": {\n      "must": [\n        {\n          "match": {\n            "state": "ND"\n          }\n        }\n      ],\n      "filter": [\n        {\n          "term": {\n            "age": "40"\n          }\n        },\n        {\n          "range": {\n            "balance": {\n              "gte": 20000,\n              "lte": 30000\n            }\n          }\n        }\n      ]\n    }\n  }\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br")])]),a("p",[s._v("结果")]),s._v(" "),a("p",[a("img",{attrs:{src:n(2470),alt:""}})]),s._v(" "),a("p",[s._v("两者都可以写查询条件，而且语法也类似。区别在于，"),a("strong",[s._v("query 上下文的条件是用来给文档打分的，匹配越好 _score 越高；filter 的条件只产生两种结果：符合与不符合，后者被过滤掉")]),s._v("。")]),s._v(" "),a("p",[s._v("所以，我们进一步看只包含filter的查询")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('GET /bank/_search\n{\n  "query": {\n    "bool": {\n      "filter": [\n        {\n          "term": {\n            "age": "40"\n          }\n        },\n        {\n          "range": {\n            "balance": {\n              "gte": 20000,\n              "lte": 30000\n            }\n          }\n        }\n      ]\n    }\n  }\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br")])]),a("p",[s._v("结果，显然无_score")]),s._v(" "),a("p",[a("img",{attrs:{src:n(2471),alt:""}})]),s._v(" "),a("h1",{attrs:{id:"聚合查询-aggregation"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#聚合查询-aggregation"}},[s._v("#")]),s._v(" 聚合查询：Aggregation")]),s._v(" "),a("hr"),s._v(" "),a("blockquote",[a("p",[s._v("我们知道SQL中有group by，在ES中它叫Aggregation，即聚合运算。")])]),s._v(" "),a("h3",{attrs:{id:"简单聚合"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#简单聚合"}},[s._v("#")]),s._v(" 简单聚合")]),s._v(" "),a("p",[s._v("比如我们希望计算出account每个州的统计数量， 使用"),a("code",[s._v("aggs")]),s._v("关键字对"),a("code",[s._v("state")]),s._v("字段聚合，被聚合的字段无需对分词统计，所以使用"),a("code",[s._v("state.keyword")]),s._v("对整个字段统计")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('GET /bank/_search\n{\n  "size": 0,\n  "aggs": {\n    "group_by_state": {\n      "terms": {\n        "field": "state.keyword"\n      }\n    }\n  }\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[s._v("结果")]),s._v(" "),a("p",[a("img",{attrs:{src:n(2472),alt:""}})]),s._v(" "),a("p",[s._v("因为无需返回条件的具体数据, 所以设置size=0，返回hits为空。")]),s._v(" "),a("p",[a("code",[s._v("doc_count")]),s._v("表示bucket中每个州的数据条数。")]),s._v(" "),a("h3",{attrs:{id:"嵌套聚合"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#嵌套聚合"}},[s._v("#")]),s._v(" 嵌套聚合")]),s._v(" "),a("p",[s._v("ES还可以处理个聚合条件的嵌套。")]),s._v(" "),a("p",[s._v("比如承接上个例子， 计算每个州的平均结余。涉及到的就是在对state分组的基础上，嵌套计算avg(balance):")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('GET /bank/_search\n{\n  "size": 0,\n  "aggs": {\n    "group_by_state": {\n      "terms": {\n        "field": "state.keyword"\n      },\n      "aggs": {\n        "average_balance": {\n          "avg": {\n            "field": "balance"\n          }\n        }\n      }\n    }\n  }\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br")])]),a("p",[s._v("结果")]),s._v(" "),a("p",[a("img",{attrs:{src:n(2473),alt:""}})]),s._v(" "),a("h3",{attrs:{id:"对聚合结果排序"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#对聚合结果排序"}},[s._v("#")]),s._v(" 对聚合结果排序")]),s._v(" "),a("p",[s._v("可以通过在aggs中对嵌套聚合的结果进行排序")]),s._v(" "),a("p",[s._v("比如承接上个例子， 对嵌套计算出的avg(balance)，这里是average_balance，进行排序")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('GET /bank/_search\n{\n  "size": 0,\n  "aggs": {\n    "group_by_state": {\n      "terms": {\n        "field": "state.keyword",\n        "order": {\n          "average_balance": "desc"\n        }\n      },\n      "aggs": {\n        "average_balance": {\n          "avg": {\n            "field": "balance"\n          }\n        }\n      }\n    }\n  }\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br")])]),a("p",[s._v("结果")]),s._v(" "),a("p",[a("img",{attrs:{src:n(2474),alt:""}}),s._v(")")])])}),[],!1,null,null,null);a.default=t.exports}}]);