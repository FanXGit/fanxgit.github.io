(window.webpackJsonp=window.webpackJsonp||[]).push([[614],{3953:function(e,s,a){"use strict";a.r(s);var n=a(7),r=Object(n.a)({},(function(){var e=this,s=e._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("h1",{attrs:{id:"elasticsearch-wrapperquery"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#elasticsearch-wrapperquery"}},[e._v("#")]),e._v(" ElasticSearch - WrapperQuery")]),e._v(" "),s("p",[e._v("=============================================================")]),e._v(" "),s("blockquote",[s("p",[e._v("在工作中遇到ElasticSearch版本升级时出现Java High Level接口变更导致的兼容性问题: 之前使用的是2.4.x，考虑性能和功能的增强，需要更换为6.4.x; 2.4.x中我们使用DSL语句直接查询(数据的不确定性和方便动态建立查询规则等因素)，而新的ES Java 高阶API中去掉了相关接口的支持。 此文主要记录通过 ES Wrapper Query实现对6.x版本中 Java high-level transport client对json DSL查询对支持。 @pdai")])]),e._v(" "),s("h1",{attrs:{id:"实现方式理论基础"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#实现方式理论基础"}},[e._v("#")]),e._v(" 实现方式理论基础")]),e._v(" "),s("hr"),e._v(" "),s("ul",[s("li",[e._v("Wrapper Query 官网说明")])]),e._v(" "),s("p",[e._v("https://www.elastic.co/guide/en/elasticsearch/reference/6.4/query-dsl-wrapper-query.html")]),e._v(" "),s("blockquote",[s("p",[e._v("This query is more useful in the context of the Java high-level REST client or transport client to also accept queries as json formatted string. In these cases queries can be specified as a json or yaml formatted string or as a query builder (which is a available in the Java high-level REST client).")])]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('GET /_search\n{\n    "query" : {\n        "wrapper": {\n            "query" : "eyJ0ZXJtIiA6IHsgInVzZXIiIDogIktpbWNoeSIgfX0=" // Base64 encoded string: {"term" : { "user" : "Kimchy" }}\n        }\n    }\n}\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br")])]),s("ul",[s("li",[e._v("将DSL JSON语句 转成 map")])]),e._v(" "),s("p",[e._v("https://blog.csdn.net/qq_41370896/article/details/83658948")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('String dsl = "";\nMap maps = (Map)JSON.parse(dsl);  \nmaps.get("query");// dsl query string\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br")])]),s("ul",[s("li",[e._v("Java 代码")])]),e._v(" "),s("p",[e._v("https://blog.csdn.net/tcyzhyx/article/details/84566734")]),e._v(" "),s("p",[e._v("https://www.jianshu.com/p/216ca70d9e62")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('StringBuffer dsl = new StringBuffer();\ndsl.append("{\\"bool\\": {");\ndsl.append("      \\"must\\": [");\ndsl.append("        {");\ndsl.append("          \\"term\\": {");\ndsl.append("            \\"mdid.keyword\\": {");\ndsl.append("              \\"value\\": \\"2fa9d41e1af460e0d47ce36ca8a98737\\"");\ndsl.append("            }");\ndsl.append("          }");\ndsl.append("        }");\ndsl.append("      ]");\ndsl.append("    }");\ndsl.append("}");\nWrapperQueryBuilder wqb = QueryBuilders.wrapperQuery(dsl.toString());\nSearchResponse searchResponse = client.prepareSearch(basicsysCodeManager.getYjzxYjxxIndex())\n.setTypes(basicsysCodeManager.getYjzxYjxxType()).setQuery(wqb).setSize(10).get();\nSearchHit[] hits = searchResponse.getHits().getHits();\nfor(SearchHit hit : hits){\n\tString content = hit.getSourceAsString();\n\tSystem.out.println(content);\n}\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br"),s("span",{staticClass:"line-number"},[e._v("16")]),s("br"),s("span",{staticClass:"line-number"},[e._v("17")]),s("br"),s("span",{staticClass:"line-number"},[e._v("18")]),s("br"),s("span",{staticClass:"line-number"},[e._v("19")]),s("br"),s("span",{staticClass:"line-number"},[e._v("20")]),s("br"),s("span",{staticClass:"line-number"},[e._v("21")]),s("br")])]),s("ul",[s("li",[e._v("query + agg 应该怎么写")])]),e._v(" "),s("p",[e._v("http://www.itkeyword.com/doc/1009692843717298639/wrapperquerybuilder-aggs-query-throwing-query-malformed-exception")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('"{\\"query\\":{\\"match_all\\": {}},\\"aggs\\":{\\"avg1\\":{\\"avg\\":{\\"field\\":\\"age\\"}}}}"\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('SearchSourceBuilder ssb = new SearchSourceBuilder();\n\n// add the query part\nString query ="{\\"match_all\\": {}}";\nWrapperQueryBuilder wrapQB = new WrapperQueryBuilder(query);\nssb.query(wrapQB);\n\n// add the aggregation part\nAvgBuilder avgAgg = AggregationBuilders.avg("avg1").field("age");\nssb.aggregation(avgAgg);\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br")])]),s("h1",{attrs:{id:"实现示例"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#实现示例"}},[e._v("#")]),e._v(" 实现示例")]),e._v(" "),s("hr"),e._v(" "),s("p",[e._v("略)")])])}),[],!1,null,null,null);s.default=r.exports}}]);