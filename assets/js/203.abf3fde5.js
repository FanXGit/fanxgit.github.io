(window.webpackJsonp=window.webpackJsonp||[]).push([[203],{3338:function(s,a,n){s.exports=n.p+"assets/img/tomcat-x-sourcecode-2.cbb712bb.png"},3339:function(s,a,n){s.exports=n.p+"assets/img/tomcat-x-sourcecode-3.90d27c24.png"},3340:function(s,a,n){s.exports=n.p+"assets/img/tomcat-x-sourcecode-4.ce54701f.png"},3341:function(s,a,n){s.exports=n.p+"assets/img/tomcat-x-sourcecode-1.f23fd4b0.png"},3342:function(s,a,n){s.exports=n.p+"assets/img/tomcat-x-sourcecode-5.d3d81ac6.png"},3343:function(s,a,n){s.exports=n.p+"assets/img/tomcat-x-sourcecode-6.3322b624.png"},4197:function(s,a,n){"use strict";n.r(a);var t=n(7),e=Object(t.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"tomcat-源码分析准备和分析入口"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#tomcat-源码分析准备和分析入口"}},[s._v("#")]),s._v(" Tomcat - 源码分析准备和分析入口")]),s._v(" "),a("p",[s._v("=============================================")]),s._v(" "),a("blockquote",[a("p",[s._v("上文我们介绍了Tomcat的架构设计，接下来我们便可以下载源码以及寻找源码入口了。@pdai")])]),s._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#tomcat---%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%87%86%E5%A4%87%E5%92%8C%E5%88%86%E6%9E%90%E5%85%A5%E5%8F%A3"}},[s._v("Tomcat - 源码分析准备和分析入口")]),s._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#%E6%BA%90%E4%BB%A3%E7%A0%81%E4%B8%8B%E8%BD%BD%E5%92%8C%E7%BC%96%E8%AF%91"}},[s._v("源代码下载和编译")]),s._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#%E4%B8%8B%E8%BD%BD%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%8C%85%E5%92%8C%E6%BA%90%E7%A0%81"}},[s._v("下载二进制包和源码")])]),s._v(" "),a("li",[a("a",{attrs:{href:"#%E7%BC%96%E8%AF%91%E6%BA%90%E7%A0%81"}},[s._v("编译源码")])]),s._v(" "),a("li",[a("a",{attrs:{href:"#%E7%90%86%E8%A7%A3%E7%BC%96%E8%AF%91%E5%90%8E%E6%A8%A1%E5%9D%97"}},[s._v("理解编译后模块")])])])]),s._v(" "),a("li",[a("a",{attrs:{href:"#%E4%BB%8E%E5%90%AF%E5%8A%A8%E8%84%9A%E6%9C%AC%E5%AE%9A%E4%BD%8Dtomcat%E6%BA%90%E7%A0%81%E5%85%A5%E5%8F%A3"}},[s._v("从启动脚本定位Tomcat源码入口")]),s._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#startupbat"}},[s._v("startup.bat")])]),s._v(" "),a("li",[a("a",{attrs:{href:"#catalinabat"}},[s._v("catalina.bat")])])])]),s._v(" "),a("li",[a("a",{attrs:{href:"#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"}},[s._v("参考文章")])])])])]),s._v(" "),a("h1",{attrs:{id:"源代码下载和编译"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#源代码下载和编译"}},[s._v("#")]),s._v(" 源代码下载和编译")]),s._v(" "),a("hr"),s._v(" "),a("p",[s._v("首先是去官网下载Tomcat的源代码和二进制安装包，我这里分析最新的"),a("a",{attrs:{href:"https://tomcat.apache.org/download-90.cgi",target:"_blank",rel:"noopener noreferrer"}},[s._v("Tomcat9.0.39稳定版本 在新窗口打开"),a("OutboundLink")],1),s._v("https://tomcat.apache.org/download-90.cgi")]),s._v(" "),a("h3",{attrs:{id:"下载二进制包和源码"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#下载二进制包和源码"}},[s._v("#")]),s._v(" 下载二进制包和源码")]),s._v(" "),a("blockquote",[a("p",[s._v("下载二进制包的主要目的在于，让我们回顾一下包中的内容；其次，在我们后面通过源码包编译后，以方便和二进制包进行对比。")])]),s._v(" "),a("ul",[a("li",[s._v("下载两个包")])]),s._v(" "),a("p",[a("img",{attrs:{src:n(3338),alt:""}})]),s._v(" "),a("ul",[a("li",[s._v("查看二进制包中主要模块")])]),s._v(" "),a("p",[a("img",{attrs:{src:n(3339),alt:""}})]),s._v(" "),a("h3",{attrs:{id:"编译源码"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#编译源码"}},[s._v("#")]),s._v(" 编译源码")]),s._v(" "),a("ul",[a("li",[s._v("导入IDEA")])]),s._v(" "),a("p",[a("img",{attrs:{src:n(3340),alt:""}})]),s._v(" "),a("ul",[a("li",[s._v("使用ant编译")])]),s._v(" "),a("p",[a("img",{attrs:{src:n(3341),alt:""}})]),s._v(" "),a("h3",{attrs:{id:"理解编译后模块"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#理解编译后模块"}},[s._v("#")]),s._v(" 理解编译后模块")]),s._v(" "),a("blockquote",[a("p",[s._v("这里有两点要注意下：第一：在编译完之后，编译输出到哪里了呢？第二：编译后的结果是不是和我们下载的二进制文件对的上呢？")])]),s._v(" "),a("ul",[a("li",[s._v("编译的输出在哪里")])]),s._v(" "),a("p",[a("img",{attrs:{src:n(3342),alt:""}})]),s._v(" "),a("ul",[a("li",[s._v("编译的输出结果是否对的上，很显然和上面的二进制包一致")])]),s._v(" "),a("p",[a("img",{attrs:{src:n(3343),alt:""}})]),s._v(" "),a("h1",{attrs:{id:"从启动脚本定位tomcat源码入口"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#从启动脚本定位tomcat源码入口"}},[s._v("#")]),s._v(" 从启动脚本定位Tomcat源码入口")]),s._v(" "),a("hr"),s._v(" "),a("blockquote",[a("p",[s._v("好了，到这里我们基本上已经有准备好代码了，接下来便是寻找代码入口了。@pdai")])]),s._v(" "),a("h3",{attrs:{id:"startup-bat"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#startup-bat"}},[s._v("#")]),s._v(" startup.bat")]),s._v(" "),a("blockquote",[a("p",[s._v("当我们初学tomcat的时候, 肯定先要学习怎样启动tomcat. 在tomcat的bin目录下有两个启动tomcat的文件, 一个是startup.bat, 它用于windows环境下启动tomcat; 另一个是startup.sh, 它用于linux环境下tomcat的启动. 两个文件中的逻辑是一样的, 我们只分析其中的startup.bat.")])]),s._v(" "),a("ul",[a("li",[s._v("startup.bat的源码: "),a("strong",[s._v("startup.bat文件实际上就做了一件事情: 启动catalina.bat.")])])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('@echo off\nrem Licensed to the Apache Software Foundation (ASF) under one or more\nrem contributor license agreements.  See the NOTICE file distributed with\nrem this work for additional information regarding copyright ownership.\nrem The ASF licenses this file to You under the Apache License, Version 2.0\nrem (the "License"); you may not use this file except in compliance with\nrem the License.  You may obtain a copy of the License at\nrem\nrem     http://www.apache.org/licenses/LICENSE-2.0\nrem\nrem Unless required by applicable law or agreed to in writing, software\nrem distributed under the License is distributed on an "AS IS" BASIS,\nrem WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nrem See the License for the specific language governing permissions and\nrem limitations under the License.\n\nrem ---------------------------------------------------------------------------\nrem Start script for the CATALINA Server\nrem ---------------------------------------------------------------------------\n\nsetlocal\n\nrem Guess CATALINA_HOME if not defined\nset "CURRENT_DIR=%cd%"\nif not "%CATALINA_HOME%" == "" goto gotHome\nset "CATALINA_HOME=%CURRENT_DIR%"\nif exist "%CATALINA_HOME%\\bin\\catalina.bat" goto okHome\ncd ..\nset "CATALINA_HOME=%cd%"\ncd "%CURRENT_DIR%"\n:gotHome\nif exist "%CATALINA_HOME%\\bin\\catalina.bat" goto okHome\necho The CATALINA_HOME environment variable is not defined correctly\necho This environment variable is needed to run this program\ngoto end\n:okHome\n\nset "EXECUTABLE=%CATALINA_HOME%\\bin\\catalina.bat"\n\nrem Check that target executable exists\nif exist "%EXECUTABLE%" goto okExec\necho Cannot find "%EXECUTABLE%"\necho This file is needed to run this program\ngoto end\n:okExec\n\nrem Get remaining unshifted command line arguments and save them in the\nset CMD_LINE_ARGS=\n:setArgs\nif ""%1""=="""" goto doneSetArgs\nset CMD_LINE_ARGS=%CMD_LINE_ARGS% %1\nshift\ngoto setArgs\n:doneSetArgs\n\ncall "%EXECUTABLE%" start %CMD_LINE_ARGS%\n\n:end\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br")])]),a("ul",[a("li",[a("p",[s._v("当然如果你感兴趣，不妨也可以看下上面脚本的含义")]),s._v(" "),a("ul",[a("li",[s._v(".bat文件中@echo是打印指令, 用于控制台输出信息, rem是注释符.")]),s._v(" "),a("li",[s._v("跳过开头的注释, 我们来到配置CATALINA_HOME的代码段, 执行startup.bat文件首先会设置CATALINA_HOME.")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('set "CURRENT_DIR=%cd%"\nif not "%CATALINA_HOME%" == "" goto gotHome\nset "CATALINA_HOME=%CURRENT_DIR%"\nif exist "%CATALINA_HOME%\\bin\\catalina.bat" goto okHome\ncd ..\nset "CATALINA_HOME=%cd%"\ncd "%CURRENT_DIR%"\n:gotHome\nif exist "%CATALINA_HOME%\\bin\\catalina.bat" goto okHome\necho The CATALINA_HOME environment variable is not defined correctly\necho This environment variable is needed to run this program\ngoto end\n:okHome\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("ul",[a("li",[s._v("先通过set指令把当前目录设置到一个名为CURRENT_DIR的变量中,")]),s._v(" "),a("li",[s._v("如果系统中配置过CATALINA_HOME则跳到gotHome代码段. 正常情况下我们的电脑都没有配置CATALINA_HOME, 所以往下执行, 把当前目录设置为CATALINA_HOME.")]),s._v(" "),a("li",[s._v("然后判断CATALINA_HOME目录下是否存在catalina.bat文件, 如果存在就跳到okHome代码块.")]),s._v(" "),a("li",[s._v("在okHome中, 会把catalina.bat文件的的路径赋给一个叫EXECUTABLE的变量, 然后会进一步判断这个路径是否存在, 存在则跳转到okExec代码块, 不存在的话会在控制台输出一些错误信息.")]),s._v(" "),a("li",[s._v("在okExec中, 会把setArgs代码块的返回结果赋值给CMD_LINE_ARGS变量, 这个变量用于存储启动参数.")]),s._v(" "),a("li",[s._v('setArgs中首先会判断是否有参数, (if ""%1""==""""判断第一个参数是否为空), 如果没有参数则相当于参数项为空. 如果有参数则循环遍历所有的参数(每次拼接第一个参数).')]),s._v(" "),a("li",[s._v('最后执行call "%EXECUTABLE%" start %CMD_LINE_ARGS%, 也就是说执行catalina.bat文件, 如果有参数则带上参数.')])])])]),s._v(" "),a("blockquote",[a("p",[s._v("这样看来, 在windows下启动tomcat未必一定要通过startup.bat, 用catalina.bat start也是可以的.")])]),s._v(" "),a("h3",{attrs:{id:"catalina-bat"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#catalina-bat"}},[s._v("#")]),s._v(" catalina.bat")]),s._v(" "),a("blockquote",[a("p",[s._v("catalina的脚本有点多，我们分开看：")])]),s._v(" "),a("ul",[a("li",[s._v("跳过开头的注释, 我们来到下面的代码段:")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('setlocal\n\nrem Suppress Terminate batch job on CTRL+C\nif not ""%1"" == ""run"" goto mainEntry\nif "%TEMP%" == "" goto mainEntry\nif exist "%TEMP%\\%~nx0.run" goto mainEntry\necho Y>"%TEMP%\\%~nx0.run"\nif not exist "%TEMP%\\%~nx0.run" goto mainEntry\necho Y>"%TEMP%\\%~nx0.Y"\ncall "%~f0" %* <"%TEMP%\\%~nx0.Y"\nrem Use provided errorlevel\nset RETVAL=%ERRORLEVEL%\ndel /Q "%TEMP%\\%~nx0.Y" >NUL 2>&1\nexit /B %RETVAL%\n:mainEntry\ndel /Q "%TEMP%\\%~nx0.run" >NUL 2>&1\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br")])]),a("ul",[a("li",[s._v("大多情况下我们启动tomcat都没有设置参数, 所以直接跳到mainEntry代码段, 删除了一个临时文件后, 继续往下执行.")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('rem Guess CATALINA_HOME if not defined\nset "CURRENT_DIR=%cd%"\nif not "%CATALINA_HOME%" == "" goto gotHome\nset "CATALINA_HOME=%CURRENT_DIR%"\nif exist "%CATALINA_HOME%\\bin\\catalina.bat" goto okHome\ncd ..\nset "CATALINA_HOME=%cd%"\ncd "%CURRENT_DIR%"\n:gotHome\n\nif exist "%CATALINA_HOME%\\bin\\catalina.bat" goto okHome\necho The CATALINA_HOME environment variable is not defined correctly\necho This environment variable is needed to run this program\ngoto end\n:okHome\n\nrem Copy CATALINA_BASE from CATALINA_HOME if not defined\nif not "%CATALINA_BASE%" == "" goto gotBase\nset "CATALINA_BASE=%CATALINA_HOME%"\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br")])]),a("ul",[a("li",[s._v("可以看到这段代码与startup.bat中开头的代码相似, 在确定CATALINA_HOME下有catalina.bat后把CATALINA_HOME赋给变量CATALINA_BASE.")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('rem Get standard environment variables\nif not exist "%CATALINA_BASE%\\bin\\setenv.bat" goto checkSetenvHome\ncall "%CATALINA_BASE%\\bin\\setenv.bat"\ngoto setenvDone\n:checkSetenvHome\nif exist "%CATALINA_HOME%\\bin\\setenv.bat" call "%CATALINA_HOME%\\bin\\setenv.bat"\n:setenvDone\n\nrem Get standard Java environment variables\nif exist "%CATALINA_HOME%\\bin\\setclasspath.bat" goto okSetclasspath\necho Cannot find "%CATALINA_HOME%\\bin\\setclasspath.bat"\necho This file is needed to run this program\ngoto end\n:okSetclasspath\ncall "%CATALINA_HOME%\\bin\\setclasspath.bat" %1\nif errorlevel 1 goto end\n\nrem Add on extra jar file to CLASSPATH\nrem Note that there are no quotes as we do not want to introduce random\nrem quotes into the CLASSPATH\nif "%CLASSPATH%" == "" goto emptyClasspath\nset "CLASSPATH=%CLASSPATH%;"\n:emptyClasspath\nset "CLASSPATH=%CLASSPATH%%CATALINA_HOME%\\bin\\bootstrap.jar"\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br")])]),a("blockquote",[a("p",[s._v("上面这段代码依次执行了setenv.bat和setclasspath.bat文件, 目的是获得CLASSPATH, 相信会Java的同学应该都会在配置环境变量时都配置过classpath, 系统拿到classpath路径后把它和CATALINA_HOME拼接在一起, 最终定位到一个叫bootstrap.jar的文件. 虽然后面还有很多代码, 但是这里必须暂停提示一下: bootstrap.jar将是我们启动tomcat的环境.")])]),s._v(" "),a("ul",[a("li",[s._v("接下来从gotTmpdir代码块到noEndorsedVar代码块进行了一些配置, 由于不是主要内容暂且跳过.")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('echo Using CATALINA_BASE:   "%CATALINA_BASE%"\necho Using CATALINA_HOME:   "%CATALINA_HOME%"\necho Using CATALINA_TMPDIR: "%CATALINA_TMPDIR%"\nif ""%1"" == ""debug"" goto use_jdk\necho Using JRE_HOME:        "%JRE_HOME%"\ngoto java_dir_displayed\n:use_jdk\necho Using JAVA_HOME:       "%JAVA_HOME%"\n:java_dir_displayed\necho Using CLASSPATH:       "%CLASSPATH%"\n\nset _EXECJAVA=%_RUNJAVA%\nset MAINCLASS=org.apache.catalina.startup.Bootstrap\nset ACTION=start\nset SECURITY_POLICY_FILE=\nset DEBUG_OPTS=\nset JPDA=\n\nif not ""%1"" == ""jpda"" goto noJpda\nset JPDA=jpda\nif not "%JPDA_TRANSPORT%" == "" goto gotJpdaTransport\nset JPDA_TRANSPORT=dt_socket\n:gotJpdaTransport\nif not "%JPDA_ADDRESS%" == "" goto gotJpdaAddress\nset JPDA_ADDRESS=8000\n:gotJpdaAddress\nif not "%JPDA_SUSPEND%" == "" goto gotJpdaSuspend\nset JPDA_SUSPEND=n\n:gotJpdaSuspend\nif not "%JPDA_OPTS%" == "" goto gotJpdaOpts\nset JPDA_OPTS=-agentlib:jdwp=transport=%JPDA_TRANSPORT%,address=%JPDA_ADDRESS%,server=y,suspend=%JPDA_SUSPEND%\n:gotJpdaOpts\nshift\n:noJpda\n\nif ""%1"" == ""debug"" goto doDebug\nif ""%1"" == ""run"" goto doRun\nif ""%1"" == ""start"" goto doStart\nif ""%1"" == ""stop"" goto doStop\nif ""%1"" == ""configtest"" goto doConfigTest\nif ""%1"" == ""version"" goto doVersion\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br")])]),a("ul",[a("li",[s._v("接下来, 我们能看到一些重要的信息, 其中的重点是:")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("set _EXECJAVA=%_RUNJAVA%, 设置了jdk中bin目录下的java.exe文件路径.\nset MAINCLASS=org.apache.catalina.startup.Bootstrap, 设置了tomcat的启动类为Bootstrap这个类. (后面会分析这个类)\nset ACTION=start设置tomcat启动\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("blockquote",[a("p",[s._v("大家可以留意这些参数, 最后执行tomcat的启动时会用到.")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('if not ""%1"" == ""jpda"" goto noJpda\nset JPDA=jpda\nif not "%JPDA_TRANSPORT%" == "" goto gotJpdaTransport\nset JPDA_TRANSPORT=dt_socket\n:gotJpdaTransport\nif not "%JPDA_ADDRESS%" == "" goto gotJpdaAddress\nset JPDA_ADDRESS=8000\n:gotJpdaAddress\nif not "%JPDA_SUSPEND%" == "" goto gotJpdaSuspend\nset JPDA_SUSPEND=n\n:gotJpdaSuspend\nif not "%JPDA_OPTS%" == "" goto gotJpdaOpts\nset JPDA_OPTS=-agentlib:jdwp=transport=%JPDA_TRANSPORT%,address=%JPDA_ADDRESS%,server=y,suspend=%JPDA_SUSPEND%\n:gotJpdaOpts\nshift\n:noJpda\n\nif ""%1"" == ""debug"" goto doDebug\nif ""%1"" == ""run"" goto doRun\nif ""%1"" == ""start"" goto doStart\nif ""%1"" == ""stop"" goto doStop\nif ""%1"" == ""configtest"" goto doConfigTest\nif ""%1"" == ""version"" goto doVersion\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br")])]),a("ul",[a("li",[s._v("接着判断第一个参数是否是jpda, 是则进行一些设定. 而正常情况下第一个参数是start, 所以跳过这段代码. 接着会判断第一个参数的内容, 根据判断, 我们会跳到doStart代码段. (有余力的同学不妨看下debug, run等启动方式)")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v(':doStart\nshift\nif "%TITLE%" == "" set TITLE=Tomcat\nset _EXECJAVA=start "%TITLE%" %_RUNJAVA%\nif not ""%1"" == ""-security"" goto execCmd\nshift\necho Using Security Manager\nset "SECURITY_POLICY_FILE=%CATALINA_BASE%\\conf\\catalina.policy"\ngoto execCmd\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("ul",[a("li",[s._v("可以看到doStart中无非也是设定一些参数, 最终会跳转到execCmd代码段")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v(':execCmd\nrem Get remaining unshifted command line arguments and save them in the\nset CMD_LINE_ARGS=\n:setArgs\nif ""%1""=="""" goto doneSetArgs\nset CMD_LINE_ARGS=%CMD_LINE_ARGS% %1\nshift\ngoto setArgs\n:doneSetArgs\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("blockquote",[a("p",[s._v("可以看到这段代码也是在拼接参数, 把参数拼接到一个叫CMD_LINE_ARGS的变量中, 接下来就是catalina最后的一段代码了.")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('rem Execute Java with the applicable properties\nif not "%JPDA%" == "" goto doJpda\nif not "%SECURITY_POLICY_FILE%" == "" goto doSecurity\n%_EXECJAVA% %LOGGING_CONFIG% %LOGGING_MANAGER% %JAVA_OPTS% %CATALINA_OPTS% %DEBUG_OPTS% -D%ENDORSED_PROP%="%JAVA_ENDORSED_DIRS%" -classpath "%CLASSPATH%" -Dcatalina.base="%CATALINA_BASE%" -Dcatalina.home="%CATALINA_HOME%" -Djava.io.tmpdir="%CATALINA_TMPDIR%" %MAINCLASS% %CMD_LINE_ARGS% %ACTION%\ngoto end\n:doSecurity\n%_EXECJAVA% %LOGGING_CONFIG% %LOGGING_MANAGER% %JAVA_OPTS% %CATALINA_OPTS% %DEBUG_OPTS% -D%ENDORSED_PROP%="%JAVA_ENDORSED_DIRS%" -classpath "%CLASSPATH%" -Djava.security.manager -Djava.security.policy=="%SECURITY_POLICY_FILE%" -Dcatalina.base="%CATALINA_BASE%" -Dcatalina.home="%CATALINA_HOME%" -Djava.io.tmpdir="%CATALINA_TMPDIR%" %MAINCLASS% %CMD_LINE_ARGS% %ACTION%\ngoto end\n:doJpda\nif not "%SECURITY_POLICY_FILE%" == "" goto doSecurityJpda\n%_EXECJAVA% %LOGGING_CONFIG% %LOGGING_MANAGER% %JAVA_OPTS% %JPDA_OPTS% %CATALINA_OPTS% %DEBUG_OPTS% -D%ENDORSED_PROP%="%JAVA_ENDORSED_DIRS%" -classpath "%CLASSPATH%" -Dcatalina.base="%CATALINA_BASE%" -Dcatalina.home="%CATALINA_HOME%" -Djava.io.tmpdir="%CATALINA_TMPDIR%" %MAINCLASS% %CMD_LINE_ARGS% %ACTION%\ngoto end\n:doSecurityJpda\n%_EXECJAVA% %LOGGING_CONFIG% %LOGGING_MANAGER% %JAVA_OPTS% %JPDA_OPTS% %CATALINA_OPTS% %DEBUG_OPTS% -D%ENDORSED_PROP%="%JAVA_ENDORSED_DIRS%" -classpath "%CLASSPATH%" -Djava.security.manager -Djava.security.policy=="%SECURITY_POLICY_FILE%" -Dcatalina.base="%CATALINA_BASE%" -Dcatalina.home="%CATALINA_HOME%" -Djava.io.tmpdir="%CATALINA_TMPDIR%" %MAINCLASS% %CMD_LINE_ARGS% %ACTION%\ngoto end\n\n:end\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br")])]),a("ul",[a("li",[s._v("跳过前面两行判断后, 来到了关键语句:")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('%_EXECJAVA% %LOGGING_CONFIG% %LOGGING_MANAGER% %JAVA_OPTS% %CATALINA_OPTS% %DEBUG_OPTS% -D%ENDORSED_PROP%="%JAVA_ENDORSED_DIRS%" -classpath "%CLASSPATH%" -Dcatalina.base="%CATALINA_BASE%" -Dcatalina.home="%CATALINA_HOME%" -Djava.io.tmpdir="%CATALINA_TMPDIR%" %MAINCLASS% %CMD_LINE_ARGS% %ACTION%\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("blockquote",[a("p",[s._v('_EXECJAVA也就是_RUNJAVA, 也就是平时说的java指令, 但在之前的doStart代码块中把_EXECJAVA改为了start "%TITLE%" %_RUNJAVA%, 所以系统会另启一个命令行窗口, 名字叫Tomcat. 在拼接一系列参数后, 我们会看见%MAINCLASS%, 也就是org.apache.catalina.startup.Bootstrap启动类, 拼接完启动参数后, 最后拼接的是%ACTION%, 也就是start.')])]),s._v(" "),a("p",[a("strong",[s._v("总结")]),s._v(":")]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("catalina.bat最终执行了Bootstrap类中的main方法")]),s._v(".")]),s._v(" "),a("li",[s._v("我们可以通过设定不同的参数让tomcat以不同的方式运行. 在ide中我们是可以选择debug等模式启动tomcat的, 也可以为其配置参数, 在catalina.bat中我们看到了启动tomcat背后的运作流程.")])]),s._v(" "),a("h1",{attrs:{id:"参考文章"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考文章"}},[s._v("#")]),s._v(" 参考文章")]),s._v(" "),a("hr"),s._v(" "),a("ul",[a("li",[s._v("https://www.cnblogs.com/tanshaoshenghao/p/10932306.html)")])])])}),[],!1,null,null,null);a.default=e.exports}}]);