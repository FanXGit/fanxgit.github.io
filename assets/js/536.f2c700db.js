(window.webpackJsonp=window.webpackJsonp||[]).push([[536],{3672:function(s,n,a){"use strict";a.r(n);var e=a(7),t=Object(e.a)({},(function(){var s=this,n=s._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"springboot接口-如何实现接口限流之单实例"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#springboot接口-如何实现接口限流之单实例"}},[s._v("#")]),s._v(" SpringBoot接口 - 如何实现接口限流之单实例")]),s._v(" "),n("blockquote",[n("p",[s._v("在以SpringBoot开发Restful接口时，当流量超过服务极限能力时，系统可能会出现卡死、崩溃的情况，所以就有了降级和限流。在接口层如何做限流呢？ 本文主要回顾限流的知识点，并实践单实例限流的一种思路。 @pdai")])]),s._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"#springboot%E6%8E%A5%E5%8F%A3---%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%8E%A5%E5%8F%A3%E9%99%90%E6%B5%81%E4%B9%8B%E5%8D%95%E5%AE%9E%E4%BE%8B"}},[s._v("SpringBoot接口 - 如何实现接口限流之单实例")]),s._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"#%E5%87%86%E5%A4%87%E7%9F%A5%E8%AF%86%E7%82%B9"}},[s._v("准备知识点")]),s._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E9%99%90%E6%B5%81"}},[s._v("为什么要限流")])]),s._v(" "),n("li",[n("a",{attrs:{href:"#%E9%99%90%E6%B5%81%E6%9C%89%E5%93%AA%E4%BA%9B%E5%B8%B8%E8%A7%81%E6%80%9D%E8%B7%AF"}},[s._v("限流有哪些常见思路？")])])])]),s._v(" "),n("li",[n("a",{attrs:{href:"#%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF"}},[s._v("实现思路")]),s._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"#%E5%AE%9A%E4%B9%89ratelimit%E6%B3%A8%E8%A7%A3"}},[s._v("定义RateLimit注解")])]),s._v(" "),n("li",[n("a",{attrs:{href:"#%E5%AE%9A%E4%B9%89aop"}},[s._v("定义AOP")])]),s._v(" "),n("li",[n("a",{attrs:{href:"#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9B%B8%E5%85%B3%E5%BC%82%E5%B8%B8"}},[s._v("自定义相关异常")])]),s._v(" "),n("li",[n("a",{attrs:{href:"#%E7%BB%9F%E4%B8%80%E7%BB%93%E6%9E%9C%E8%BF%94%E5%9B%9E%E5%B0%81%E8%A3%85"}},[s._v("统一结果返回封装")])]),s._v(" "),n("li",[n("a",{attrs:{href:"#controller%E6%8E%A5%E5%8F%A3"}},[s._v("controller接口")])]),s._v(" "),n("li",[n("a",{attrs:{href:"#%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95"}},[s._v("接口测试")])]),s._v(" "),n("li",[n("a",{attrs:{href:"#%E4%B8%8A%E8%BF%B0%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88%E7%9A%84%E6%A7%BD%E7%82%B9"}},[s._v("上述实现方案的槽点")])])])]),s._v(" "),n("li",[n("a",{attrs:{href:"#%E7%A4%BA%E4%BE%8B%E6%BA%90%E7%A0%81"}},[s._v("示例源码")])])])])]),s._v(" "),n("h1",{attrs:{id:"准备知识点"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#准备知识点"}},[s._v("#")]),s._v(" 准备知识点")]),s._v(" "),n("hr"),s._v(" "),n("blockquote",[n("p",[s._v("主要的知识点，请参考"),n("a",{attrs:{href:"https://pdai.tech/md/arch/arch-y-ratelimit.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("架构之高并发：限流"),n("OutboundLink")],1),s._v(", 这里小结下。")])]),s._v(" "),n("h3",{attrs:{id:"为什么要限流"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#为什么要限流"}},[s._v("#")]),s._v(" 为什么要限流")]),s._v(" "),n("p",[s._v("每个系统都有服务的上限，所以当流量超过服务极限能力时，系统可能会出现卡死、崩溃的情况，所以就有了降级和限流。限流其实就是：当高并发或者瞬时高并发时，为了保证系统的稳定性、可用性，系统以牺牲部分请求为代价或者延迟处理请求为代价，保证系统整体服务可用。")]),s._v(" "),n("h3",{attrs:{id:"限流有哪些常见思路"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#限流有哪些常见思路"}},[s._v("#")]),s._v(" 限流有哪些常见思路？")]),s._v(" "),n("ul",[n("li",[n("strong",[s._v("从算法上看")])])]),s._v(" "),n("p",[s._v("令牌桶(Token Bucket)、漏桶(leaky bucket)和计数器算法是最常用的三种限流的算法。")]),s._v(" "),n("ol",[n("li",[n("p",[s._v("令牌桶(Token Bucket)算法：\n令牌桶算法通过维护一个令牌桶来控制数据的发送速率。令牌桶中以固定的速率产生令牌，并将这些令牌放入桶中。当有数据需要发送时，必须从桶中获取足够数量的令牌才能发送。每个令牌代表单位时间内允许传输的数据量，如果桶中的令牌不足，则需要等待或丢弃数据。这样可以平滑限制数据的传输速率。")])]),s._v(" "),n("li",[n("p",[s._v("漏桶(Leaky Bucket)算法：\n漏桶算法通过模拟一个漏桶来控制数据的发送速率。数据以恒定的速率流入漏桶中，如果漏桶已满，则溢出的数据将被丢弃。而数据以恒定的速率从漏桶中流出，然后按照该速率进行发送。漏桶算法可以平滑限制数据的发送速率，并对突发流量进行调节，但无法处理瞬时流量的突增。")])]),s._v(" "),n("li",[n("p",[s._v("计数器算法：\n计数器算法简单地计算单位时间内的请求数量，并根据设定的阈值来限制请求频率。当请求数量超过阈值时，可以拒绝新的请求或进行限流处理。计数器算法通常用于限制接口的并发请求数或单位时间内的总请求数。")])])]),s._v(" "),n("ul",[n("li",[n("strong",[s._v("单实例")])])]),s._v(" "),n("p",[s._v("应用级限流方式只是单应用内的请求限流，不能进行全局限流。")]),s._v(" "),n("ol",[n("li",[s._v("限流总资源数")]),s._v(" "),n("li",[s._v("限流总并发/连接/请求数")]),s._v(" "),n("li",[s._v("限流某个接口的总并发/请求数")]),s._v(" "),n("li",[s._v("限流某个接口的时间窗请求数")]),s._v(" "),n("li",[s._v("平滑限流某个接口的请求数")]),s._v(" "),n("li",[s._v("Guava RateLimiter")])]),s._v(" "),n("ul",[n("li",[n("strong",[s._v("分布式")])])]),s._v(" "),n("p",[s._v("我们需要"),n("strong",[s._v("分布式限流")]),s._v("和"),n("strong",[s._v("接入层限流")]),s._v("来进行全局限流。")]),s._v(" "),n("ol",[n("li",[s._v("redis+lua实现中的lua脚本")]),s._v(" "),n("li",[s._v("使用Nginx+Lua实现的Lua脚本")]),s._v(" "),n("li",[s._v("使用 OpenResty 开源的限流方案")]),s._v(" "),n("li",[s._v("限流框架，比如Sentinel实现降级限流熔断")])]),s._v(" "),n("h1",{attrs:{id:"实现思路"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#实现思路"}},[s._v("#")]),s._v(" 实现思路")]),s._v(" "),n("hr"),s._v(" "),n("blockquote",[n("p",[s._v("主要思路：AOP拦截自定义的RateLimit注解，在AOP中通过Guava RateLimiter; Guava RateLimiter提供了令牌桶算法实现：平滑突发限流(SmoothBursty)和平滑预热限流(SmoothWarmingUp)实现。")])]),s._v(" "),n("h3",{attrs:{id:"定义ratelimit注解"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#定义ratelimit注解"}},[s._v("#")]),s._v(" 定义RateLimit注解")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("package tech.pdai.ratelimit.guava.config.ratelimit;\n\nimport java.lang.annotation.ElementType;\nimport java.lang.annotation.Retention;\nimport java.lang.annotation.RetentionPolicy;\nimport java.lang.annotation.Target;\n\n/**\n * @author pdai\n */\n@Target(ElementType.METHOD)\n@Retention(RetentionPolicy.RUNTIME)\npublic @interface RateLimit {\n\n    int limit() default 10;\n\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br")])]),n("h3",{attrs:{id:"定义aop"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#定义aop"}},[s._v("#")]),s._v(" 定义AOP")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('package tech.pdai.ratelimit.guava.config.ratelimit;\n\nimport java.lang.reflect.Method;\nimport java.util.concurrent.ConcurrentHashMap;\n\nimport com.google.common.util.concurrent.RateLimiter;\nimport lombok.extern.slf4j.Slf4j;\nimport org.aspectj.lang.ProceedingJoinPoint;\nimport org.aspectj.lang.annotation.Around;\nimport org.aspectj.lang.annotation.Aspect;\nimport org.aspectj.lang.annotation.Pointcut;\nimport org.aspectj.lang.reflect.MethodSignature;\nimport org.springframework.core.annotation.AnnotationUtils;\nimport org.springframework.stereotype.Component;\n\n/**\n * @author pdai\n */\n@Slf4j\n@Aspect\n@Component\npublic class RateLimitAspect {\n\n    private final ConcurrentHashMap<String, RateLimiter> EXISTED_RATE_LIMITERS = new ConcurrentHashMap<>();\n\n    @Pointcut("@annotation(tech.pdai.ratelimit.guava.config.ratelimit.RateLimit)")\n    public void rateLimit() {\n    }\n\n    @Around("rateLimit()")\n    public Object around(ProceedingJoinPoint point) throws Throwable {\n        MethodSignature signature = (MethodSignature) point.getSignature();\n        Method method = signature.getMethod();\n        RateLimit annotation = AnnotationUtils.findAnnotation(method, RateLimit.class);\n\n        // get rate limiter\n        RateLimiter rateLimiter = EXISTED_RATE_LIMITERS.computeIfAbsent(method.getName(), k -> RateLimiter.create(annotation.limit()));\n\n        // process\n        if (rateLimiter!=null && rateLimiter.tryAcquire()) {\n            return point.proceed();\n        } else {\n            throw new RuntimeException("too many requests, please try again later...");\n        }\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br")])]),n("h3",{attrs:{id:"自定义相关异常"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#自定义相关异常"}},[s._v("#")]),s._v(" 自定义相关异常")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("package tech.pdai.ratelimit.guava.config.exception;\n\nimport lombok.extern.slf4j.Slf4j;\n\n/**\n * business exception, besides normal exception.\n *\n * @author pdai\n */\n@Slf4j\npublic class BusinessException extends RuntimeException {\n\n    /**\n     * Constructs a new exception with {@code null} as its detail message. The cause is not initialized, and may\n     * subsequently be initialized by a call to {@link #initCause}.\n     */\n    public BusinessException() {\n        super();\n    }\n\n    /**\n     * Constructs a new exception with the specified detail message. The cause is not initialized, and may subsequently\n     * be initialized by a call to {@link #initCause}.\n     *\n     * @param message the detail message. The detail message is saved for later retrieval by the {@link #getMessage()}\n     *                method.\n     */\n    public BusinessException(final String message) {\n        super(message);\n    }\n\n    /**\n     * Constructs a new exception with the specified detail message and cause.\n     * <p>\n     * Note that the detail message associated with {@code cause} is <i>not</i> automatically incorporated in this\n     * exception's detail message.\n     *\n     * @param message the detail message (which is saved for later retrieval by the {@link #getMessage()} method).\n     * @param cause   the cause (which is saved for later retrieval by the {@link #getCause()} method). (A <tt>null</tt>\n     *                value is permitted, and indicates that the cause is nonexistent or unknown.)\n     * @since 1.4\n     */\n    public BusinessException(final String message, final Throwable cause) {\n        super(message, cause);\n    }\n\n    /**\n     * Constructs a new exception with the specified cause and a detail message of\n     * <tt>(cause==null ? null : cause.toString())</tt> (which typically contains the class and detail message of\n     * <tt>cause</tt>). This constructor is useful for exceptions that are little more than wrappers for other\n     * throwables (for example, {@link java.security.PrivilegedActionException}).\n     *\n     * @param cause the cause (which is saved for later retrieval by the {@link #getCause()} method). (A <tt>null</tt>\n     *              value is permitted, and indicates that the cause is nonexistent or unknown.)\n     * @since 1.4\n     */\n    public BusinessException(final Throwable cause) {\n        super(cause);\n    }\n\n    /**\n     * Constructs a new exception with the specified detail message, cause, suppression enabled or disabled, and\n     * writable stack trace enabled or disabled.\n     *\n     * @param message            the detail message.\n     * @param cause              the cause. (A {@code null} value is permitted, and indicates that the cause is nonexistent or\n     *                           unknown.)\n     * @param enableSuppression  whether or not suppression is enabled or disabled\n     * @param writableStackTrace whether or not the stack trace should be writable\n     * @since 1.7\n     */\n    protected BusinessException(final String message, final Throwable cause, boolean enableSuppression,\n                                boolean writableStackTrace) {\n        super(message, cause, enableSuppression, writableStackTrace);\n    }\n\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br"),n("span",{staticClass:"line-number"},[s._v("64")]),n("br"),n("span",{staticClass:"line-number"},[s._v("65")]),n("br"),n("span",{staticClass:"line-number"},[s._v("66")]),n("br"),n("span",{staticClass:"line-number"},[s._v("67")]),n("br"),n("span",{staticClass:"line-number"},[s._v("68")]),n("br"),n("span",{staticClass:"line-number"},[s._v("69")]),n("br"),n("span",{staticClass:"line-number"},[s._v("70")]),n("br"),n("span",{staticClass:"line-number"},[s._v("71")]),n("br"),n("span",{staticClass:"line-number"},[s._v("72")]),n("br"),n("span",{staticClass:"line-number"},[s._v("73")]),n("br"),n("span",{staticClass:"line-number"},[s._v("74")]),n("br"),n("span",{staticClass:"line-number"},[s._v("75")]),n("br"),n("span",{staticClass:"line-number"},[s._v("76")]),n("br"),n("span",{staticClass:"line-number"},[s._v("77")]),n("br")])]),n("p",[s._v("异常的处理")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("package tech.pdai.ratelimit.guava.config.exception;\n\n\nimport lombok.extern.slf4j.Slf4j;\nimport org.springframework.web.bind.annotation.ExceptionHandler;\nimport org.springframework.web.bind.annotation.ResponseBody;\nimport org.springframework.web.bind.annotation.RestControllerAdvice;\nimport tech.pdai.ratelimit.guava.config.response.ResponseResult;\nimport tech.pdai.ratelimit.guava.config.response.ResponseStatus;\n\n/**\n * @author pdai\n */\n@Slf4j\n@RestControllerAdvice\npublic class GlobalExceptionHandler {\n\n    /**\n     * handle business exception.\n     *\n     * @param businessException business exception\n     * @return ResponseResult\n     */\n    @ResponseBody\n    @ExceptionHandler(BusinessException.class)\n    public ResponseResult<BusinessException> processBusinessException(BusinessException businessException) {\n        log.error(businessException.getLocalizedMessage());\n        return ResponseResult.fail(null, businessException.getLocalizedMessage()==null\n                ? ResponseStatus.HTTP_STATUS_500.getDescription()\n                :businessException.getLocalizedMessage());\n    }\n\n    /**\n     * handle other exception.\n     *\n     * @param exception exception\n     * @return ResponseResult\n     */\n    @ResponseBody\n    @ExceptionHandler(Exception.class)\n    public ResponseResult<Exception> processException(Exception exception) {\n        log.error(exception.getLocalizedMessage(), exception);\n        return ResponseResult.fail(null, ResponseStatus.HTTP_STATUS_500.getDescription());\n    }\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br")])]),n("h3",{attrs:{id:"统一结果返回封装"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#统一结果返回封装"}},[s._v("#")]),s._v(" 统一结果返回封装")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("package tech.pdai.ratelimit.guava.config.response;\n\nimport java.io.Serializable;\n\nimport lombok.AllArgsConstructor;\nimport lombok.Builder;\nimport lombok.Data;\nimport lombok.NoArgsConstructor;\n\n@NoArgsConstructor\n@AllArgsConstructor\n@Data\n@Builder\npublic class ResponseResult<T> {\n\n    /**\n     * response timestamp.\n     */\n    private long timestamp;\n\n    /**\n     * response code, 200 -> OK.\n     */\n    private String status;\n\n    /**\n     * response message.\n     */\n    private String message;\n\n    /**\n     * response data.\n     */\n    private T data;\n\n    /**\n     * response success result wrapper.\n     *\n     * @param <T> type of data class\n     * @return response result\n     */\n    public static <T> ResponseResult<T> success() {\n        return success(null);\n    }\n\n    /**\n     * response success result wrapper.\n     *\n     * @param data response data\n     * @param <T>  type of data class\n     * @return response result\n     */\n    public static <T> ResponseResult<T> success(T data) {\n        return ResponseResult.<T>builder().data(data)\n                .message(ResponseStatus.SUCCESS.getDescription())\n                .status(ResponseStatus.SUCCESS.getResponseCode())\n                .timestamp(System.currentTimeMillis())\n                .build();\n    }\n\n    /**\n     * response error result wrapper.\n     *\n     * @param message error message\n     * @param <T>     type of data class\n     * @return response result\n     */\n    public static <T extends Serializable> ResponseResult<T> fail(String message) {\n        return fail(null, message);\n    }\n\n    /**\n     * response error result wrapper.\n     *\n     * @param data    response data\n     * @param message error message\n     * @param <T>     type of data class\n     * @return response result\n     */\n    public static <T> ResponseResult<T> fail(T data, String message) {\n        return ResponseResult.<T>builder().data(data)\n                .message(message)\n                .status(ResponseStatus.FAIL.getResponseCode())\n                .timestamp(System.currentTimeMillis())\n                .build();\n    }\n\n\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br"),n("span",{staticClass:"line-number"},[s._v("64")]),n("br"),n("span",{staticClass:"line-number"},[s._v("65")]),n("br"),n("span",{staticClass:"line-number"},[s._v("66")]),n("br"),n("span",{staticClass:"line-number"},[s._v("67")]),n("br"),n("span",{staticClass:"line-number"},[s._v("68")]),n("br"),n("span",{staticClass:"line-number"},[s._v("69")]),n("br"),n("span",{staticClass:"line-number"},[s._v("70")]),n("br"),n("span",{staticClass:"line-number"},[s._v("71")]),n("br"),n("span",{staticClass:"line-number"},[s._v("72")]),n("br"),n("span",{staticClass:"line-number"},[s._v("73")]),n("br"),n("span",{staticClass:"line-number"},[s._v("74")]),n("br"),n("span",{staticClass:"line-number"},[s._v("75")]),n("br"),n("span",{staticClass:"line-number"},[s._v("76")]),n("br"),n("span",{staticClass:"line-number"},[s._v("77")]),n("br"),n("span",{staticClass:"line-number"},[s._v("78")]),n("br"),n("span",{staticClass:"line-number"},[s._v("79")]),n("br"),n("span",{staticClass:"line-number"},[s._v("80")]),n("br"),n("span",{staticClass:"line-number"},[s._v("81")]),n("br"),n("span",{staticClass:"line-number"},[s._v("82")]),n("br"),n("span",{staticClass:"line-number"},[s._v("83")]),n("br"),n("span",{staticClass:"line-number"},[s._v("84")]),n("br"),n("span",{staticClass:"line-number"},[s._v("85")]),n("br"),n("span",{staticClass:"line-number"},[s._v("86")]),n("br"),n("span",{staticClass:"line-number"},[s._v("87")]),n("br"),n("span",{staticClass:"line-number"},[s._v("88")]),n("br"),n("span",{staticClass:"line-number"},[s._v("89")]),n("br")])]),n("h3",{attrs:{id:"controller接口"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#controller接口"}},[s._v("#")]),s._v(" controller接口")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('package tech.pdai.ratelimit.guava.controller;\n\nimport lombok.extern.slf4j.Slf4j;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.RestController;\nimport tech.pdai.ratelimit.guava.config.ratelimit.RateLimit;\nimport tech.pdai.ratelimit.guava.config.response.ResponseResult;\n\n/**\n * @author pdai\n */\n@Slf4j\n@RestController\npublic class RateLimitTestController {\n\n    @RateLimit\n    @GetMapping("/limit")\n    public ResponseResult<String> limit() {\n        log.info("limit");\n        return ResponseResult.success();\n    }\n\n    @RateLimit(limit = 5)\n    @GetMapping("/limit1")\n    public ResponseResult<String> limit1() {\n        log.info("limit1");\n        return ResponseResult.success();\n    }\n\n    @GetMapping("/nolimit")\n    public ResponseResult<String> noRateLimiter() {\n        log.info("no limit");\n        return ResponseResult.success();\n    }\n\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br")])]),n("h3",{attrs:{id:"接口测试"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#接口测试"}},[s._v("#")]),s._v(" 接口测试")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('@SneakyThrows\npublic static void test(int clientSize) {\n    CountDownLatch downLatch = new CountDownLatch(clientSize);\n    ExecutorService fixedThreadPool = Executors.newFixedThreadPool(clientSize);\n    IntStream.range(0, clientSize).forEach(i ->\n            fixedThreadPool.submit(() -> {\n                RestTemplate restTemplate = new RestTemplate();\n                restTemplate.getForObject("http://localhost:8080/limit1", ResponseResult.class);\n                downLatch.countDown();\n            })\n    );\n    downLatch.await();\n    fixedThreadPool.shutdown();\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("p",[s._v("测试结果")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("2021-10-01 15:22:47.171  INFO 30092 --- [nio-8080-exec-4] t.p.r.g.c.RateLimitTestController        : limit1\n2021-10-01 15:22:47.171  INFO 30092 --- [nio-8080-exec-8] t.p.r.g.c.RateLimitTestController        : limit1\n2021-10-01 15:22:47.171  INFO 30092 --- [nio-8080-exec-5] t.p.r.g.c.RateLimitTestController        : limit1\n2021-10-01 15:22:47.187  INFO 30092 --- [nio-8080-exec-9] t.p.r.g.c.RateLimitTestController        : limit1\n2021-10-01 15:22:47.187  INFO 30092 --- [nio-8080-exec-2] t.p.r.g.c.RateLimitTestController        : limit1\n2021-10-01 15:22:47.187  INFO 30092 --- [io-8080-exec-10] t.p.r.g.c.RateLimitTestController        : limit1\n2021-10-01 15:22:47.202 ERROR 30092 --- [nio-8080-exec-7] t.p.r.g.c.e.GlobalExceptionHandler       : too many requests, please try again later...\n2021-10-01 15:22:47.202 ERROR 30092 --- [nio-8080-exec-6] t.p.r.g.c.e.GlobalExceptionHandler       : too many requests, please try again later...\n2021-10-01 15:22:47.221 ERROR 30092 --- [nio-8080-exec-1] t.p.r.g.c.e.GlobalExceptionHandler       : too many requests, please try again later...\n2021-10-01 15:22:47.222 ERROR 30092 --- [nio-8080-exec-5] t.p.r.g.c.e.GlobalExceptionHandler       : too many requests, please try again later...\n2021-10-01 15:22:47.225 ERROR 30092 --- [nio-8080-exec-6] t.p.r.g.c.e.GlobalExceptionHandler       : too many requests, please try again later...\n2021-10-01 15:22:47.225 ERROR 30092 --- [nio-8080-exec-8] t.p.r.g.c.e.GlobalExceptionHandler       : too many requests, please try again later...\n2021-10-01 15:22:47.225 ERROR 30092 --- [nio-8080-exec-3] t.p.r.g.c.e.GlobalExceptionHandler       : too many requests, please try again later...\n2021-10-01 15:22:47.225 ERROR 30092 --- [io-8080-exec-12] t.p.r.g.c.e.GlobalExceptionHandler       : too many requests, please try again later...\n2021-10-01 15:22:47.225 ERROR 30092 --- [io-8080-exec-14] t.p.r.g.c.e.GlobalExceptionHandler       : too many requests, please try again later...\n2021-10-01 15:22:47.225 ERROR 30092 --- [io-8080-exec-13] t.p.r.g.c.e.GlobalExceptionHandler       : too many requests, please try again later...\n2021-10-01 15:22:47.225 ERROR 30092 --- [io-8080-exec-15] t.p.r.g.c.e.GlobalExceptionHandler       : too many requests, please try again later...\n2021-10-01 15:22:47.240 ERROR 30092 --- [io-8080-exec-11] t.p.r.g.c.e.GlobalExceptionHandler       : too many requests, please try again later...\n2021-10-01 15:22:47.240 ERROR 30092 --- [nio-8080-exec-4] t.p.r.g.c.e.GlobalExceptionHandler       : too many requests, please try again later...\n2021-10-01 15:22:47.256 ERROR 30092 --- [nio-8080-exec-2] t.p.r.g.c.e.GlobalExceptionHandler       : too many requests, please try again later...\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br")])]),n("h3",{attrs:{id:"上述实现方案的槽点"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#上述实现方案的槽点"}},[s._v("#")]),s._v(" 上述实现方案的槽点")]),s._v(" "),n("p",[s._v("注意")]),s._v(" "),n("p",[s._v("必须要说明一下，"),n("strong",[s._v("上述实现方式只是单实例下一种思路而已")]),s._v("，如果细细的看，上面的代码存在一些槽点。")]),s._v(" "),n("ol",[n("li",[s._v("首先, "),n("code",[s._v("EXISTED_RATE_LIMITERS.computeIfAbsent(method.getName(), k -> RateLimiter.create(annotation.limit()))")]),s._v(" 这行代码中 "),n("code",[s._v("method.getName()")]),s._v("表明是对方法名进行限流的，其实并不合适，应该需要至少加上类名；")]),s._v(" "),n("li",[s._v("其次, 如果首次运行时访问的请求是一次性涌入的，即EXISTED_RATE_LIMITERS还是空的时候并发请求@RateLimit接口，那么RateLimiter.create(annotation.limit())是会重复创建并加入到EXISTED_RATE_LIMITERS的，这是明显的bug；")]),s._v(" "),n("li",[s._v("再者, 上述实现方式按照方法名去限定请求量，对于很多情况下至少需要支持按照IP和方法名，或者其它自定义的方式进行限流。")]),s._v(" "),n("li",[s._v("其它一些场景支持的参数抽象和封装等")])]),s._v(" "),n("h1",{attrs:{id:"示例源码"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#示例源码"}},[s._v("#")]),s._v(" 示例源码")]),s._v(" "),n("hr"),s._v(" "),n("p",[s._v("https://github.com/realpdai/tech-pdai-spring-demos")])])}),[],!1,null,null,null);n.default=t.exports}}]);